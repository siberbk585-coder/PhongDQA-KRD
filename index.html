<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>H·ªá th·ªëng Phi·∫øu Y√™u C·∫ßu DQA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': '#3b82f6',
            'sidebar': '#0f172a',
            'sidebar-hover': '#1e293b',
            'muted': '#f8fafc',
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .spinner {
      border: 2px solid #e5e7eb;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }

    /* Header and section styling to match index.html */
    .header-container {
      background: linear-gradient(135deg, #2563eb 0%, #60a5fa 100%);
      position: relative;
      overflow: hidden;
    }
    .header-container::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");
      opacity: 0.4;
    }
    .header-badge {
      background-color: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    .header-line { width: 60px; height: 4px; background: linear-gradient(90deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.2) 100%); border-radius: 2px; }

    .form-section { border: 1px solid #e5e7eb; border-radius: 12px; transition: box-shadow 0.2s ease; }
    .form-section:hover { box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06); }

    .submit-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1), 0 1px 3px rgba(37, 99, 235, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease, filter 0.2s ease;
      border-radius: 9999px;
      position: relative;
    }
    .submit-btn:hover { transform: translateY(-1px); box-shadow: 0 7px 14px rgba(37, 99, 235, 0.12), 0 3px 6px rgba(37, 99, 235, 0.08); filter: brightness(1.03); }
    .submit-btn:active { transform: translateY(0); opacity: 0.95; }
    /* Section cards for Form 1 */
    .section-card { border: 1px solid transparent; border-radius: 12px; padding: 16px; }
    .section-a { background: #eff6ff; border-color: #bfdbfe; }
    .section-b { background: #ecfdf5; border-color: #a7f3d0; }
    .section-c { background: #fffbeb; border-color: #fde68a; }
    .section-d { background: #faf5ff; border-color: #e9d5ff; }
  </style>
</head>
<body class="bg-muted min-h-screen flex text-gray-800" style="font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'">
<!-- Sidebar -->
  <aside class="w-56 min-h-screen bg-sidebar text-white flex flex-col py-8 px-4 shadow-lg">
    <h1 class="text-xl font-bold tracking-wide pb-6 border-b border-blue-200 mb-4">C·ªïng T√°c V·ª• DQA</h1>
    <nav class="flex flex-col gap-2 mt-2">
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="testRequest">Phi·∫øu Y√™u C·∫ßu Th·ª≠ Nghi·ªám</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="taskTracking">Theo d√µi C√¥ng vi·ªác</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="form4">B·∫£ng k·∫ø ho·∫°ch</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="userGuide">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="feedback">G√≥p √Ω & B√°o l·ªói</button>
      
    </nav>
  </aside>
  <!-- Form Sections -->
  <main class="flex-1 py-12 flex flex-col items-center justify-center min-h-screen overflow-y-auto">
    <div class="header-container relative w-full max-w-5xl rounded-xl overflow-hidden mb-8">
      <div class="relative z-10 p-8 md:p-10">
        <div class="flex items-center space-x-2 mb-3">
          <div class="inline-block header-badge px-3 py-1 rounded-full text-xs font-semibold text-white">Ph√≤ng DQA</div>
          <div class="header-line hidden md:block"></div>
        </div>
        <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold text-white mb-1 tracking-tight">C·ªïng Y√™u C·∫ßu DQA</h2>
        <p class="text-blue-100 text-sm md:text-base">T·ªïng h·ª£p phi·∫øu th·ª≠ nghi·ªám v√† ti·∫øn ƒë·ªô c√¥ng vi·ªác</p>
      </div>
    </div>
    <!-- Test Request Form -->
    <section id="testRequest" class="form-section w-full max-w-4xl bg-white p-8 rounded-lg shadow-md">
      <div class="mb-8">
        <h2 class="text-3xl font-extrabold text-primary-blue tracking-wide mb-1">Phi·∫øu Y√™u C·∫ßu Th·ª≠ Nghi·ªám</h2>
        <div class="h-1 w-16 bg-primary-blue mb-2 rounded"></div>
        <p class="text-base text-gray-500">Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c m·ª•c b·∫Øt bu·ªôc cho s·∫£n ph·∫©m/linh ki·ªán c·∫ßn th·ª≠ nghi·ªám. Bi·ªÉu m·∫´u s·∫Ω t·ª± ƒë·ªông thay ƒë·ªïi theo l·ª±a ch·ªçn c·ªßa b·∫°n.</p>
      </div>
      <form id="testRequestForm" class="space-y-6" autocomplete="off">
        <!-- A. General Information -->
        <div class="section-card section-a">
          <h3 class="text-lg font-semibold text-primary-blue mb-2">A. Th√¥ng tin chung</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <input required id="senderName" name="senderName" type="text" list="senderNameOptions" placeholder="H·ªç t√™n ng∆∞·ªùi g·ª≠i *" class="input-field"/>
              <datalist id="senderNameOptions"></datalist>
            </div>
            <input required name="senderEmail" type="email" placeholder="Email *" class="input-field"/>
            <input name="requestDate" type="datetime-local" class="input-field" readonly id="testRequestDate"/>
            <input type="hidden" name="requestCode" id="requestCode"/>
            <select required name="department" class="input-field">
              <option value="">Ph√≤ng ban y√™u c·∫ßu *</option>
              <option>Mua h√†ng</option><option>SC</option><option>SC2</option><option>KTSX</option><option>KTSP</option>
              <option>TKCK</option><option>KTCN</option><option>NCTN</option><option>TKƒêT</option>
              <option>QA/QC nh√† m√°y</option><option>DQA</option>
            </select>
          </div>
        </div>
        <!-- B. Product/Component Information -->
        <div class="section-card section-b">
          <h3 class="text-lg font-semibold text-primary-blue mb-2">B. Th√¥ng tin s·∫£n ph·∫©m/linh ki·ªán</h3>
          <!-- Image reading button -->
          <div class="mb-4 flex items-center gap-2 hidden">
            <button type="button" id="readImageBtn" class="px-4 py-2 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 hover:bg-green-100 transition font-medium flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              ƒê·ªçc th√¥ng tin t·ª´ h√¨nh ·∫£nh
            </button>
            <div id="imageReadingStatus" class="hidden flex items-center gap-2 text-sm text-blue-600">
              <span class="spinner"></span>
              <span>ƒêang ƒë·ªçc ·∫£nh...</span>
            </div>
            <div id="imageReadingResult" class="hidden text-sm"></div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input required id="productName" name="productName" type="text" placeholder="T√™n s·∫£n ph·∫©m/linh ki·ªán *" class="input-field"/>
            <input required name="productCode" type="text" placeholder="M√£ s·∫£n ph·∫©m/linh ki·ªán *" class="input-field"/>
            <div class="md:col-span-2">
              <input required name="componentType" id="componentType" list="componentTypeOptions" type="text" placeholder="Lo·∫°i linh ki·ªán *" class="input-field"/>
              <datalist id="componentTypeOptions"></datalist>
              <div class="text-xs text-gray-500 mt-1">N·∫øu linh ki·ªán kh√¥ng c√≥ trong danh s√°ch s·∫Ω t·ª± ƒë·ªông nh·∫≠p: "Linh ki·ªán kh√°c"</div>
              <div class="mt-2">
                <button type="button" id="componentModalBtn" class="px-3 py-2 rounded-lg border border-blue-300 bg-white text-blue-700 hover:bg-blue-50 transition">Ch·ªçn t·ª´ danh s√°ch</button>
              </div>
              <input type="hidden" name="componentStandard" id="componentStandard" />
              <div id="componentStandardNote" class="text-sm text-gray-600 mt-1 hidden"></div>
            </div>
            <input name="sampleSubmissionNo" id="sampleSubmissionNo" type="number" min="1" placeholder="L·∫ßn g·ª≠i m·∫´u " class="input-field hidden"/>
            <div id="testRequestChangeNote" class="hidden md:col-span-2">
              <input type="text" name="changeFromLastNote" placeholder="M√¥ t·∫£ thay ƒë·ªïi so v·ªõi l·∫ßn tr∆∞·ªõc" class="input-field"/>
            </div>
            <select required name="requestPurpose" id="requestPurpose" class="input-field md:col-span-2">
              <option value="">M·ª•c ƒë√≠ch y√™u c·∫ßu *</option>
              <option value="ƒê√°nh gi√° SP m·ªõi">ƒê√°nh gi√° S·∫£n ph·∫©m m·ªõi- Giai ƒëo·∫°n EV</option>
              <option value="ƒê√°nh gi√° SP m·ªõi">ƒê√°nh gi√° S·∫£n ph·∫©m m·ªõi- Giai ƒëo·∫°n DV</option>
              <option value="ƒê√°nh gi√° S·∫£n ph·∫©m SOP">ƒê√°nh gi√° linh ki·ªán,s·∫£n ph·∫©m SOP/Base </option>
            </select>
            <div id="purposeDescription" class="text-gray-600 text-sm md:col-span-2"></div>
            <div id="projectCodeContainer" class="hidden md:col-span-2">
              <input type="text" id="projectCode" name="projectCode" class="input-field" placeholder="M√£ d·ª± √°n" disabled />
            </div>
            <div id="nccChangeFields" class="hidden md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
              <input type="text" id="altCode" name="altCode" class="input-field" placeholder="M√£ t∆∞∆°ng t·ª±/thay th·∫ø *" disabled />
              <input type="text" id="appliedModel" name="appliedModel" class="input-field" placeholder="Model √°p d·ª•ng *" disabled />
            </div>
            <input name="supplier" required type="text" placeholder="Nh√† cung c·∫•p *" class="input-field"/>
            <input name="numSamples" type="number" min="0" placeholder="S·ªë l∆∞·ª£ng m·∫´u giao *" required class="input-field"/>
            <input id="desiredCompletionDate" name="desiredCompletionDate" type="text" placeholder="H·∫°n mong mu·ªën" required class="input-field"/>
            <input type="hidden" name="desiredCompletionDateTime" id="desiredCompletionDateTime" />
            <select name="personReceived" required class="input-field">
              <option value="">ƒê·∫ßu m·ªëi nh·∫≠n m·∫´u *</option>
              <option>V≈© Duy Minh</option>
              <option>Nguy·ªÖn VƒÉn Linh</option>
              <option>Nguy·ªÖn VƒÉn Hi·∫øu</option>
              <option>ƒê√†o Ho√†ng D∆∞∆°ng</option>
            </select>
            <textarea name="notes" rows="2" placeholder="Ghi ch√∫ (ƒêi·ªÉm thay ƒë·ªïi, l√Ω do y√™u c·∫ßu g·∫•p...)" class="input-field md:col-span-2"></textarea>
          </div>
        </div>
        <!-- C. Required Testing Information -->
        <div class="section-card section-c">
          <h3 class="text-lg font-semibold text-primary-blue mb-2">C. Th√¥ng tin th·ª≠ nghi·ªám y√™u c·∫ßu</h3>
          <div class="flex items-center gap-8 pb-2">
            <label class="flex items-center"><input type="radio" class="mr-2" name="testType" value="standard" checked>Ki·ªÉm tra m·∫∑c ƒë·ªãnh theo ti√™u chu·∫©n k·ªπ thu·∫≠t</label>
            <label class="flex items-center"><input type="radio" class="mr-2" name="testType" value="special">Ki·ªÉm tra ƒë·∫∑c bi·ªát theo y√™u c·∫ßu</label>
          </div>
          <div id="specialTestFields" class="hidden pb-2 border border-primary-blue rounded p-4 bg-blue-50">
            <label for="specialRequestDesc" class="block text-sm text-gray-700 mb-2">M√¥ t·∫£ ki·ªÉm tra ƒë·∫∑c bi·ªát <span class="text-red-600">*</span></label>
            <input type="text" id="specialRequestDesc" name="specialRequestDesc" class="input-field" placeholder="M√¥ t·∫£ chi ti·∫øt h·∫°ng m·ª•c ki·ªÉm tra, ti√™u chu·∫©n √°p d·ª•ng..." required disabled />
          </div>
        </div>
        <!-- D. Attachments -->
        <div class="section-card section-d">
          <h3 class="text-lg font-semibold text-primary-blue mb-2">D. T√†i li·ªáu ƒë√≠nh k√®m</h3>
          <div id="fileUploadArea" class="relative border-2 border-dashed border-blue-300 rounded-lg p-8 text-center transition-all duration-300 hover:border-blue-400 hover:bg-blue-50 cursor-pointer">
            <div id="uploadContent" class="space-y-4">
              <div class="mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
              </div>
              <div>
                <p class="text-lg font-medium text-gray-700">K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c <span class="text-blue-600 underline">nh·∫•n ƒë·ªÉ ch·ªçn</span></p>
                <p class="text-sm text-gray-500 mt-1">H·ªó tr·ª£: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG (t·ªëi ƒëa 20MB m·ªói file)</p>
              </div>
            </div>
            <input type="file" id="testRequestFiles" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
          </div>
          <div id="uploadProgress" class="hidden mt-4 p-4 bg-blue-50 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-blue-700">ƒêang t·∫£i l√™n...</span>
              <span id="uploadPercent" class="text-sm text-blue-600">0%</span>
            </div>
            <div class="w-full bg-blue-200 rounded-full h-2">
              <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
          <div id="testRequestUploadList" class="mt-4 space-y-3"></div>
          <p class="mt-4 text-xs text-gray-500">
            <span class="inline-block w-2 h-2 bg-blue-400 rounded-full mr-2"></span>
            B·∫°n c√≥ th·ªÉ ch·ªçn ho·∫∑c k√©o th·∫£ nhi·ªÅu file. C√°c file s·∫Ω ƒë∆∞·ª£c t·∫£i l√™n khi nh·∫•n g·ª≠i. <br>
            T√πy v√†o k√≠ch th∆∞·ªõc file ƒë√≠nh k√®m m√† vi·ªác t·∫£i l√™n c√≥ th·ªÉ m·∫•t th·ªùi gian. Xin vui l√≤ng ch·ªù.
          </p>
        </div>
        <!-- Keep data after submit -->
        <label class="mt-3 flex items-center text-sm text-gray-600 hidden">
          <input type="checkbox" id="keepDataAfterSubmit" class="mr-2">
          Gi·ªØ d·ªØ li·ªáu sau khi g·ª≠i. (D·ªØ li·ªáu ƒë√£ nh·∫≠p s·∫Ω kh√¥ng b·ªã x√≥a sau khi nh·∫•n g·ª≠i)<br> L∆∞u √Ω!: kh√¥ng nh·∫≠p 2 t√°c v·ª• c√≥ d·ªØ li·ªáu ho√†n to√†n gi·ªëng nhau trong c√πng 1 ng√†y.
        </label>
        <button type="submit" class="submit-btn w-full mt-4 py-3 text-white font-semibold text-lg transition flex items-center justify-center gap-2">
          <span>G·ª≠i y√™u c·∫ßu</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        </button>
      </form>
    </section>
    <!-- Feedback & Bug Report Section -->
    <section id="feedback" class="form-section w-full max-w-4xl bg-white p-8 rounded-lg shadow-md hidden">
      <div class="mb-6">
        <h2 class="text-3xl font-extrabold text-primary-blue tracking-wide mb-1">G√≥p √Ω & B√°o l·ªói</h2>
        <div class="h-1 w-16 bg-primary-blue mb-2 rounded"></div>
        <p class="text-base text-gray-500">H√£y cho ch√∫ng t√¥i bi·∫øt g√≥p √Ω ho·∫∑c v·∫•n ƒë·ªÅ b·∫°n g·∫∑p ph·∫£i.</p>
      </div>
      <form id="feedbackForm" class="space-y-4" autocomplete="off">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input id="feedbackDate" name="fbDate" type="datetime-local" class="input-field" readonly />
          <input name="fbEmail" type="email" placeholder="Email (kh√¥ng b·∫Øt bu·ªôc)" class="input-field" />
        </div>
        <textarea name="fbContent" rows="4" required placeholder="M√¥ t·∫£ chi ti·∫øt v·∫•n ƒë·ªÅ/g√≥p √Ω *" class="input-field"></textarea>
        <div>
          <label class="block text-sm text-gray-700 mb-1">File ƒë√≠nh k√®m (t√πy ch·ªçn)</label>
          <input type="file" id="feedbackFiles" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" class="block w-full text-sm text-gray-700" />
          <div id="feedbackUploadList" class="mt-2 text-sm text-gray-600"></div>
        </div>
        <div class="flex justify-end">
          <button type="submit" class="submit-btn px-8 py-3 rounded-lg text-white font-semibold transition text-base">G·ª≠i g√≥p √Ω/b√°o l·ªói</button>
        </div>
      </form>
      <div class="mt-8">
        <div class="flex items-center gap-3 mb-3">
          <label class="text-sm text-gray-700">Email</label>
          <input id="fbTrackEmail" type="email" class="input-field h-10 w-64" placeholder="Nh·∫≠p email ƒë·ªÉ tra c·ª©u"/>
          <button id="fbTrackBtn" type="button" class="px-3 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50">T√¨m ticket</button>
        </div>
        <div class="overflow-x-auto shadow-lg rounded-lg border border-gray-200">
          <table id="feedbackTable" class="min-w-full text-sm border-collapse">
            <thead>
              <tr class="bg-gradient-to-r from-primary-blue to-blue-600 text-white">
                <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">M√£ ticket</th>
                <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">Ng√†y g·ª≠i</th>
                <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">Email</th>
                <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">N·ªôi dung</th>
                <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">Tr·∫°ng th√°i</th>
                <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">File</th>
              </tr>
            </thead>
            <tbody id="feedbackTableBody" class="bg-white text-gray-900 divide-y divide-gray-200">
              <tr><td colspan="6" class="px-6 py-8 text-center text-gray-500 text-base">Nh·∫≠p email v√† nh·∫•n T√¨m ticket.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <!-- Task Tracking -->
    <section id="taskTracking" class="form-section w-full max-w-7xl bg-white p-8 rounded-lg shadow-md hidden">
      <div class="mb-8">
        <h2 class="text-3xl font-extrabold text-primary-blue tracking-wide mb-1">Theo d√µi C√¥ng vi·ªác</h2>
        <div class="h-1 w-16 bg-primary-blue mb-2 rounded"></div>
        <p class="text-base text-gray-500">Theo d√µi c√°c c√¥ng vi·ªác ƒë√£ g·ª≠i k√®m tr·∫°ng th√°i v√† th·ªùi h·∫°n ƒë√°p ·ª©ng.</p>
      </div>
      <form id="taskTrackingForm" class="mb-8 space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Email ng∆∞·ªùi g·ª≠i</label>
            <input name="senderEmail" type="email" placeholder="Nh·∫≠p email ng∆∞·ªùi g·ª≠i" class="input-field h-12"/>
          </div>
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Ph√≤ng ban y√™u c·∫ßu</label>
            <select name="department" class="input-field h-12">
              <option value="">Ch·ªçn ph√≤ng ban</option>
               <option>Mua h√†ng</option><option>SC</option><option>SC2</option><option>KTSX</option><option>KTSP</option>
              <option>TKCK</option><option>KTCN</option><option>NCTN</option><option>TKƒêT</option>
              <option>QA/QC nh√† m√°y</option>
            </select>
          </div>
        </div>
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm text-blue-700">
                <span class="font-medium">L∆∞u √Ω:</span> Ph·∫£i nh·∫≠p √≠t nh·∫•t m·ªôt trong hai tr∆∞·ªùng tr√™n ƒë·ªÉ t√¨m ki·∫øm.
              </p>
            </div>
          </div>
        </div>
        <!-- Response field mapping params (backend can use these to shape response) -->
        <div class="hidden">
          <input type="hidden" name="resp_ngay_gui" value="submissionDate" />
          <input type="hidden" name="resp_ten_cong_viec" value="task-name" />
          <input type="hidden" name="resp_han_mong_muon" value="desiredDueDate" />
          <input type="hidden" name="resp_ngay_hoan_thanh" value="completionDate" />
          <input type="hidden" name="resp_phu_trach" value="pic" />
          <input type="hidden" name="resp_trang_thai" value="status" />
          <input type="hidden" name="resp_nguoi_giao_viec" value="assigner" />
          <input type="hidden" name="resp_ma_bao_cao" value="reportCode" />
        </div>
        <div class="flex justify-end">
          <button id="taskTrackingSearchBtn" type="submit" class="submit-btn px-8 py-3 rounded-lg text-white font-semibold transition text-base">üîç T√¨m ki·∫øm</button>
        </div>
      </form>
      <div class="flex items-center gap-3 mb-3">
        <label class="text-sm text-gray-700">Th√°ng</label>
        <input id="tt-month" type="month" class="input-field h-10 w-48"/>
        <button id="tt-filter-off" type="button" class="px-3 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50">T·∫Øt b·ªô l·ªçc</button>
      </div>
      <div class="overflow-x-auto shadow-lg rounded-lg border border-gray-200">
        <table id="trackingTable" class="min-w-full text-sm border-collapse">
          <thead>
            <tr class="bg-gradient-to-r from-primary-blue to-blue-600 text-white">
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">Ng∆∞·ªùi y√™u c·∫ßu</th>
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">Ng√†y g·ª≠i</th>
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">H·∫°n mong mu·ªën</th>
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">H·∫°n ƒë√°p ·ª©ng</th>
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">T√™n c√¥ng vi·ªác</th>
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">Ph·ª• tr√°ch</th>
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">Tr·∫°ng th√°i</th>
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">M√£ b√°o c√°o</th>
            </tr>
          </thead>
          <tbody id="trackingTableBody" class="bg-white text-gray-900 divide-y divide-gray-200">
            <tr><td colspan="8" class="px-6 py-8 text-center text-gray-500 text-base">Nh·∫•n T√¨m ki·∫øm ƒë·ªÉ t·∫£i tr·∫°ng th√°i c√¥ng vi·ªác.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
    <!-- Form 4 ¬∑ K·∫ø ho·∫°ch c√¥ng vi·ªác -->
    <section id="form4" class="form-section w-full max-w-none bg-white p-8 rounded-lg shadow-md hidden">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-3xl font-extrabold text-primary-blue tracking-wide mb-1">B·∫£ng k·∫ø ho·∫°ch</h2>
          <div class="h-1 w-16 bg-primary-blue mb-2 rounded"></div>
          <p class="text-base text-gray-500">Theo d√µi ph√¢n b·ªï c√¥ng vi·ªác v√† ti·∫øn ƒë·ªô th·ª±c hi·ªán theo t·ª´ng nh√¢n s·ª±.</p>
        </div>
        <div class="flex items-center gap-3">
          <select
            id="f4-assigneeFilter"
            class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-blue-200"
          >
            <option value="all">T·∫•t c·∫£ nh√¢n s·ª±</option>
          </select>
          <button
            id="f4-reloadButton"
            class="inline-flex items-center gap-2 rounded-lg bg-primary-blue px-4 py-1.5 text-sm font-medium text-white hover:bg-blue-600 transition"
            type="button"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            T·∫£i l·∫°i
          </button>
          <p id="f4-statusText" class="text-xs text-gray-500"></p>
        </div>
      </div>

      <div class="flex h-[calc(100vh-260px)] overflow-hidden border border-gray-200 rounded-lg">
        <!-- Danh s√°ch c√¥ng vi·ªác -->
        <aside class="w-80 bg-white border-r border-gray-200 flex flex-col overflow-hidden">
          <div class="p-4 border-b border-gray-200 bg-gray-50">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-semibold text-gray-700 uppercase">Danh s√°ch c√¥ng vi·ªác</h3>
              <span id="f4-recordCounter" class="text-xs text-gray-500"></span>
            </div>
          </div>
          <div class="flex-1 overflow-y-auto">
            <div id="f4-taskList" class="p-2">
            </div>
          </div>
        </aside>

        <!-- Gantt chart -->
        <section class="flex-1 flex flex-col overflow-hidden bg-white">
          <div class="p-4 border-b border-gray-200 bg-gray-50 flex items-center justify-between">
            <h3 class="text-sm font-semibold text-gray-700 uppercase">Timeline (Gantt Chart)</h3>
            <div id="f4-legend" class="flex flex-wrap gap-2"></div>
          </div>
          <div class="flex-1 overflow-hidden">
            <div id="f4-chartWrapper" class="relative w-full h-full p-4 overflow-auto">
            </div>
          </div>
        </section>
      </div>

      <section id="f4-detailSection" class="hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg max-h-96 overflow-auto">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white z-10">
          <h3 class="text-sm font-semibold text-gray-700 uppercase">Chi ti·∫øt ph√¢n b·ªï c√¥ng vi·ªác</h3>
          <button id="f4-closeDetailBtn" class="text-gray-400 hover:text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr class="text-left text-xs font-semibold uppercase tracking-wider text-gray-700">
                <th class="px-4 py-3">STT</th>
                <th class="px-4 py-3">Ng∆∞·ªùi ph·ª• tr√°ch</th>
                <th class="px-4 py-3">B·∫Øt ƒë·∫ßu</th>
                <th class="px-4 py-3">Ho√†n th√†nh</th>
                <th class="px-4 py-3 text-right">Gi·ªù c√¥ng</th>
              </tr>
            </thead>
            <tbody id="f4-scheduleTable" class="divide-y divide-gray-100 bg-white text-sm"></tbody>
          </table>
        </div>
      </section>
    </section>
    <!-- User Guide -->
    <section id="userGuide" class="form-section w-full max-w-5xl bg-white p-8 rounded-lg shadow-md hidden">
      <div class="mb-6 flex items-center justify-between">
        <div>
          <h2 class="text-3xl font-extrabold text-primary-blue tracking-wide mb-1">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h2>
          <div class="h-1 w-16 bg-primary-blue mb-2 rounded"></div>
          <p class="text-base text-gray-500">Xem nhanh t√†i li·ªáu h∆∞·ªõng d·∫´n ngay b√™n d∆∞·ªõi ho·∫∑c m·ªü trong tab m·ªõi.</p>
        </div>
        <a href="https://docs.google.com/document/d/1eRC2z16alLpVfA8NYjD6teGWF94dwpnM/edit?usp=sharing&ouid=101589232360066908244&rtpof=true&sd=true" target="_blank" rel="noopener" class="submit-btn inline-flex items-center justify-center px-5 py-2 text-white font-semibold rounded-lg">M·ªü b·∫£n ƒë·∫ßy ƒë·ªß (hi·ªán ƒë·ªÅ m·ª•c/th·∫ª)</a>
      </div>
      <div class="rounded-lg border border-gray-200 overflow-hidden">
        <iframe src="https://docs.google.com/document/d/1eRC2z16alLpVfA8NYjD6teGWF94dwpnM/preview" class="w-full" style="height: 75vh;" allow="clipboard-write; fullscreen"></iframe>
      </div>
    </section>
    
  </main>
  <!-- Modal ch·ªçn lo·∫°i linh ki·ªán -->
  <div id="componentModal" class="fixed inset-0 z-50 hidden">
    <div id="componentModalOverlay" class="absolute inset-0 bg-black bg-opacity-30"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl bg-white rounded-xl shadow-2xl border border-blue-200 overflow-hidden">
        <div class="px-4 py-3 bg-gradient-to-r from-primary-blue to-blue-600 text-white flex items-center justify-between">
          <h3 class="font-semibold">Ch·ªçn lo·∫°i linh ki·ªán</h3>
          <button type="button" id="componentModalClose" class="px-3 py-1 rounded bg-white/20 hover:bg-white/30">ƒê√≥ng</button>
        </div>
        <div class="p-4 space-y-3">
          <input id="componentSearch" type="text" class="input-field" placeholder="T√¨m theo t√™n lo·∫°i linh ki·ªán..."/>
          <div class="overflow-auto max-h-96 border border-blue-100 rounded-lg">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="bg-blue-50 text-blue-900">
                  <th class="px-4 py-2 text-left">T√™n lo·∫°i linh ki·ªán</th>
                  <th class="px-4 py-2 text-left">C√¥ng chu·∫©n (gi·ªù)</th>
                </tr>
              </thead>
              <tbody id="componentTableBody" class="divide-y divide-gray-100"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal ƒë·ªçc h√¨nh ·∫£nh -->
  <div id="imageReadingModal" class="fixed inset-0 z-50 hidden">
    <div id="imageModalOverlay" class="absolute inset-0 bg-black bg-opacity-30"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-2xl bg-white rounded-xl shadow-2xl border border-green-200 overflow-hidden">
        <div class="px-4 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white flex items-center justify-between">
          <h3 class="font-semibold flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            ƒê·ªçc th√¥ng tin t·ª´ h√¨nh ·∫£nh
          </h3>
          <button type="button" id="imageModalClose" class="px-3 py-1 rounded bg-white/20 hover:bg-white/30">ƒê√≥ng</button>
        </div>
        <div class="p-6 space-y-4">
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
            <input type="file" id="imageFileInput" accept="image/*" class="hidden"/>
            <div id="imageUploadArea" class="cursor-pointer">
              <div class="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
                <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
              </div>
              <p class="text-lg font-medium text-gray-700 mb-2">Ch·ªçn file ho·∫∑c d√°n ·∫£nh</p>
              <p class="text-sm text-gray-500">Nh·∫•n ƒë·ªÉ ch·ªçn file ho·∫∑c s·ª≠ d·ª•ng Ctrl+V ƒë·ªÉ d√°n t·ª´ clipboard</p>
            </div>
            <div id="imagePreviewContainer" class="hidden mt-4">
              <div class="relative inline-block max-w-full">
                <img id="imagePreview" class="max-w-full max-h-96 rounded-lg border-2 border-gray-200" alt="Preview"/>
                <button type="button" id="removeImageBtn" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-2 hover:bg-red-600 transition">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
              <p id="imageFileName" class="text-sm text-gray-600 mt-2"></p>
            </div>
          </div>
          <div class="flex justify-end gap-3 pt-4 border-t">
            <button type="button" id="imageCancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">H·ªßy</button>
            <button type="button" id="imageConfirmBtn" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              X√°c nh·∫≠n v√† ƒë·ªçc
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Common Styles -->
  <style>
    .input-field {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #93c5fd; /* blue-300 */
      border-radius: 0.5rem; /* rounded */
      background-color: #f1f5f9; /* muted */
      transition: box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
      outline: none;
    }
    .input-field:focus {
      border-color: #3b82f6; /* primary-blue */
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* ring-blue-200 */
      background-color: #ffffff;
    }
    .input-field::placeholder {
      color: #9ca3af; /* gray-400 */
    }
    .input-field:read-only {
      background: #e5e7eb; /* gray-200 */
      color: #6b7280; /* gray-500 */
    }
    /* style for input-as-text date field (per reference) */
    .date-text-placeholder::placeholder { color: #6b7280; }
    #fileUploadArea.drag-over {
      border-color: #3b82f6 !important;
      background-color: #eff6ff !important;
      transform: scale(1.02);
    }
    .file-item { transition: all 0.3s ease; }
    .file-item:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
    #progressBar { transition: width 0.3s ease; }
    .file-preview img {
      transition: transform 0.2s ease;
    }
    
    .file-preview:hover img {
      transform: scale(1.05);
    }

    /* Blue submit button (white text) */
    .submit-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1), 0 1px 3px rgba(37, 99, 235, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease, filter 0.2s ease;
      border-radius: 9999px;
      position: relative;
    }
    .submit-btn:hover { transform: translateY(-1px); box-shadow: 0 7px 14px rgba(37, 99, 235, 0.12), 0 3px 6px rgba(37, 99, 235, 0.08); filter: brightness(1.03); }
    .submit-btn:active { transform: translateY(0); opacity: 0.95; }
  </style>
  <!-- JavaScript for dynamic logic/features -->
  <script>
    // Endpoints for Form 1 (Test Request)
    const FORM_SUBMIT_ENDPOINT = "https://iatzhxxuk.tino.page/webhook/Yeucauthunghiem";
    const FILE_UPLOAD_ENDPOINT = FORM_SUBMIT_ENDPOINT;
    const FEEDBACK_SUBMIT_ENDPOINT = "https://iatzhxxuk.tino.page/webhook/21a9aa69-4434-47e1-97fc-b7fb84adb43e";
    const FEEDBACK_LIST_ENDPOINT = "https://iatzhxxuk.tino.page/webhook/925155db-ed53-4a3a-bd4d-1ba8378a545c";
    // Endpoint for Form 4 (B·∫£ng k·∫ø ho·∫°ch)
    const SCHEDULE_DATA_ENDPOINT = "https://iatzhxxuk.tino.page/webhook/Laydulieubangphancong1";
    // Endpoint for Task Tracking - s·ª≠ d·ª•ng webhook ƒë·ªÉ tr√°nh CORS
    // Webhook n√†y s·∫Ω proxy request ƒë·∫øn API v·ªõi token
    const TASK_TRACKING_WEBHOOK = "https://iatzhxxuk.tino.page/webhook/TaskTracking"; // C·∫ßn t·∫°o webhook m·ªõi
    const TASK_TRACKING_API_ENDPOINT = "https://iatzhxxuk.tino.page/api/v2/tables/mnwnhukgbu8zs9o/records";
    const TASK_TRACKING_TOKEN = "TN3D9GE7_3OtqX5C0IFeaUgd3tRr5B-rshJQANAB";
    const TASK_TRACKING_VIEW_ID = "vwjldjrlqod1pyuf";
    const LOCAL_FEEDBACK_KEY = 'DQA_FEEDBACK_V1';
    function __loadFeedback(){ try { return JSON.parse(localStorage.getItem(LOCAL_FEEDBACK_KEY) || '[]'); } catch { return []; } }
    function __saveFeedback(rec){ const cur = __loadFeedback(); cur.push(rec); localStorage.setItem(LOCAL_FEEDBACK_KEY, JSON.stringify(cur)); }
    // Sidebar navigation logic
    const navBtns = document.querySelectorAll('.nav-btn');
    const formSections = document.querySelectorAll('.form-section');
    let form4Initialized = false;
    let form4Reload = null;
    function showSection(id) {
      formSections.forEach(sec => sec.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }
    navBtns.forEach(btn => {
      btn.onclick = () => {
        const target = btn.getAttribute('data-target');
        navBtns.forEach(b => b.classList.remove('bg-primary-blue', 'font-bold'));
        btn.classList.add('bg-primary-blue', 'font-bold');
        showSection(target);
        if (target === 'form4') {
          initForm4();
        }
      };
    });
    // Show first form by default
    navBtns[0].classList.add('bg-primary-blue', 'font-bold');
    showSection(navBtns[0].getAttribute('data-target'));

    // Set default current local date+time for date fields on load
    function setCurrentDateTime(id) {
      const dt = new Date();
      const tzOffsetMs = dt.getTimezoneOffset() * 60000;
      const localISO = new Date(dt.getTime() - tzOffsetMs).toISOString().slice(0, 16);
      const el = document.getElementById(id);
      if (el) el.value = localISO;
    }
    setCurrentDateTime('testRequestDate');
    function setCurrentDateTimeIfEmpty(id) {
      const dt = new Date();
      const tzOffsetMs = dt.getTimezoneOffset() * 60000;
      const localISO = new Date(dt.getTime() - tzOffsetMs).toISOString().slice(0, 16);
      const el = document.getElementById(id);
      if (el && !el.value) el.value = localISO;
    }
    
    // Generate Feedback ticket code, e.g., FB.DDMMYY-XXXXXX
    function generateFeedbackTicketCode(){
      const now = new Date();
      const dd = String(now.getDate()).padStart(2,'0');
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const yy = String(now.getFullYear()).slice(-2);
      const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let rnd = '';
      for (let i=0;i<6;i++) rnd += alphabet[Math.floor(Math.random()*alphabet.length)];
      return `FB.${dd}${mm}${yy}-${rnd}`;
    }
    
    // Desired date constraints and hidden datetime submission
    (function setupDesiredDateField(){
      const input = document.getElementById('desiredCompletionDate');
      const hiddenDateTime = document.getElementById('desiredCompletionDateTime');
      if (!input || !hiddenDateTime) return;
      // Convert to date on focus/click and set range today..+32
      function toYMD(d){
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
      }
      function setRange(el){
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const end = new Date(start); end.setDate(end.getDate() + 32);
        el.min = toYMD(start);
        el.max = toYMD(end);
      }
      function ensureDateMode(){
        if (input.type !== 'date') {
          input.type = 'date';
          setRange(input);
          // Default to today + 7 days at the time of entry if empty
          if (!input.value) {
            const now = new Date();
            const def = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            def.setDate(def.getDate() + 7);
            input.value = toYMD(def);
            try { updateHidden(); } catch(_) {}
          }
          try { if (input.showPicker) input.showPicker(); } catch(_){}
        }
      }
      input.addEventListener('focus', ensureDateMode);
      input.addEventListener('click', ensureDateMode);
      input.addEventListener('blur', ()=>{
        if (!input.value) {
          input.type = 'text';
          input.removeAttribute('min');
          input.removeAttribute('max');
        }
      });
      function updateHidden(){
        if (!input.value) { hiddenDateTime.value = ''; return; }
        const [y,m,d] = input.value.split('-').map(Number);
        if (!y || !m || !d) { hiddenDateTime.value = ''; return; }
        const now = new Date();
        const dt = new Date(y, m-1, d, now.getHours(), now.getMinutes(), now.getSeconds());
        hiddenDateTime.value = dt.toISOString();
      }
      input.addEventListener('change', updateHidden);
      input.addEventListener('input', updateHidden);
      updateHidden();
    })();

    // Feedback form toggle and behavior
    (function setupFeedbackBox(){
      const form = document.getElementById('feedbackForm');
      const filesInput = document.getElementById('feedbackFiles');
      const list = document.getElementById('feedbackUploadList');
      if (!form) return;
      setCurrentDateTimeIfEmpty('feedbackDate');

      filesInput && filesInput.addEventListener('change', ()=>{
        const files = Array.from(filesInput.files||[]);
        if (!files.length) { list.innerHTML = ''; return; }
        list.innerHTML = files.map(f=>`- ${f.name}`).join('<br/>');
      });

      document.getElementById('feedbackForm').onsubmit = async function(e){
        e.preventDefault();
        const btn = this.querySelector("button[type=submit]");
        const original = btn ? btn.innerHTML : '';
        if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner'></span><span style='margin-left:8px'>ƒêang g·ª≠i...</span>"; }

        const data = new FormData(this);
        // Mark as feedback type for backend
        data.append('formType', 'feedback');
        // Generate ticket code and append
        const clientTicketCode = generateFeedbackTicketCode();
        data.append('ticketCode', clientTicketCode);

        const files = Array.from((document.getElementById('feedbackFiles')?.files)||[]);
        files.forEach(f=> data.append('files[]', f, f.name));

        try{
          let resp = await fetch(FEEDBACK_SUBMIT_ENDPOINT, { method: 'POST', body: data });
          if (!resp.ok) throw new Error(await resp.text());
          // Try to get ticket code from server response if provided
          let serverTicketCode = '';
          try {
            const ct = (resp.headers.get('content-type') || '').toLowerCase();
            let payload = null;
            if (ct.includes('application/json')) payload = await resp.json();
            else { try { payload = JSON.parse(await resp.text()); } catch { payload = null; } }
            if (payload && typeof payload === 'object') {
              const lower = Object.keys(payload).reduce((acc,k)=>{ acc[k.toLowerCase()] = payload[k]; return acc; }, {});
              serverTicketCode = lower['code'] || lower['ticketcode'] || lower['ticket'] || lower['id'] || lower['ma'] || '';
            }
          } catch(_) { /* ignore parse errors */ }
          const finalTicketCode = (serverTicketCode || clientTicketCode).toString();
          // L∆∞u local ƒë·ªÉ theo d√µi
          try {
            __saveFeedback({
              code: finalTicketCode,
              date: (document.getElementById('feedbackDate')?.value || '').toString(),
              email: (this.querySelector('input[name="fbEmail"]')?.value || '').toString().trim(),
              content: (this.querySelector('textarea[name="fbContent"]')?.value || '').toString().trim(),
              files: files.map(f=> f.name),
              status: 'ƒê√£ g·ª≠i'
            });
          } catch(_) {}
          if (btn) { btn.innerHTML = `ƒê√£ g·ª≠i: ${finalTicketCode}`; setTimeout(()=>{ btn.innerHTML = original; btn.disabled=false; }, 12000); }
          this.reset();
          setCurrentDateTimeIfEmpty('feedbackDate');
          if (list) list.innerHTML = '';
        }catch(err){
          alert('G·ª≠i g√≥p √Ω th·∫•t b·∫°i: ' + err);
          if (btn) { btn.innerHTML = original; btn.disabled=false; }
        }
      };
    })();

    // Feedback tracking table (local-only fallback)
    (function setupFeedbackTracking(){
      const btn = document.getElementById('fbTrackBtn');
      const emailInput = document.getElementById('fbTrackEmail');
      const bodyEl = document.getElementById('feedbackTableBody');
      if (!btn || !emailInput || !bodyEl) return;
      function toDDMMYYYY(val){
        try {
          const d = new Date(val);
          if (isNaN(d)) return val || '';
          const dd = String(d.getDate()).padStart(2,'0');
          const mm = String(d.getMonth()+1).padStart(2,'0');
          const yyyy = d.getFullYear();
          const hh = String(d.getHours()).padStart(2,'0');
          const mi = String(d.getMinutes()).padStart(2,'0');
          return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
        } catch { return val || ''; }
      }
      function getCI(obj, keys){
        if (!obj) return '';
        const lower = Object.keys(obj).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; }, {});
        for (const k of keys) { const v = lower[k.toLowerCase()]; if (v !== undefined) return v; }
        return '';
      }
      function render(rows){
        if (!rows.length){
          bodyEl.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500 text-base">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
          return;
        }
        bodyEl.innerHTML = rows.map(r=>{
          const fileHtml = (Array.isArray(r.files) && r.files.length) ? r.files.join('<br/>') : '-';
          const status = (r.status||'').toLowerCase().includes('done') ? 'Ho√†n th√†nh' : (r.status||'ƒê√£ g·ª≠i');
          return `
            <tr>
              <td class="px-4 py-2">${r.code||'-'}</td>
              <td class="px-4 py-2">${toDDMMYYYY(r.date||'')}</td>
              <td class="px-4 py-2">${r.email||'-'}</td>
              <td class="px-4 py-2">${(r.content||'').replace(/</g,'&lt;').slice(0,160)}${(r.content||'').length>160?'‚Ä¶':''}</td>
              <td class="px-4 py-2">${status}</td>
              <td class="px-4 py-2">${fileHtml}</td>
            </tr>`;
        }).join('');
      }
      async function fetchFromBackend(email){
        // Try GET with query params first, then fallback to POST JSON
        let resp = null;
        let json = null;
        const params = new URLSearchParams();
        params.append('action', 'list');
        if (email) params.append('email', email);
        params.append('_ts', Date.now().toString());
        try {
          resp = await fetch(`${FEEDBACK_LIST_ENDPOINT}?${params.toString()}`, {
            method: 'GET',
            headers: { 'Accept': 'application/json' }
          });
          if (!resp.ok) throw new Error(await resp.text());
        } catch (err) {
          const payload = { action: 'list', email };
          resp = await fetch(FEEDBACK_LIST_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!resp.ok) throw new Error(await resp.text());
        }
        const ct = (resp.headers.get('content-type') || '').toLowerCase();
        if (ct.includes('application/json')) json = await resp.json();
        else { try { json = JSON.parse(await resp.text()); } catch { json = {}; } }

        // Support multiple shapes:
        // 1) [ {record...}, ... ]
        // 2) { data: [...] } or { rows: [...] }
        // 3) [ [records...], [attachments...] ] with Vietnamese keys
        let records = [];
        let attachments = [];
        if (Array.isArray(json)) {
          if (json.length && Array.isArray(json[0])) {
            records = Array.isArray(json[0]) ? json[0] : [];
            attachments = Array.isArray(json[1]) ? json[1] : [];
          } else {
            records = json;
          }
        } else if (Array.isArray(json?.data)) {
          records = json.data;
        } else if (Array.isArray(json?.rows)) {
          records = json.rows;
        }

        // Build attachment map by ticket code if provided in separate array
        const attMap = new Map();
        attachments.forEach(a => {
          const c = getCI(a, ['M√£ Ticket','m√£ ticket','code','ticketcode','ticket','id','ma']);
          const fileUrl = getCI(a, ['File ƒë√≠nh k√®m','file ƒë√≠nh k√®m','file','url','link']);
          if (!c || !fileUrl) return;
          if (!attMap.has(c)) attMap.set(c, []);
          attMap.get(c).push(fileUrl);
        });

        return records.map(rec=>{
          const code = getCI(rec, ['M√£ Ticket','m√£ ticket','code','ticketcode','ticket','id','ma']);
          const date = getCI(rec, ['Ng√†y nh·∫≠n','ng√†y nh·∫≠n','date','createdat','created_at','fbdate','ngay']);
          const em = getCI(rec, ['Ng∆∞·ªùi g·ª≠i','ng∆∞·ªùi g·ª≠i','email','fbemail']);
          const content = getCI(rec, ['V·∫•n ƒë·ªÉ','V·∫•n ƒë·ªÅ','v·∫•n ƒë·ªÉ','v·∫•n ƒë·ªÅ','content','fbcontent','message','noidung']);
          let files = getCI(rec, ['files','attachments','file','filenames']);
          if (typeof files === 'string') {
            files = files.includes(';') ? files.split(';').map(s=>s.trim()).filter(Boolean) : (files ? [files] : []);
          }
          if (!Array.isArray(files)) files = [];
          // Merge files from attachment map by code
          if (code && attMap.has(code)) {
            files = files.concat(attMap.get(code));
          }
          const status = getCI(rec, ['T√¨nh tr·∫°ng','t√¨nh tr·∫°ng','status','trangthai']);
          return { code, date, email: em, content, files, status };
        });
      }
      btn.addEventListener('click', async ()=>{
        const email = (emailInput.value||'').trim().toLowerCase();
        bodyEl.innerHTML = "<tr><td colspan='6' class='px-4 py-4 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";
        try{
          let rows = await fetchFromBackend(email);
          if (email) rows = rows.filter(r => (r.email||'').toLowerCase() === email);
          rows = rows.slice().sort((a,b)=> (String(b.date||'')).localeCompare(String(a.date||'')));
          if (!rows.length) {
            // Fallback local n·∫øu backend kh√¥ng tr·∫£ d·ªØ li·ªáu
            rows = __loadFeedback();
            if (email) rows = rows.filter(r => (r.email||'').toLowerCase() === email);
          }
          render(rows);
        }catch(err){
          let rows = __loadFeedback();
          if (email) rows = rows.filter(r => (r.email||'').toLowerCase() === email);
          render(rows);
        }
      });
    })();

    // Dynamic fields logic for Test Request Form
    // a. Purpose dropdown description
    const purposeDescriptions = {
      "ƒê√°nh gi√° SP m·ªõi": "S·∫£n ph·∫©m/linh ki·ªán m·ªõi thu·ªôc c√°c d·ª± √°n ph√°t tri·ªÉn KRD, c·∫ßn ki·ªÉm tra tr∆∞·ªõc khi s·∫£n xu·∫•t ƒë·∫°i tr√†.",
      "ƒê√°nh gi√° S·∫£n ph·∫©m SOP": "Li√™n quan ƒë·∫øn s·∫£n ph·∫©m/linh ki·ªán ƒë√£ SOP, c·∫ßn ki·ªÉm tra ch·∫•t l∆∞·ª£ng v√† ƒë·∫£m b·∫£o ph√π h·ª£p v·ªõi ti√™u chu·∫©n k·ªπ thu·∫≠t.",
    };
    document.getElementById('requestPurpose').onchange = (e)=>{
      const val = e.target.value || "";
      const desc = purposeDescriptions[val] || "";
      document.getElementById('purposeDescription').textContent = desc;
      const showNcc = /NCC/i.test(val) || /nh√†\s*cung\s*c·∫•p/i.test(val);
      const container = document.getElementById('nccChangeFields');
      const alt = document.getElementById('altCode');
      const model = document.getElementById('appliedModel');
      if (container && alt && model) {
        container.classList.toggle('hidden', !showNcc);
        alt.disabled = !showNcc; model.disabled = !showNcc;
        alt.required = showNcc;  model.required = showNcc;
      }

      // EV/DV: Hi·ªÉn th·ªã "M√£ d·ª± √°n" v√† auto ch·ªçn "Nguy·ªÖn VƒÉn Hi·∫øu"
      const projContainer = document.getElementById('projectCodeContainer');
      const projInput = document.getElementById('projectCode');
      const selectedText = (e.target.options && e.target.selectedIndex >= 0)
        ? (e.target.options[e.target.selectedIndex].text || '')
        : '';
      const isEvOrDv = /\bEV\b/i.test(selectedText) || /\bDV\b/i.test(selectedText);
      if (projContainer && projInput) {
        projContainer.classList.toggle('hidden', !isEvOrDv);
        projInput.disabled = !isEvOrDv;
        projInput.required = isEvOrDv;
        if (!isEvOrDv) projInput.value = '';
      }
      if (isEvOrDv) {
        const personSel = document.querySelector('select[name="personReceived"]');
        if (personSel) {
          let targetValue = '';
          Array.from(personSel.options).forEach(opt => {
            const t = (opt.text || opt.textContent || '').trim();
            if (t === 'Nguy·ªÖn VƒÉn Hi·∫øu') targetValue = opt.value || t;
          });
          if (targetValue) personSel.value = targetValue;
        }
      }

      // SOP/Base: auto ch·ªçn "Nguy·ªÖn VƒÉn Linh"
      const isSopBase = /SOP/i.test(selectedText) || /Base/i.test(selectedText);
      if (isSopBase && !isEvOrDv) {
        const personSel = document.querySelector('select[name="personReceived"]');
        if (personSel) {
          let targetValue = '';
          Array.from(personSel.options).forEach(opt => {
            const t = (opt.text || opt.textContent || '').trim();
            if (t === 'Nguy·ªÖn VƒÉn Linh') targetValue = opt.value || t;
          });
          if (targetValue) personSel.value = targetValue;
        }
      }
    };
    try { document.getElementById('requestPurpose').dispatchEvent(new Event('change')); } catch(_) {}
    // b. Sample submission number
    document.getElementById('sampleSubmissionNo').oninput = (e)=>{
      const need = Number(e.target.value || 0) >= 2;
      const container = document.getElementById('testRequestChangeNote');
      if (container) container.classList.toggle('hidden', !need);
      const inp = container ? container.querySelector('input[name="changeFromLastNote"]') : null;
      if (inp) inp.required = need;
    };
    try { document.getElementById('sampleSubmissionNo').dispatchEvent(new Event('input')); } catch(_) {}

    // c. Special test toggle: show single required input when selected
    document.querySelectorAll('input[name="testType"]').forEach(radio=>{
      radio.addEventListener('change', updateSpecialFields);
    });
    function updateSpecialFields(){
      const choice = (document.querySelector('input[name="testType"]:checked') || {}).value;
      const container = document.getElementById('specialTestFields');
      const input = document.getElementById('specialRequestDesc');
      const show = choice === 'special';
      if (container) container.classList.toggle('hidden', !show);
      if (input) { input.disabled = !show; input.required = show; }
    }
    updateSpecialFields();

    // d. Component type mapping (suggestions + drag-and-drop + auto-standard)
    (function setupComponentType(){
      const input = document.getElementById('componentType');
      const datalist = document.getElementById('componentTypeOptions');
      const hiddenStd = document.getElementById('componentStandard');
      const note = document.getElementById('componentStandardNote');
      const modalBtn = document.getElementById('componentModalBtn');
      const modal = document.getElementById('componentModal');
      const modalOverlay = document.getElementById('componentModalOverlay');
      const modalClose = document.getElementById('componentModalClose');
      const tableBody = document.getElementById('componentTableBody');
      const searchInput = document.getElementById('componentSearch');
      if (!input || !datalist || !hiddenStd || !note) return;

      // B·ªè dropdown t√πy bi·∫øn ƒë·ªÉ tr√°nh tr√πng v·ªõi modal ch·ªçn

      const COMPONENT_ITEMS = [
        { name: 'BƒÉng d√≠nh x·ªëp', std: 7.7 },
        { name: 'B√¨nh √°p', std: 12.5 },
        { name: 'B√¨nh n√≥ng', std: 16.7 },
        { name: 'Block', std: 19.7 },
        { name: 'B·ªô c·ªëc Hydrogen', std: 14.5 },
        { name: 'B·ªô d√¢y ƒëi·ªán', std: 15.9 },
        { name: 'B·ªô ƒëi·ªán ph√¢n Alkaline', std: 12.1 },
        { name: 'B·ªô k√≠nh vi·ªÅn nh√¥m', std: 12.5 },
        { name: 'B∆°m √°p', std: 15.7 },
        { name: 'B√¥ng', std: 3.7 },
        { name: 'C√¥ng t·∫Øc', std: 8.9 },
        { name: 'C√∫t', std: 9.1 },
        { name: 'D√†n l·∫°nh', std: 13.7 },
        { name: 'D√†n t·∫£n nhi·ªát', std: 18.0 },
        { name: 'D√¢y ƒëi·ªán', std: 12.4 },
        { name: 'D√¢y RO 1/4', std: 16.2 },
        { name: 'D√¢y RO 3/8', std: 15.2 },
        { name: 'D√¢y silicone', std: 8.1 },
        { name: 'D√¢y TDS', std: 14.6 },
        { name: 'ƒê·ªìng sunfat', std: 0.8 },
        { name: 'Flow', std: 11.0 },
        { name: 'GioƒÉng ch·ªâ', std: 3.9 },
        { name: 'H·∫°t CaCO3', std: 12.4 },
        { name: 'H·∫°t Cation', std: 4.2 },
        { name: 'H·∫°t Corosex', std: 10.4 },
        { name: 'H·∫°t h·ªìng ngo·∫°i', std: 9.1 },
        { name: 'H·∫°t ORP', std: 6.6 },
        { name: 'Kh√≥a v√≤i nh·ª±a', std: 8.5 },
        { name: 'L√µi 6HP', std: 15.7 },
        { name: 'L√µi Alkaline', std: 11.7 },
        { name: 'L√µi h·ªìng ngo·∫°i', std: 13.0 },
        { name: 'L√µi hydrogen EZ270', std: 12.3 },
        { name: 'L√µi kho√°ng', std: 11.8 },
        { name: 'L√µi kho√°ng EZ', std: 13.0 },
        { name: 'L√µi l·ªçc s·ªë 1', std: 7.3 },
        { name: 'L√µi l·ªçc s·ªë 2', std: 7.9 },
        { name: 'L√µi l·ªçc s·ªë 3', std: 8.2 },
        { name: 'L√µi OCB', std: 13.5 },
        { name: 'L√µi Post Carbon', std: 22.3 },
        { name: 'L√µi PP', std: 7.1 },
        { name: 'L√µi T33', std: 12.1 },
        { name: 'L√µi than nano', std: 12.1 },
        { name: 'M√†ng cao su', std: 10.0 },
        { name: 'M√†ng RO', std: 12.0 },
        { name: 'M√†ng RO EZ', std: 14.7 },
        { name: 'M·ª°', std: 6.5 },
        { name: 'M·ª±c In', std: 10.5 },
        { name: 'N·∫Øp c·ªëc', std: 4.8 },
        { name: 'Ngu·ªìn xung', std: 12.3 },
        { name: 'Phao ƒëi·ªán t·ª´', std: 10.5 },
        { name: 'Phin l·ªçc', std: 10.2 },
        { name: 'Ph√¥i l√µi PP', std: 7.3 },
        { name: 'R∆° le nhi·ªát l·∫°nh', std: 19.55 },
        { name: 'Tem', std: 6.2 },
        { name: 'Th√¢n c·ªëc', std: 6.5 },
        { name: 'Than ho·∫°t t√≠nh', std: 17.9 },
        { name: 'Th√¢n v·ªè m√†ng', std: 6.5 },
        { name: 'Th√πng s√≥ng AB', std: 10.1 },
        { name: 'Th√πng s√≥ng BC', std: 10.1 },
        { name: 'Th√πng s√≥ng C', std: 10.1 },
        { name: 'T√¥i k√≠nh', std: 9.6 },
        { name: 'T√∫i PE', std: 3.2 },
        { name: 'Van 1 chi·ªÅu', std: 13.6 },
        { name: 'Van 4 c·ª≠a', std: 15.1 },
        { name: 'Van √°p cao', std: 16 },
        { name: 'Van √°p th·∫•p', std: 15.7 },
        { name: 'Van ƒëi·ªán t·ª´', std: 16.9 },
        { name: 'Van kh√≥a', std: 12.4 },
        { name: 'Van x·∫£ b√¨nh √°p', std: 17.4 },
        { name: 'Vi·ªÅn nh√¥m k√≠nh', std: 9 },
        { name: 'V√≤i g·∫°t', std: 12.5 },
        { name: 'V√≤i HCV', std: 8.7 },
        { name: 'X·ªëp', std: 2.5 },
        { name: 'X·ªëp b·∫£o √¥n', std: 2.0 },
        { name: 'M·∫°ch', std: 24.0 },
        { name: 'M√°y l·ªçc n∆∞·ªõc', std: 32.0 },
        { name: 'M√°y l·ªçc n∆∞·ªõc (Ch·ªâ rung l·∫Øc)', std: 6.0 },
        { name: 'M√°y l·ªçc n∆∞·ªõc (Base/r√† so√°t t√†i li·ªáu)', std: 2.0 },
        { name: 'M√°y l·ªçc n∆∞·ªõc (Base/x√∫c ti·∫øn ho√†n thi·ªán)', std: 10.0 },
        { name: 'C√¥ng chu·∫©n 1 ng√†y', std: 8.0 },
        { name: 'C√¥ng chu·∫©n 2 ng√†y', std: 16.0 },
        { name: 'C√¥ng chu·∫©n 3 ng√†y', std: 24.0 },
        { name: 'C√¥ng chu·∫©n 4 ng√†y', std: 32.0 },
        { name: 'C√¥ng chu·∫©n 5 ng√†y', std: 40.0 }
      ];

      // G·ª£i √Ω theo n·ªôi dung nh·∫≠p ·ªü √¥ "Lo·∫°i linh ki·ªán" (kh√¥ng c√≤n ph·ª• thu·ªôc v√†o T√™n s·∫£n ph·∫©m)
      function renderOptions(query){
        const n = normalize(query);
        if (!n) { datalist.innerHTML = ''; return; }
        const items = COMPONENT_ITEMS
          .filter(i => i.name !== 'Linh ki·ªán kh√°c' && (!n || normalize(i.name).includes(n)))
          .sort((a,b)=> a.name.localeCompare(b.name))
          .slice(0,50)
          .map(i=>`<option value="${i.name}"></option>`)
          .join('');
        datalist.innerHTML = items;
      }
      renderOptions('');

      // ƒê√£ lo·∫°i b·ªè renderDropdown/showDropdown/hideDropdown

      function normalize(s){
        return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
      }

      function resolveStandard(raw){
        if (!raw) return { name: '', std: 0 };
        // Exact match first
        const exact = COMPONENT_ITEMS.find(i => i.name === raw);
        if (exact) return exact;
        const n = normalize(raw);
        // Try inclusive match on normalized strings
        let best = { name: raw, std: 0 };
        for (const item of COMPONENT_ITEMS) {
          const ni = normalize(item.name);
          if (n === ni || n.includes(ni) || ni.includes(n)) { best = item; break; }
        }
        return best;
      }

      function updateStandard(){
        const res = resolveStandard(input.value);
        hiddenStd.value = String(res.std || 0);
        note.textContent = '';
      }

      input.addEventListener('input', ()=>{ renderOptions(input.value); updateStandard(); });
      input.addEventListener('change', updateStandard);
      input.addEventListener('blur', ()=>{ updateStandard(); });
      // Kh√¥ng t·ª± m·ªü danh s√°ch khi focus ƒë·ªÉ tr√°nh d∆∞ th·ª´a

      // ƒê√£ b·ªè l·∫Øng nghe click tr√™n dropdown t√πy bi·∫øn

      // Drag-and-drop text support
      ;['dragenter','dragover'].forEach(ev=>{
        input.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); input.classList.add('ring-2','ring-blue-300'); });
      });
      ;['dragleave','drop'].forEach(ev=>{
        input.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); input.classList.remove('ring-2','ring-blue-300'); });
      });
      input.addEventListener('drop', e=>{
        const txt = e.dataTransfer?.getData('text/plain') || '';
        if (txt) {
          input.value = txt.trim();
          updateStandard();
        }
      });

      // Initialize on load
      updateStandard();

      // Expose data for other modules
      window.__resolveComponentStandard = (val)=>resolveStandard(val||'').std || 0;
      window.__componentItems = COMPONENT_ITEMS.slice();

      // ===== Modal listing logic =====
      function openModal(){ if (modal) modal.classList.remove('hidden'); }
      function closeModal(){ if (modal) modal.classList.add('hidden'); }
      function renderTable(filter){
        if (!tableBody) return;
        const n = normalize(filter);
        const rows = COMPONENT_ITEMS
          .filter(i => i.name !== 'Linh ki·ªán kh√°c' && (!n || normalize(i.name).includes(n)))
          .sort((a,b)=> a.name.localeCompare(b.name));
        if (!rows.length){
          tableBody.innerHTML = '<tr><td colspan="2" class="px-4 py-3 text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
          return;
        }
        tableBody.innerHTML = rows.map(i=>`<tr class="hover:bg-blue-50 cursor-pointer">
            <td class="px-4 py-2">${i.name}</td>
            <td class="px-4 py-2">${i.std}</td>
          </tr>`).join('');
      }
      function handleRowClick(e){
        const tr = e.target?.closest('tr');
        if (!tr) return;
        const name = tr.children?.[0]?.textContent?.trim() || '';
        const std = tr.children?.[1]?.textContent?.trim() || '';
        if (name){ input.value = name; hiddenStd.value = std || '0'; try{ input.dispatchEvent(new Event('input')); }catch(_){} }
        closeModal();
      }
      if (tableBody && !tableBody._bound){ tableBody.addEventListener('click', handleRowClick); tableBody._bound = true; }
      if (searchInput && !searchInput._bound){ searchInput.addEventListener('input', ()=> renderTable(searchInput.value||'')); searchInput._bound = true; }
      if (modalBtn && !modalBtn._bound){ modalBtn.addEventListener('click', ()=>{ renderTable(''); openModal(); }); modalBtn._bound = true; }
      if (modalOverlay && !modalOverlay._bound){ modalOverlay.addEventListener('click', closeModal); modalOverlay._bound = true; }
      if (modalClose && !modalClose._bound){ modalClose.addEventListener('click', closeModal); modalClose._bound = true; }
    })();

    // B·ªè li√™n k·∫øt g·ª£i √Ω theo "T√™n s·∫£n ph·∫©m/linh ki·ªán"; g·ª£i √Ω ƒë√£ chuy·ªÉn sang l·∫Øng nghe tr·ª±c ti·∫øp √¥ "Lo·∫°i linh ki·ªán" ·ªü tr√™n

    // ===== Image Reading Functionality =====
    (function setupImageReading(){
      const IMAGE_READING_ENDPOINT = "https://iatzhxxuk.tino.page/webhook/d01f614b-674d-4626-b0b6-53d286264061";
      
      // Modal elements
      const modal = document.getElementById('imageReadingModal');
      const modalOverlay = document.getElementById('imageModalOverlay');
      const modalClose = document.getElementById('imageModalClose');
      const imageCancelBtn = document.getElementById('imageCancelBtn');
      
      // Main button
      const readBtn = document.getElementById('readImageBtn');
      
      // Modal inputs and preview
      const fileInput = document.getElementById('imageFileInput');
      const uploadArea = document.getElementById('imageUploadArea');
      const previewContainer = document.getElementById('imagePreviewContainer');
      const imagePreview = document.getElementById('imagePreview');
      const imageFileName = document.getElementById('imageFileName');
      const removeImageBtn = document.getElementById('removeImageBtn');
      const confirmBtn = document.getElementById('imageConfirmBtn');
      
      // Status elements
      const statusDiv = document.getElementById('imageReadingStatus');
      const resultDiv = document.getElementById('imageReadingResult');
      
      if (!readBtn || !modal || !fileInput) return;

      let selectedFile = null;

      // Open modal when click main button
      readBtn.addEventListener('click', () => {
        modal.classList.remove('hidden');
        resetModal();
      });

      // Close modal
      function closeModal() {
        modal.classList.add('hidden');
        resetModal();
      }

      modalOverlay?.addEventListener('click', closeModal);
      modalClose?.addEventListener('click', closeModal);
      imageCancelBtn?.addEventListener('click', closeModal);

      // Reset modal state
      function resetModal() {
        selectedFile = null;
        fileInput.value = '';
        previewContainer.classList.add('hidden');
        confirmBtn.disabled = true;
      }

      // Click upload area to select file
      uploadArea?.addEventListener('click', (e) => {
        if (e.target !== fileInput) {
          fileInput.click();
        }
      });

      // Handle file selection
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh');
          resetModal();
          return;
        }

        selectedFile = file;
        showPreview(file);
      });

      // Show preview
      function showPreview(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          imagePreview.src = e.target.result;
          imageFileName.textContent = file.name;
          previewContainer.classList.remove('hidden');
          confirmBtn.disabled = false;
        };
        reader.readAsDataURL(file);
      }

      // Remove image
      removeImageBtn?.addEventListener('click', () => {
        resetModal();
      });

      // Handle clipboard paste in modal
      modal.addEventListener('paste', (e) => {
        const items = e.clipboardData?.items;
        if (!items) return;

        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          if (item.type.startsWith('image/')) {
            e.preventDefault();
            
            const file = item.getAsFile();
            if (!file) continue;

            // Create a new File object with a name if it doesn't have one
            let finalFile = file;
            if (!file.name) {
              const extension = item.type.split('/')[1] || 'png';
              const timestamp = Date.now();
              finalFile = new File([file], `pasted_image_${timestamp}.${extension}`, { type: file.type });
            }

            selectedFile = finalFile;
            showPreview(finalFile);
            break;
          }
        }
      });

      // Generate unique ID
      function generateImageId() {
        const now = new Date();
        const timestamp = now.getTime();
        const random = Math.random().toString(36).substring(2, 8).toUpperCase();
        return `IMG_${timestamp}_${random}`;
      }

      // Get form field information for server mapping
      function getFormFieldInfo() {
        const form = document.getElementById('testRequestForm');
        if (!form) return {};

        return {
          // === PH·∫¶N B: Th√¥ng tin s·∫£n ph·∫©m/linh ki·ªán ===
          productName: {
            fieldName: 'productName',
            label: 'T√™n s·∫£n ph·∫©m/linh ki·ªán',
            placeholder: 'T√™n s·∫£n ph·∫©m/linh ki·ªán *'
          },
          productCode: {
            fieldName: 'productCode',
            label: 'M√£ s·∫£n ph·∫©m/linh ki·ªán',
            placeholder: 'M√£ s·∫£n ph·∫©m/linh ki·ªán *'
          },
          componentType: {
            fieldName: 'componentType',
            label: 'Lo·∫°i linh ki·ªán',
            placeholder: 'Lo·∫°i linh ki·ªán *'
          },
          componentStandard: {
            fieldName: 'componentStandard',
            label: 'C√¥ng chu·∫©n',
            placeholder: 'C√¥ng chu·∫©n (gi·ªù)'
          },
          sampleSubmissionNo: {
            fieldName: 'sampleSubmissionNo',
            label: 'L·∫ßn g·ª≠i m·∫´u',
            placeholder: 'L·∫ßn g·ª≠i m·∫´u'
          },
          changeFromLastNote: {
            fieldName: 'changeFromLastNote',
            label: 'M√¥ t·∫£ thay ƒë·ªïi so v·ªõi l·∫ßn tr∆∞·ªõc',
            placeholder: 'M√¥ t·∫£ thay ƒë·ªïi so v·ªõi l·∫ßn tr∆∞·ªõc'
          },
          requestPurpose: {
            fieldName: 'requestPurpose',
            label: 'M·ª•c ƒë√≠ch y√™u c·∫ßu',
            placeholder: 'M·ª•c ƒë√≠ch y√™u c·∫ßu *'
          },
          projectCode: {
            fieldName: 'projectCode',
            label: 'M√£ d·ª± √°n',
            placeholder: 'M√£ d·ª± √°n'
          },
          altCode: {
            fieldName: 'altCode',
            label: 'M√£ t∆∞∆°ng t·ª±/thay th·∫ø',
            placeholder: 'M√£ t∆∞∆°ng t·ª±/thay th·∫ø *'
          },
          appliedModel: {
            fieldName: 'appliedModel',
            label: 'Model √°p d·ª•ng',
            placeholder: 'Model √°p d·ª•ng *'
          },
          supplier: {
            fieldName: 'supplier',
            label: 'Nh√† cung c·∫•p',
            placeholder: 'Nh√† cung c·∫•p *'
          },
          numSamples: {
            fieldName: 'numSamples',
            label: 'S·ªë l∆∞·ª£ng m·∫´u giao',
            placeholder: 'S·ªë l∆∞·ª£ng m·∫´u giao *'
          },
          desiredCompletionDate: {
            fieldName: 'desiredCompletionDate',
            label: 'H·∫°n mong mu·ªën',
            placeholder: 'H·∫°n mong mu·ªën'
          },
          personReceived: {
            fieldName: 'personReceived',
            label: 'ƒê·∫ßu m·ªëi nh·∫≠n m·∫´u',
            placeholder: 'ƒê·∫ßu m·ªëi nh·∫≠n m·∫´u *'
          },
          notes: {
            fieldName: 'notes',
            label: 'Ghi ch√∫',
            placeholder: 'Ghi ch√∫ (ƒêi·ªÉm thay ƒë·ªïi, l√Ω do y√™u c·∫ßu g·∫•p...)'
          },
          
          // === PH·∫¶N C: Th√¥ng tin th·ª≠ nghi·ªám y√™u c·∫ßu ===
          testType: {
            fieldName: 'testType',
            label: 'Lo·∫°i ki·ªÉm tra',
            placeholder: 'Ki·ªÉm tra m·∫∑c ƒë·ªãnh/Special'
          },
          specialRequestDesc: {
            fieldName: 'specialRequestDesc',
            label: 'M√¥ t·∫£ ki·ªÉm tra ƒë·∫∑c bi·ªát',
            placeholder: 'M√¥ t·∫£ chi ti·∫øt h·∫°ng m·ª•c ki·ªÉm tra, ti√™u chu·∫©n √°p d·ª•ng...'
          }
        };
      }

      // Confirm and send image
      confirmBtn?.addEventListener('click', async () => {
        if (!selectedFile) return;

        // Save file data before closing modal
        const fileToSend = selectedFile;
        const fileName = selectedFile.name || 'image.jpg';

        closeModal();

        // Show loading
        statusDiv.classList.remove('hidden');
        resultDiv.classList.add('hidden');
        readBtn.disabled = true;

        try {
          // Generate unique ID for this image
          const imageId = generateImageId();

          // Get form field information for mapping
          const formFields = getFormFieldInfo();

          // Send file as binary using FormData
          const formData = new FormData();
          formData.append('image', fileToSend);
          formData.append('filename', fileName);
          formData.append('id', imageId);

          // Send each field separately - fieldName is the key to map result back
          Object.keys(formFields).forEach(key => {
            const field = formFields[key];
            formData.append(`field_${key}_name`, field.fieldName);  // fieldName ƒë·ªÉ map k·∫øt qu·∫£
            formData.append(`field_${key}_label`, field.label);
            formData.append(`field_${key}_placeholder`, field.placeholder);
          });

          const response = await fetch(IMAGE_READING_ENDPOINT, {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            throw new Error('L·ªói khi ƒë·ªçc ·∫£nh t·ª´ server');
          }

          let result = {};
          const responseText = await response.text();
          
          try {
            result = JSON.parse(responseText);
          } catch (parseError) {
            console.error('JSON parse error:', parseError.message);
            
            // Try to fix common JSON issues
            let fixedText = responseText;
            
            // Remove trailing commas
            fixedText = fixedText.replace(/,(\s*[}\]])/g, '$1');
            
            // Remove empty string fields like: "": null
            fixedText = fixedText.replace(/"[^"]*":\s*""\s*,?/g, '');
            fixedText = fixedText.replace(/,\s*"[^"]*":\s*""/g, '');
            
            try {
              result = JSON.parse(fixedText);
            } catch (secondError) {
              console.error('Parse failed after fix:', secondError.message);
              result = {};
            }
          }
          
          // Clean up result - remove any invalid/empty fields
          if (Array.isArray(result)) {
            result = result.map(item => {
              const cleaned = {};
              Object.keys(item).forEach(key => {
                if (key && key.trim() && item[key] !== null && item[key] !== undefined) {
                  cleaned[key] = item[key];
                }
              });
              return cleaned;
            }).filter(item => Object.keys(item).length > 0);
          } else if (typeof result === 'object') {
            const cleaned = {};
            Object.keys(result).forEach(key => {
              if (key && key.trim() && result[key] !== null && result[key] !== undefined) {
                cleaned[key] = result[key];
              }
            });
            result = cleaned;
          }

          // Extract data and auto-fill form fields
          // Handle if result is an array (get first element)
          let dataToFill = result;
          if (Array.isArray(result)) {
            if (result.length > 0) {
              dataToFill = result[0];
            } else {
              console.error('‚ö†Ô∏è Array is empty!');
              return;
            }
          }
          
          // Check if we got actual form data
          const expectedFields = ['productName', 'productCode', 'supplier', 'numSamples'];
          const hasExpectedFields = expectedFields.some(field => dataToFill.hasOwnProperty(field));
          
          if (!hasExpectedFields && Object.keys(dataToFill).length > 0) {
            console.warn('‚ö†Ô∏è Data format mismatch. Keys:', Object.keys(dataToFill));
            alert('Server tr·∫£ v·ªÅ d·ªØ li·ªáu nh∆∞ng kh√¥ng kh·ªõp v·ªõi form. Vui l√≤ng ki·ªÉm tra format.');
            return;
          }
          
          autoFillFormFromImage(dataToFill);

          // Show success message
          resultDiv.classList.remove('hidden');
          resultDiv.innerHTML = '<span class="text-green-600 font-medium">‚úì ƒê√£ ƒë·ªçc v√† ƒëi·ªÅn th√¥ng tin th√†nh c√¥ng</span>';
          setTimeout(() => {
            resultDiv.classList.add('hidden');
          }, 3000);

        } catch (error) {
          alert('L·ªói khi ƒë·ªçc ·∫£nh: ' + error.message);
        } finally {
          statusDiv.classList.add('hidden');
          readBtn.disabled = false;
        }
      });

      // Test function with sample data
      function testWithSampleData() {
        const sampleData = [{
          "productName": "Van ƒëi·ªán t·ª´ 24V 1/4\" Spring_NCC SPRING 2000127",
          "productCode": "2007030101",
          "supplier": "YUYAO SPRING",
          "numSamples": "10",
          "desiredCompletionDate": "2025-10-30",
          "notes": "C√°c ƒëi·ªÉm c·∫£i ti·∫øn ƒë∆∞·ª£c tr√¨nh b√†y nh∆∞ KO APR19907 ƒë√≠nh k√®m. Hi·ªán t·∫°i NCC s·ª≠a khu√¥n ƒë·ªÉ lo·∫°i b·ªè g√≥c l√≤m b√™n trong van ƒëi·ªán t·ª´ => l√†m tƒÉng di·ªán t√≠ch ti·∫øp x√∫c v·ªõi d·∫ßu cao su, c·∫£i thi·ªán ƒë·ªô k√≠n c·ªßa van, t·ªâ l·ªá NG r√≤ r·ªâ gi·∫£m r√µ r·ªát.",
          "specialRequestDesc": "Ki·ªÉm tra m·∫∑c ƒë·ªãnh theo ti√™u chu·∫©n k·ªπ thu·∫≠t"
        }];
        
        console.log('üß™ Testing form fill with sample data...');
        const dataToFill = Array.isArray(sampleData) && sampleData.length > 0 ? sampleData[0] : sampleData;
        autoFillFormFromImage(dataToFill);
      }
      
      // Test function available in console
      window.testImageFill = testWithSampleData;

      // Helper function to auto-fill form fields
      function autoFillFormFromImage(data) {
        // Get form fields
        const form = document.getElementById('testRequestForm');
        if (!form) return;

        // Helper to get case-insensitive value
        function getValue(obj, keys) {
          if (!obj || typeof obj !== 'object') return '';
          const lower = Object.keys(obj).reduce((acc, k) => {
            acc[k.toLowerCase()] = obj[k];
            return acc;
          }, {});
          for (const key of keys) {
            if (lower[key.toLowerCase()] !== undefined) return lower[key.toLowerCase()];
          }
          return '';
        }

        // List of all form fields that can be filled (Part B and C)
        const formFields = [
          // Part B
          'productName', 'productCode', 'componentType', 'componentStandard',
          'sampleSubmissionNo', 'changeFromLastNote', 'requestPurpose', 
          'projectCode', 'altCode', 'appliedModel', 'supplier', 'numSamples',
          'desiredCompletionDate', 'personReceived', 'notes',
          // Part C
          'testType', 'specialRequestDesc'
        ];

        // Helper to clean value
        function cleanValue(val) {
          if (!val) return '';
          return String(val).trim().replace(/\s+/g, ' '); // Remove extra spaces and line breaks
        }

        // First, try to map using exact fieldName (new way)
        let filledCount = 0;
        
        formFields.forEach(fieldName => {
          let rawValue = data[fieldName];
          if (!rawValue) return;
          
          // Clean the value - trim and normalize whitespace
          const value = cleanValue(rawValue);
          if (!value) return;

          let field = form.querySelector(`[name="${fieldName}"]`) || document.getElementById(fieldName);
          if (!field) return;
          
          // Special handling for radio buttons
          if (fieldName === 'testType') {
            const radioField = form.querySelector(`input[name="${fieldName}"][value="${value}"]`);
            if (radioField) {
              radioField.checked = true;
              radioField.dispatchEvent(new Event('change', { bubbles: true }));
              filledCount++;
            }
            return;
          }
          
          // Special handling for select dropdown
          if (field.tagName === 'SELECT') {
            const option = Array.from(field.options).find(opt => 
              opt.value === value || opt.text.toLowerCase() === value.toLowerCase()
            );
            if (option) {
              field.value = option.value;
              field.dispatchEvent(new Event('change', { bubbles: true }));
              filledCount++;
            }
            return;
          }
          
          // For other input fields (text, number, textarea, hidden)
          if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA') {
            if (!field.value.trim()) {
              field.value = value;
              field.dispatchEvent(new Event('change', { bubbles: true }));
              field.dispatchEvent(new Event('input', { bubbles: true }));
              filledCount++;
            }
          }
        });
        
        console.log(`‚úì Filled ${filledCount} field(s) from image data`);

        // Fallback: Map possible field names from server response (old way for compatibility)
        const fieldMappings = {
          'productName': ['productname', 'product_name', 'tensp', 'ten_sp', 'sanpham', 'ten', 'name'],
          'productCode': ['productcode', 'product_code', 'masp', 'ma_sp', 'machung', 'ma', 'code'],
          'componentType': ['componenttype', 'component_type', 'loailinhkien', 'loai_linh_kien', 'linhkien', 'type'],
          'componentStandard': ['componentstandard', 'component_standard', 'congchuan', 'cong_chuan', 'standard'],
          'sampleSubmissionNo': ['samplesubmissionno', 'sample_submission_no', 'languimau', 'lan_gui_mau'],
          'changeFromLastNote': ['changefromlastnote', 'change_from_last_note', 'mota_thaydoi', 'mo_ta_thay_doi'],
          'requestPurpose': ['requestpurpose', 'request_purpose', 'mucdich', 'muc_dich', 'purpose'],
          'supplier': ['supplier', 'nhacungcap', 'nha_cung_cap', 'vendor', 'ncc', 'cuahang'],
          'numSamples': ['numsamples', 'num_samples', 'soluong', 'so_luong', 'qty', 'quantity', 'sl'],
          'projectCode': ['projectcode', 'project_code', 'maduan', 'ma_du_an'],
          'altCode': ['altcode', 'alt_code', 'matg_thaythe', 'matg_thay_the'],
          'appliedModel': ['appliedmodel', 'applied_model', 'modelapdung', 'model_ap_dung', 'model'],
          'desiredCompletionDate': ['desiredcompletiondate', 'desired_completion_date', 'hanmongmuon', 'han_mong_muon'],
          'personReceived': ['personreceived', 'person_received', 'daumoithanmau', 'dau_moi_nhan_mau'],
          'notes': ['notes', 'ghichu', 'ghi_chu', 'note'],
          'testType': ['testtype', 'test_type', 'loaikiemtra', 'loai_kiem_tra'],
          'specialRequestDesc': ['specialrequestdesc', 'special_request_desc', 'motakiemtradacbiet', 'mo_ta_kiem_tra_dac_biet']
        };

        // Auto-fill fields using fallback mappings
        Object.entries(fieldMappings).forEach(([fieldId, possibleKeys]) => {
          let rawValue = getValue(data, possibleKeys);
          if (!rawValue) return;
          
          // Clean the value
          const value = cleanValue(rawValue);
          if (!value) return;
          
          let field = form.querySelector(`[name="${fieldId}"]`) || document.getElementById(fieldId);
          
          // Skip if already filled (except for radio)
          if (fieldId !== 'testType' && field && field.value.trim()) return;
          
          // Special handling for radio button
          if (fieldId === 'testType') {
            const radioField = form.querySelector(`input[name="${fieldId}"][value="${value}"]`);
            if (radioField) {
              radioField.checked = true;
              radioField.dispatchEvent(new Event('change', { bubbles: true }));
            }
            return;
          }
          
          // Special handling for select dropdown
          if (field && field.tagName === 'SELECT') {
            const option = Array.from(field.options).find(opt => 
              opt.value === value || opt.text.toLowerCase() === value.toLowerCase()
            );
            if (option) {
              field.value = option.value;
              field.dispatchEvent(new Event('change', { bubbles: true }));
            }
            return;
          }
          
          // For other input fields
          if (field && (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA')) {
            field.value = value;
            field.dispatchEvent(new Event('change', { bubbles: true }));
            field.dispatchEvent(new Event('input', { bubbles: true }));
          }
        });
      }
    })();

    // A. Sender auto-complete and auto-fill email/department
    (function setupSenderAutocomplete(){
      const nameInput = document.getElementById('senderName');
      const emailInput = document.querySelector('input[name="senderEmail"]');
      const deptSelect = document.querySelector('select[name="department"]');
      const list = document.getElementById('senderNameOptions');
      if (!nameInput || !emailInput || !deptSelect || !list) return;

      const SENDER_DB = [
        { name: 'ƒêo√†n Th·ªã Minh Th∆∞', dept: 'KTSP', email: 'thu.doan@karofi.vn' },
        { name: 'ƒê·∫∑ng VƒÉn H·∫£i', dept: 'TKCK', email: 'haidv1@karofi.vn' },
        { name: 'Nguy·ªÖn Quang Tr·ªçng', dept: 'KTCN', email: 'trongnq@karofi.vn' },
        { name: 'Ph·∫°m Quang Doanh', dept: 'TKƒêT', email: 'doanh.pham@karofi.vn' },
        { name: 'Nguy·ªÖn Th·ªã M·ª´ng', dept: 'SC', email: 'mung.nguyen1@karofi.vn' },
        { name: 'V≈© ƒêƒÉng L∆∞∆°ng', dept: 'KTSP', email: 'luong.vu@karofi.vn' },
        { name: 'Ho√†ng L√™ Anh', dept: 'TKCK', email: 'anh.hoang2@karofi.com' },
        { name: 'Phan VƒÉn C·ª≠', dept: 'KTSP', email: 'cupv@karofi.vn' },
        { name: 'Ph·∫°m VƒÉn Thu·∫≠n', dept: 'KTSX', email: 'thuan.pham2@karofi.vn' },
        { name: 'Chu VƒÉn Quang', dept: 'KTSP', email: 'quangcv@karofi.vn' },
        { name: 'Tr·∫ßn Kh·∫Øc L√¢m', dept: 'KTSP', email: 'lamtk@karofi.vn' },
        { name: 'ƒê·∫∑ng Th·∫ø Huy', dept: 'TKƒêT', email: 'huydt@karofi.com' },
        { name: 'Tr·∫ßn H·ªìng Nhung', dept: 'SC', email: 'nhung.tran2@karofi.vn' },
        { name: 'ƒê·ªó Th√†nh C√¥ng', dept: 'KTSP', email: 'congdt@karofi.vn' },
        { name: 'Nguy·ªÖn Kim C∆∞∆°ng', dept: 'NCTN', email: 'cuong.nguyen6@karofi.com' },
        { name: 'Nguy·ªÖn Chung Nam', dept: 'Mua h√†ng', email: 'nam.nguyen5@karofi.vn' },
        { name: 'Nguy·ªÖn Ng·ªçc Quang', dept: 'TKCK', email: 'quang.nguyen1@karofi.vn' },
        { name: 'Ho√†ng Th√πy Linh', dept: 'NCTN', email: 'linh.hoang1@karofi.vn' },
        { name: 'ƒêo√†n VƒÉn Minh', dept: 'TKCK', email: 'minh.doan@karofi.vn' },
        { name: 'Tr·∫ßn VƒÉn C∆∞·ªùng', dept: 'QA/QC nh√† m√°y', email: 'cuong.tran1@karofi.vn' },
        { name: 'ƒê·ªó C√¥ng Nh·∫≠m', dept: 'TKCK', email: 'nham.do@karofi.vn' },
        { name: 'L√™ Minh H·∫£i', dept: 'KTSP', email: 'hai.le3@karofi.vn' },
        { name: 'ƒê·ªó Xu√¢n Th√°i', dept: 'KTSP', email: 'thai.do1@karofi.vn' },
        { name: 'ƒê·∫∑ng Th·∫ø Huy', dept: 'KTSP', email: 'huydt@karofi.com' },
        { name: 'Tr·ªãnh K·∫ø L·ª±c', dept: 'KTSX', email: 'luc.trinh@karofi.vn' },
        { name: 'ƒê·∫∑ng VƒÉn Thu·∫•n', dept: 'KTCN', email: 'thuan.dang@karofi.vn' },
        { name: 'L√™ Th·∫ø Anh', dept: 'KTSP', email: 'anh.le@karofi.vn' },
        { name: 'D∆∞∆°ng Qu·ªëc Hi·∫øu', dept: 'TKCK', email: 'hieudq1@karofi.vn' },
        { name: 'Ph√πng Ch√≠ Ti·∫øn', dept: 'KTSP', email: 'tien.phung@karofi.vn' },
        { name: 'Nguy·ªÖn Th·ªã H∆∞∆°ng Th√∫y', dept: 'Mua h√†ng', email: 'thuy.nguyen@karofi.vn' },
        { name: 'ƒê√†o Ho√†ng D∆∞∆°ng', dept: 'DQA', email: 'duong.dao@karofi.vn' },
        { name: 'Nguy·ªÖn M·∫°nh H√πng', dept: 'KTSX', email: 'hung.nguyen2@karofi.vn' },
        { name: 'Nguy·ªÖn H·ªìng Hi·∫øu', dept: 'KTSX', email: 'hieu.nguyen@karofi.vn' },
        { name: 'ƒê√†m Huy H√πng', dept: 'SC', email: 'hung.dam@karofi.vn' },
        {name: 'Kh∆∞∆°ng ƒê·ª©c T√¨nh', dept: 'NCTN', email: 'tinh.khuong@karofi.vn' },
        {name: 'ƒê·∫∑ng Th·ªã Ch√≠n', dept: 'NCTN', email: 'chindt@karofi.vn' },
        {name: 'Ho√†ng VƒÉn Th√†nh', dept: 'NCTN', email: 'thanhhv@karofi.vn' },
        {name: 'Nguy·ªÖn Th·ªã Th·ªßy', dept: 'NCTN', email: 'thuynt3@karofi.vn' },
      ];

      function normalize(s){
        return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
      }

      function renderOptions(q){
        const n = normalize(q);
        // When empty query: do not show any suggestion
        if (!n) { list.innerHTML = ''; return; }
        const candidates = SENDER_DB
          .filter(x => normalize(x.name).includes(n))
          .sort((a,b)=> a.name.localeCompare(b.name))
          .slice(0, 30);
        list.innerHTML = candidates.map(c=>`<option value="${c.name}"></option>`).join('');
      }

      function tryAutofill(){
        const val = nameInput.value || '';
        const exact = SENDER_DB.find(x=>x.name === val);
        if (exact) {
          emailInput.value = exact.email;
          // set department select to matching option if possible
          const opts = Array.from(deptSelect.options);
          const match = opts.find(o=> (o.value||o.text||'').trim() === exact.dept);
          if (match) deptSelect.value = match.value || match.text;
        }
      }

      nameInput.addEventListener('input', ()=>{ renderOptions(nameInput.value); });
      nameInput.addEventListener('change', tryAutofill);
      nameInput.addEventListener('blur', tryAutofill);
      renderOptions('');
    })();

    // ===== Enhanced File Upload (Deferred) =====
    let testRequestUploads = [];
    let pendingFiles = [];
    (function setupDeferredFileUpload(){
      const fileInput = document.getElementById('testRequestFiles');
      const uploadArea = document.getElementById('fileUploadArea');
      const uploadList = document.getElementById('testRequestUploadList');
      const uploadProgress = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');
      const uploadPercent = document.getElementById('uploadPercent');

      const allowedTypes = {
        'application/pdf': 'PDF',
        'application/msword': 'DOC',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'DOCX',
        'application/vnd.ms-excel': 'XLS',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'XLSX',
        'image/jpeg': 'JPG',
        'image/jpg': 'JPG',
        'image/png': 'PNG'
      };
      const maxFileSize = 20 * 1024 * 1024;

      function getFileIcon(mimeType) {
        if (mimeType.startsWith('image/')) return 'üñºÔ∏è';
        if (mimeType.includes('pdf')) return 'üìÑ';
        if (mimeType.includes('word')) return 'üìù';
        if (mimeType.includes('excel') || mimeType.includes('sheet')) return 'üìä';
        return 'üìé';
      }
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }
      function validateFile(file) {
        const errors = [];
        const type = file.type || '';
        if (type ? !allowedTypes[type] : !( ['pdf','doc','docx','xls','xlsx','jpg','jpeg','png'].includes((file.name.split('.').pop()||'').toLowerCase()) )) {
          errors.push('Lo·∫°i file kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£');
        }
        if (file.size > maxFileSize) errors.push('File qu√° l·ªõn (t·ªëi ƒëa 20MB)');
        return errors;
      }
      function showProgress(percent) {
        uploadProgress.classList.remove('hidden');
        progressBar.style.width = percent + '%';
        uploadPercent.textContent = percent + '%';
        if (percent >= 100) setTimeout(()=>uploadProgress.classList.add('hidden'), 800);
      }

      function createItem(file, idx) {
        const isImage = file.type.startsWith('image/');
        const typeLabel = allowedTypes[file.type] || 'FILE';
        const row = document.createElement('div');
        row.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow file-item';
        row.id = `file-row-${idx}`;
        row.innerHTML = `
          <div class="flex items-start space-x-4">
            ${isImage ?
              `<div class="flex-shrink-0 file-preview">
                <img id="preview-${idx}" class="w-16 h-16 object-cover rounded-lg border" src="#" alt="Preview">
              </div>` :
              `<div class="flex-shrink-0 w-16 h-16 bg-blue-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">${getFileIcon(file.type)}</span>
              </div>`}
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <input id="rename-${idx}" class="text-sm font-medium text-gray-900 truncate border border-blue-200 rounded px-2 py-1 w-full max-w-xs"
                       value="${file.name}" />
                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${typeLabel}</span>
              </div>
              <p class="text-sm text-gray-500 mt-1">${formatFileSize(file.size)}</p>
            </div>
            <button type="button" id="remove-${idx}" class="flex-shrink-0 p-1 rounded-full text-gray-400 hover:text-red-600 hover:bg-red-50">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>`;
        uploadList.appendChild(row);

        if (isImage) {
          const r = new FileReader();
          r.onload = e => { const img = document.getElementById(`preview-${idx}`); if (img) img.src = e.target.result; };
          r.readAsDataURL(file);
        }
        row.querySelector(`#rename-${idx}`).addEventListener('input', e=>{
          const pf = pendingFiles[idx]; if (pf) pf.name = e.target.value;
        });
        row.querySelector(`#remove-${idx}`).onclick = ()=>{
          const pf = pendingFiles[idx];
          if (pf) pendingFiles[idx] = null;
          row.remove();
        };
      }

      function addFiles(files) {
        const errs = [];
        Array.from(files).forEach(file=>{
          const e = validateFile(file);
          if (e.length) { errs.push(`${file.name}: ${e.join(', ')}`); return; }
          const idx = pendingFiles.length;
          pendingFiles.push({ file, name: file.name });
          createItem(file, idx);
        });
        if (errs.length) alert('M·ªôt s·ªë file kh√¥ng h·ª£p l·ªá:\n\n' + errs.join('\n'));
      }

      ['dragenter','dragover','dragleave','drop'].forEach(ev=>{
        uploadArea.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); }, false);
      });
      ['dragenter','dragover'].forEach(ev=>{
        uploadArea.addEventListener(ev, ()=>uploadArea.classList.add('border-blue-500','bg-blue-50'), false);
      });
      ['dragleave','drop'].forEach(ev=>{
        uploadArea.addEventListener(ev, ()=>uploadArea.classList.remove('border-blue-500','bg-blue-50'), false);
      });
      uploadArea.addEventListener('drop', e=>addFiles(e.dataTransfer.files), false);
      fileInput.addEventListener('change', function(){ if (this.files?.length) addFiles(this.files); this.value=''; });
      uploadArea.addEventListener('click', e=>{ if (e.target!==fileInput) fileInput.click(); });

      window.__getPendingFiles = () => pendingFiles.filter(Boolean);
      window.__clearPendingFiles = () => { pendingFiles = []; };
      window.__showUploadProgress = showProgress;
    })();

    // Form submit logic (for main forms)
    const LOCAL_TASKS_KEY = 'DQA_TASKS_V1';
    function __loadTasks(){ try { return JSON.parse(localStorage.getItem(LOCAL_TASKS_KEY) || '[]'); } catch { return []; } }
    function __saveTask(task){ const cur = __loadTasks(); cur.push(task); localStorage.setItem(LOCAL_TASKS_KEY, JSON.stringify(cur)); }

    async function uploadPendingFiles(progressCb){
      const list = (window.__getPendingFiles ? window.__getPendingFiles() : []);
      const total = Math.max(list.length, 1);
      const results = [];
      let done = 0;

      for (const item of list) {
        const base64 = await new Promise((resolve,reject)=>{
          const r = new FileReader();
          r.onload = e=>resolve(e.target.result.split(',')[1]);
          r.onerror = ()=>reject(new Error('Kh√¥ng th·ªÉ ƒë·ªçc file'));
          r.readAsDataURL(item.file);
        });
        const payload = { data: [{ filename: (item.name || item.file.name), mimetype: item.file.type, filedata: base64 }] };
        const resp = await fetch(FILE_UPLOAD_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) throw new Error(await resp.text());
        let result = {};
        const ct = resp.headers.get('content-type') || '';
        if (ct.includes('application/json')) result = await resp.json();
        else { try { result = JSON.parse(await resp.text()); } catch { result = {}; } }
        const url = result.url || result.fileUrl || result.public_url || (result.data && result.data[0] && (result.data[0].url || result.data[0].link)) || '#';
        results.push({ name: (item.name || item.file.name), url, type: item.file.type, size: item.file.size });

        done++;
        const percent = Math.round((done/total)*100);
        if (progressCb) progressCb(percent);
        if (window.__showUploadProgress) window.__showUploadProgress(percent);
      }
      return results;
    }

    function toJSON(form){
      const d = {};
      new FormData(form).forEach((val,key)=>{
        if(d[key]) d[key] = [].concat(d[key],val); else d[key]=val;
      });
      return d;
    }

    function submitForm(formId, endpoint, getUploads){
      document.getElementById(formId).onsubmit = async function(e){
        e.preventDefault();
        if (formId === 'testRequestForm') {
          const confirmed = window.confirm('B·∫±ng vi·ªác x√°c nh·∫≠n g·ª≠i y√™u c·∫ßu, b·∫°n cam k·∫øt m·∫´u ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë√∫ng v√† ƒë·ªß ƒë·∫øn DQA.');
          if (!confirmed) return;
        }
        const btn = this.querySelector("button[type=submit]");
        const originalLabel = btn ? btn.innerHTML : "";
        if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner'></span><span style='margin-left:8px'>ƒêang g·ª≠i...</span>"; }

        const data = (function toJSON(form){
          const d = {}; new FormData(form).forEach((val,key)=>{ d[key] = d[key] ? [].concat(d[key],val) : val; }); return d;
        })(this);
        const isSpecial = data.testType === 'special';
        const submissionRound = parseInt(data.sampleSubmissionNo || '0', 10) || 0;
        const normalizedRequestDate = (data.requestDate || '').toString().slice(0,16).replace('T', ' ');
        const normalizedDesiredDate = (data.desiredCompletionDate || '').toString().slice(0,10);
        const componentStd = (function(){
          let s = Number(data.componentStandard || 0);
          if (!s) {
            try { s = (window.__resolveComponentStandard ? window.__resolveComponentStandard(data.componentType) : 0) || 0; }
            catch(_) { s = 0; }
          }
          return s;
        })();

        // Chuy·ªÉn s·ªë th·∫≠p ph√¢n sang d·∫°ng d√πng d·∫•u ph·∫©y ƒë·ªÉ ƒë·ªìng b·ªô Google Sheet
        const componentStdStr = String(componentStd).replace('.', ',');

        const mapped = {
          requesterName: String(data.senderName || '').trim(),
          email: String(data.senderEmail || '').trim(),
          requestDate: String(normalizedRequestDate || '').trim(),
          requestCode: String(document.getElementById('requestCode')?.value || '').trim(),
          deptRequest: String(data.department || '').trim(),
          itemName: String(data.productName || '').trim(),
          itemCode: String(data.productCode || '').trim(),
          componentType: String(data.componentType || '').trim(),
          componentStandard: String(componentStdStr),
          purpose: String(data.requestPurpose || '').trim(),
          projectCode: String(data.projectCode || '').trim(),
          vendor: String(data.supplier || '').trim(),
          qtySamples: String(data.numSamples || '').trim(),
          desiredDate: String(normalizedDesiredDate || '').trim(),
          changeReq: String(data.notes || '').trim(),
          changeFromLastNote: String(data.changeFromLastNote || '').trim(),
          kiemtraDefault: isSpecial ? '0' : '1',
          kiemtraDacBiet: isSpecial ? '1' : '0',
          SpecialReq: String(isSpecial ? (document.getElementById('specialRequestDesc')?.value || '') : '').trim(),
          Receiver: String(data.personReceived || '').trim(),
          sampleSubmissionNo: String(submissionRound),
          isResubmission: String(submissionRound),
          altCode: String(data.altCode || '').trim(),
          appliedModel: String(data.appliedModel || '').trim(),
          Score: String(componentStdStr), Odoojira: '', Assignee: ''
        };

        const pending = window.__getPendingFiles ? window.__getPendingFiles() : [];
        const attachmentNames = pending.map(p=>p?.name || p?.file?.name).filter(Boolean);

        const localTask = {
          requesterName: mapped.requesterName,
          submissionDate: mapped.requestDate,
          desiredDueDate: mapped.desiredDate,
          responseDueDate: '',
          taskName: `Y√™u c·∫ßu th·ª≠ nghi·ªám - ${mapped.itemName}`,
          pic: mapped.Receiver,
          status: 'ƒê√£ g·ª≠i',
          reportCode: mapped.requestCode,
          email: mapped.email,
          department: mapped.deptRequest
        };

        const fd = new FormData();
        Object.entries(mapped).forEach(([k,v])=>fd.append(k, v));
        fd.append('attachments', attachmentNames.join(';'));
        // add component standard explicitly for form-data receivers expecting separate field
        fd.append('componentStandard', String(componentStdStr));
        for (const item of pending) {
          if (!item) continue;
          const name = item.name || item.file.name;
          fd.append('files[]', item.file, name);
        }

        try{
          let resp = await fetch(endpoint, { method: 'POST', body: fd });
          if (!resp.ok) {
            const uploaded = await uploadPendingFiles();
            const mappedFallback = {
              ...mapped,
              attachments: uploaded.map(u=>u.name || '').join(';'),
              attachmentUrls: uploaded.map(u=>u.url || '').join(';')
            };
            resp = await fetch(endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json", "Accept": "application/json" },
              body: JSON.stringify({ data: [mappedFallback] })
            });
            if (!resp.ok) throw new Error(await resp.text());
          }

          // Th√†nh c√¥ng
          try { __saveTask(localTask); } catch {}
          if (btn) {
            btn.innerHTML="ƒê√£ g·ª≠i!";
            setTimeout(()=>{btn.innerHTML=originalLabel;btn.disabled=false;},20000);
          }

          if(!document.getElementById('keepDataAfterSubmit')?.checked){
            this.reset();
            setCurrentDateTime('testRequestDate');
            setRequestCode();
            try {
              const list = document.getElementById('testRequestUploadList');
              if (list) list.innerHTML = '';
              if (window.__clearPendingFiles) window.__clearPendingFiles();
              if (Array.isArray(testRequestUploads)) testRequestUploads = [];
            } catch(_) {}
          }
        }catch(err){
          try { __saveTask(localTask); } catch {}
          alert("G·ª≠i th·∫•t b·∫°i: "+err);
          if (btn) { btn.innerHTML=originalLabel; btn.disabled=false; }
        }
      };
    }
    submitForm("testRequestForm", FORM_SUBMIT_ENDPOINT, ()=>testRequestUploads);
    function setRequestCode(){
      const el = document.getElementById('requestCode');
      if (!el) return;
      const now = new Date();
      const dd = String(now.getDate()).padStart(2,'0');
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let rnd = '';
      for (let i=0;i<6;i++) rnd += alphabet[Math.floor(Math.random()*alphabet.length)];
      el.value = `QA.Y.${dd}${mm}-${rnd}`;
    }
    setRequestCode();
    // internal forms moved to DQA_internal.html

    function initForm4() {
      if (form4Initialized) {
        if (typeof form4Reload === 'function') {
          form4Reload();
        }
        return;
      }
      form4Initialized = true;

      const statusText = document.getElementById('f4-statusText');
      const assigneeFilter = document.getElementById('f4-assigneeFilter');
      const tableBody = document.getElementById('f4-scheduleTable');
      const recordCounter = document.getElementById('f4-recordCounter');
      const legendContainer = document.getElementById('f4-legend');
      const chartWrapper = document.getElementById('f4-chartWrapper');
      const taskList = document.getElementById('f4-taskList');
      const detailSection = document.getElementById('f4-detailSection');
      const closeDetailBtn = document.getElementById('f4-closeDetailBtn');
      const reloadButton = document.getElementById('f4-reloadButton');

      const palette = [
        '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316', '#14b8a6', '#6366f1'
      ];
      const colorCache = new Map();
      const expandedAssignees = new Set();

      const WORKING_DAYS = [1, 2, 3, 4, 5, 6];
      const DAY_START = 8 * 60;
      const LUNCH_START = 12 * 60 + 30;
      const LUNCH_END = 13 * 60 + 30;
      const DAY_END = 17 * 60;
      const MORNING_MINUTES = LUNCH_START - DAY_START;
      const AFTERNOON_MINUTES = DAY_END - LUNCH_END;
      const WORKDAY_MINUTES = MORNING_MINUTES + AFTERNOON_MINUTES;
      const TIME_ZONE = 'Asia/Ho_Chi_Minh';

      const { DateTime } = luxon || {};
      if (!DateTime) {
        console.error('Luxon ch∆∞a s·∫µn s√†ng cho Form 4');
        if (statusText) statusText.textContent = 'L·ªói: Luxon ch∆∞a ƒë∆∞·ª£c t·∫£i.';
        return;
      }

      let scheduleRows = [];
      let timelineSegments = [];

      // Danh s√°ch ng∆∞·ªùi ƒë∆∞·ª£c ph√©p hi·ªÉn th·ªã tr√™n map (timeline)
      const ALLOWED_MAP_ASSIGNEES = new Set([
        'L√™ Ng·ªçc √Ånh',
        'V≈© Th·ªã Thanh Hi·ªÅn',
        'L√™ Th·ªã Th·∫£o',
        'L√™ VƒÉn S∆°n',
        'Ph·∫°m Th·ªã Minh',
        'ƒê·ªó Quang Long',
        'L·∫°i Qu·ªëc L·ªôc',
        'Nguy·ªÖn Th·ªã Hi·ªÅn',
        'Ph·∫°m Th√†nh Trung Ki√™n'
      ]);

      function getColor(name) {
        if (!colorCache.has(name)) {
          colorCache.set(name, palette[colorCache.size % palette.length]);
        }
        return colorCache.get(name);
      }

      function parseDate(value) {
        if (!value) return null;
        if (value instanceof Date) return DateTime.fromJSDate(value, { zone: TIME_ZONE });
        if (typeof value === 'string') {
          const normalised = value.includes('T') ? value : value.replace(' ', 'T');
          const iso = DateTime.fromISO(normalised, { zone: TIME_ZONE });
          if (iso.isValid) return iso;
          const fallback = DateTime.fromFormat(value, 'dd/MM/yyyy HH:mm', { zone: TIME_ZONE });
          return fallback.isValid ? fallback : null;
        }
        return null;
      }

      function ensureWorkingStart(dt) {
        let pointer = dt.set({ second: 0, millisecond: 0 });
        while (true) {
          if (!WORKING_DAYS.includes(pointer.weekday)) {
            pointer = pointer.plus({ days: 1 }).startOf('day').set({ hour: 8, minute: 0 });
            continue;
          }
          const minutes = pointer.hour * 60 + pointer.minute;
          if (minutes < DAY_START) {
            pointer = pointer.set({ hour: 8, minute: 0 });
            continue;
          }
          if (minutes >= LUNCH_START && minutes < LUNCH_END) {
            pointer = pointer.set({ hour: 13, minute: 30 });
            continue;
          }
          if (minutes >= DAY_END) {
            pointer = pointer.plus({ days: 1 }).startOf('day').set({ hour: 8, minute: 0 });
            continue;
          }
          return pointer;
        }
      }

      function addWorkingHours(start, hours) {
        let remaining = hours * 60;
        let current = ensureWorkingStart(start);
        while (remaining > 0) {
          const minutes = current.hour * 60 + current.minute;
          let blockEnd = minutes < LUNCH_START ? LUNCH_START : DAY_END;
          if (minutes >= LUNCH_START && minutes < LUNCH_END) {
            current = current.set({ hour: 13, minute: 30 });
            continue;
          }
          const usable = blockEnd - minutes;
          if (usable >= remaining) {
            current = current.plus({ minutes: remaining });
            remaining = 0;
          } else {
            current = current.plus({ minutes: usable });
            remaining -= usable;
            if (blockEnd === LUNCH_START) {
              current = current.set({ hour: 13, minute: 30 });
            } else {
              current = current.plus({ days: 1 }).set({ hour: 8, minute: 0 });
            }
          }
          current = ensureWorkingStart(current);
        }
        return current;
      }

      function buildSchedule(data) {
        const grouped = new Map();
        data.forEach((task, index) => {
          const assignee = String(task.assignee || 'Kh√°c').trim();
          if (!grouped.has(assignee)) grouped.set(assignee, []);
          grouped.get(assignee).push({ ...task, __idx: index });
        });
        grouped.forEach(list => {
          list.sort((a, b) => {
            const sa = parseDate(a.start_time);
            const sb = parseDate(b.start_time);
            if (!sa && !sb) return 0;
            if (!sa) return 1;
            if (!sb) return -1;
            return sa.toMillis() - sb.toMillis();
          });
        });

        const rows = [];
        const segments = [];
        let order = 1;

        grouped.forEach((tasks, assignee) => {
          let cursor = null;
          tasks.forEach(task => {
            const startRaw = parseDate(task.start_time);
            const points = parseFloat(task.work_points || task.points || task.hours || task.man_hour || task.manHour || 0);
            if (!startRaw || !isFinite(points) || points <= 0) return;
            let start = cursor && cursor > startRaw ? cursor : startRaw;
            start = ensureWorkingStart(start);
            const providedEnd = parseDate(task.end_time);
            const end = providedEnd && providedEnd > start ? providedEnd : addWorkingHours(start, points);
            cursor = end;

            rows.push({
              order,
              assignee,
              start,
              end,
              points,
              taskName: task.task_name || task.task_code || `Task #${order}`
            });

            segments.push({
              order,
              assignee,
              start,
              end,
              points,
              taskName: task.task_name || task.task_code || `Task #${order}`
            });

            order += 1;
          });
        });

        rows.sort((a, b) => a.order - b.order);
        segments.sort((a, b) => a.order - b.order);
        return { rows, segments };
      }

      function populateFilterOptions(rows) {
        if (!assigneeFilter) return;
        const names = Array.from(new Set(rows.map(row => row.assignee)));
        assigneeFilter.innerHTML = '<option value="all">T·∫•t c·∫£ nh√¢n s·ª±</option>';
        names.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          assigneeFilter.appendChild(option);
          expandedAssignees.add(name);
        });
      }

      function formatDate(dt) {
        return dt ? dt.toFormat('dd/MM HH:mm') : '';
      }

      function renderTaskList(rows, filter) {
        if (!taskList) return;
        const filtered = filter === 'all' ? rows : rows.filter(row => row.assignee === filter);
        if (!filtered.length) {
          taskList.innerHTML = '<div class="text-sm text-gray-500 px-4 py-6 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
          recordCounter.textContent = '0 t√°c v·ª•';
          return;
        }

        const grouped = new Map();
        filtered.forEach(row => {
          if (!grouped.has(row.assignee)) grouped.set(row.assignee, []);
          grouped.get(row.assignee).push(row);
        });

        taskList.innerHTML = '';
        grouped.forEach((list, assignee) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'mb-1';

          const header = document.createElement('div');
          const expanded = expandedAssignees.has(assignee);
          header.className = 'flex items-center justify-between px-3 py-2 bg-gray-50 hover:bg-gray-100 cursor-pointer rounded transition';
          header.innerHTML = `
            <div class="flex items-center gap-2 flex-1">
              <svg class="w-4 h-4 text-gray-500 transition-transform ${expanded ? 'rotate-90' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
              <span class="h-3 w-3 rounded-full" style="background-color:${getColor(assignee)}"></span>
              <span class="text-sm font-semibold text-gray-700">${assignee}</span>
              <span class="text-xs text-gray-500">(${list.length})</span>
            </div>
          `;
          header.addEventListener('click', () => {
            if (expandedAssignees.has(assignee)) expandedAssignees.delete(assignee);
            else expandedAssignees.add(assignee);
            renderTaskList(rows, filter);
          });
          wrapper.appendChild(header);

          if (expanded) {
            const body = document.createElement('div');
            body.className = 'bg-white';
            list.forEach(item => {
              const row = document.createElement('div');
              row.className = 'px-6 py-2 border-b border-gray-100 hover:bg-blue-50 transition text-sm';
              row.innerHTML = `
                <div class="font-medium text-gray-800">${item.taskName}</div>
                <div class="text-xs text-gray-500 mt-1">${formatDate(item.start)} ‚Üí ${formatDate(item.end)} ¬∑ ${item.points.toFixed(1)}h</div>
              `;
              body.appendChild(row);
            });
            wrapper.appendChild(body);
          }

          taskList.appendChild(wrapper);
        });

        recordCounter.textContent = `${filtered.length} t√°c v·ª•`;
      }

      function renderTable(rows, filter) {
        if (!tableBody) return;
        tableBody.innerHTML = '';
        const filtered = filter === 'all' ? rows : rows.filter(row => row.assignee === filter);
        if (!filtered.length) {
          tableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-3 text-center text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
          return;
        }
        filtered.forEach(row => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-blue-50 transition';
          tr.innerHTML = `
            <td class="px-4 py-3 font-semibold text-blue-600">${row.order}</td>
            <td class="px-4 py-3">${row.assignee}</td>
            <td class="px-4 py-3">${formatDate(row.start)}</td>
            <td class="px-4 py-3">${formatDate(row.end)}</td>
            <td class="px-4 py-3 text-right font-semibold text-slate-700">${row.points.toFixed(2)}h</td>
          `;
          tableBody.appendChild(tr);
        });
      }

      function buildDateRange(segments) {
        if (!segments.length) return [];
        let min = segments[0].start.startOf('day');
        let max = segments[0].end.startOf('day');
        segments.forEach(seg => {
          if (seg.start < min) min = seg.start.startOf('day');
          if (seg.end > max) max = seg.end.startOf('day');
        });
        const days = [];
        let pointer = min;
        while (pointer <= max) {
          days.push(pointer);
          pointer = pointer.plus({ days: 1 });
        }
        return days;
      }

      function getSegmentPosition(segment, dateRange) {
        const firstDay = dateRange[0];
        const startIndex = Math.floor(segment.start.startOf('day').diff(firstDay, 'days').days);
        const endIndex = Math.floor(segment.end.startOf('day').diff(firstDay, 'days').days);

        const normalize = (minutes) => {
          if (minutes <= LUNCH_START) return minutes - DAY_START;
          if (minutes >= LUNCH_END) return MORNING_MINUTES + (minutes - LUNCH_END);
          return MORNING_MINUTES;
        };

        let startMinutes = segment.start.hour * 60 + segment.start.minute;
        let endMinutes = segment.end.hour * 60 + segment.end.minute;
        startMinutes = Math.min(Math.max(startMinutes, DAY_START), DAY_END);
        endMinutes = Math.min(Math.max(endMinutes, DAY_START), DAY_END);

        const startOffset = normalize(startMinutes);
        const endOffset = normalize(endMinutes);
        const dayWidth = 100 / dateRange.length;
        const left = startIndex * dayWidth + (startOffset / WORKDAY_MINUTES) * dayWidth;
        const right = endIndex * dayWidth + (endOffset / WORKDAY_MINUTES) * dayWidth;
        return { left: Math.max(0, left), width: Math.max(0.8, right - left) };
      }

      function renderTimeline(segments, filter) {
        if (!chartWrapper) return;
        // Ch·ªâ hi·ªÉn th·ªã nh·ªØng ng∆∞·ªùi trong danh s√°ch ƒë∆∞·ª£c ph√©p tr√™n map
        let allowedSegments = segments.filter(seg => ALLOWED_MAP_ASSIGNEES.has(seg.assignee));
        const filtered = filter === 'all' ? allowedSegments : allowedSegments.filter(seg => seg.assignee === filter);
        if (!filtered.length) {
          chartWrapper.innerHTML = '<div class="flex items-center justify-center h-full text-sm text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã timeline.</div>';
          legendContainer.innerHTML = '';
          return;
        }

        const dateRange = buildDateRange(filtered);
        const assignees = Array.from(new Set(filtered.map(seg => seg.assignee)));
        chartWrapper.style.height = `${Math.max(320, assignees.length * 90 + 120)}px`;

        legendContainer.innerHTML = assignees.map(name => `
          <span class="flex items-center gap-2 rounded-lg bg-white border border-blue-200 px-3 py-1.5 text-xs font-semibold text-blue-700 shadow-sm">
            <span class="h-3 w-3 rounded-full" style="background-color:${getColor(name)}"></span>${name}
          </span>
        `).join('');

        const now = DateTime.now().setZone(TIME_ZONE);
        let currentIndicator = '';
        if (now >= dateRange[0].startOf('day') && now <= dateRange[dateRange.length - 1].endOf('day')) {
          const normalize = (minutes) => {
            if (minutes <= LUNCH_START) return minutes - DAY_START;
            if (minutes >= LUNCH_END) return MORNING_MINUTES + (minutes - LUNCH_END);
            return MORNING_MINUTES;
          };
          let minutes = now.hour * 60 + now.minute;
          minutes = Math.min(Math.max(minutes, DAY_START), DAY_END);
          const dayIndex = Math.floor(now.startOf('day').diff(dateRange[0], 'days').days);
          const dayWidth = 100 / dateRange.length;
          const offset = dayIndex * dayWidth + (normalize(minutes) / WORKDAY_MINUTES) * dayWidth;
          currentIndicator = `
            <div class="absolute top-0 bottom-0 z-30 pointer-events-none" style="left:${offset}%; width:2px; background-color:#ef4444;">
              <span class="absolute top-full left-1/2 -translate-x-1/2 mt-1 px-1.5 py-0.5 bg-red-500 text-white text-xs font-semibold rounded shadow">${now.toFormat('HH:mm')}</span>
            </div>
          `;
        }

        const header = dateRange.map(day => `
          <div class="flex-1 text-center border-l border-gray-200 px-1">
            <div class="text-sm font-semibold text-gray-800">${day.toFormat('ccc')}</div>
            <div class="text-xs text-gray-500">${day.toFormat('dd/MM')}</div>
          </div>
        `).join('');

        const rowsHtml = assignees.map(name => {
          const segs = filtered.filter(seg => seg.assignee === name);
          const color = getColor(name);
          const total = segs.reduce((sum, seg) => sum + seg.points, 0);
          const bars = segs.map(seg => {
            const pos = getSegmentPosition(seg, dateRange);
            return `
              <div class="absolute top-2 h-8 rounded flex items-center px-2 text-xs font-semibold text-white shadow-sm"
                   style="left:${pos.left}%; width:${pos.width}%; background-color:${color};"
                   title="${seg.taskName} ¬∑ ${formatDate(seg.start)} ‚Üí ${formatDate(seg.end)} (${seg.points.toFixed(1)}h)">
                <span class="truncate">${seg.taskName}</span>
              </div>
            `;
          }).join('');
          return `
            <div class="flex items-center mb-4 min-h-[64px] border-b border-gray-100 pb-4">
              <div class="w-48 flex-shrink-0 pr-5">
                <div class="text-base font-semibold text-gray-800 mb-1">${name}</div>
                <div class="text-xs text-gray-500">${segs.length} t√°c v·ª• ¬∑ ${total.toFixed(1)}h</div>
              </div>
              <div class="flex-1 relative rounded-lg bg-gray-50 border border-gray-200 overflow-hidden min-h-[52px]">
                ${bars}
              </div>
            </div>
          `;
        }).join('');

        chartWrapper.innerHTML = `
          <div class="w-full h-full">
            <div class="flex border-b border-gray-200 mb-5 pb-3 sticky top-0 bg-white z-10 relative">
              <div class="w-48 flex-shrink-0 pr-5">
                <h3 class="text-lg font-semibold text-gray-800">Nh√¢n vi√™n</h3>
              </div>
              <div class="flex-1 flex relative min-w-[${dateRange.length * 120}px]">
                ${header}
                ${currentIndicator}
              </div>
            </div>
            <div>${rowsHtml}</div>
            <div class="flex mt-4 pt-3 border-t border-gray-200">
              <div class="w-48 flex-shrink-0 pr-5">
                <div class="text-xs text-gray-500">Khung th·ªùi gian</div>
              </div>
              <div class="flex-1 flex justify-between text-xs text-gray-500 min-w-[${dateRange.length * 120}px] px-1">
                <span>08:00</span>
                <span>12:30</span>
                <span>13:30</span>
                <span>17:00</span>
              </div>
            </div>
          </div>
        `;
      }

      function refreshView() {
        const filter = assigneeFilter ? assigneeFilter.value : 'all';
        renderTaskList(scheduleRows, filter);
        renderTable(scheduleRows, filter);
        renderTimeline(timelineSegments, filter);
      }

      async function loadData() {
        if (statusText) statusText.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu...';
        try {
          const resp = await fetch(SCHEDULE_DATA_ENDPOINT);
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const raw = await resp.json();
          let flattened = [];
          if (Array.isArray(raw)) {
            raw.forEach(item => {
              if (item && Array.isArray(item.tasks)) {
                item.tasks.forEach(task => {
                  flattened.push({
                    assignee: task.assignee || item.assignee,
                    task_code: task.task_code || '',
                    task_name: task.task_name || '',
                    start_time: task.start_time || '',
                    end_time: task.end_time || '',
                    points: task.work_points || task.points || task.hours || 0
                  });
                });
              } else {
                flattened.push(item);
              }
            });
          } else if (Array.isArray(raw?.data)) {
            flattened = raw.data;
          }

          const { rows, segments } = buildSchedule(flattened);
          scheduleRows = rows;
          timelineSegments = segments;
          populateFilterOptions(rows);
          if (assigneeFilter) assigneeFilter.value = 'all';
          refreshView();
          if (statusText) statusText.textContent = `ƒê√£ t·∫£i ${flattened.length} t√°c v·ª•`;
        } catch (err) {
          console.error('L·ªói t·∫£i Form 4:', err);
          if (statusText) statusText.textContent = `L·ªói: ${err.message || err}`;
        }
      }

      if (reloadButton) reloadButton.addEventListener('click', loadData);
      if (assigneeFilter) assigneeFilter.addEventListener('change', refreshView);
      if (closeDetailBtn && detailSection) {
        closeDetailBtn.addEventListener('click', () => detailSection.classList.add('hidden'));
      }

      form4Reload = loadData;
      loadData();
    }

    // Task tracking table: fetch data from endpoint and render
    {
      const taskTrackingForm = document.getElementById('taskTrackingForm');
      const taskTrackingSearchBtn = document.getElementById('taskTrackingSearchBtn');
      const trackingTableBody = document.getElementById('trackingTableBody');
      const ttMonth = document.getElementById('tt-month');
      const ttFilterOff = document.getElementById('tt-filter-off');
      
      let trackingData = [];
      let currentMonthFilter = null;

      // NgƒÉn form submit m·∫∑c ƒë·ªãnh (refresh trang)
      if (taskTrackingForm) {
        taskTrackingForm.addEventListener('submit', (e) => {
          e.preventDefault();
          handleTaskTrackingSearch();
        });
      }

      // X·ª≠ l√Ω t√¨m ki·∫øm
      async function handleTaskTrackingSearch() {
        if (!taskTrackingForm) return;
        
        const formData = new FormData(taskTrackingForm);
        const senderEmail = formData.get('senderEmail')?.trim() || '';
        const department = formData.get('department')?.trim() || '';

        // Validate: ph·∫£i c√≥ √≠t nh·∫•t m·ªôt tr∆∞·ªùng
        if (!senderEmail && !department) {
          alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt trong hai tr∆∞·ªùng: Email ng∆∞·ªùi g·ª≠i ho·∫∑c Ph√≤ng ban y√™u c·∫ßu');
          return;
        }

        // Hi·ªÉn th·ªã loading
        if (taskTrackingSearchBtn) {
          taskTrackingSearchBtn.disabled = true;
          taskTrackingSearchBtn.textContent = '‚è≥ ƒêang t√¨m ki·∫øm...';
        }
        if (trackingTableBody) {
          trackingTableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-gray-500 text-base">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
        }

        try {
          // G·ªçi qua webhook ƒë·ªÉ tr√°nh CORS - webhook s·∫Ω proxy request ƒë·∫øn API
          const payload = {
            action: 'getRecords',
            viewId: TASK_TRACKING_VIEW_ID,
            offset: 0,
            limit: 1000,
            token: TASK_TRACKING_TOKEN,
            apiEndpoint: TASK_TRACKING_API_ENDPOINT
          };

          console.log('Fetching via webhook:', TASK_TRACKING_WEBHOOK);

          // G·ªçi webhook v·ªõi POST (gi·ªëng c√°c endpoint kh√°c)
          const resp = await fetch(TASK_TRACKING_WEBHOOK, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(payload)
          }).catch(networkErr => {
            // X·ª≠ l√Ω l·ªói network c·ª• th·ªÉ
            console.error('Network error:', networkErr);
            throw new Error(`L·ªói k·∫øt n·ªëi: ${networkErr.message}. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.`);
          });

          if (!resp.ok) {
            const errorText = await resp.text();
            console.error('Webhook Error:', resp.status, errorText);
            throw new Error(`HTTP ${resp.status}: ${errorText || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`);
          }

          // Parse response
          const json = await resp.json().catch(parseErr => {
            console.error('Parse error:', parseErr);
            throw new Error('L·ªói ph√¢n t√≠ch d·ªØ li·ªáu t·ª´ server');
          });

          // X·ª≠ l√Ω response t·ª´ webhook (webhook s·∫Ω tr·∫£ v·ªÅ d·ªØ li·ªáu t·ª´ API)
          let records = [];
          // Webhook c√≥ th·ªÉ tr·∫£ v·ªÅ d·ªØ li·ªáu tr·ª±c ti·∫øp ho·∫∑c wrap trong object
          if (Array.isArray(json?.list)) {
            records = json.list;
          } else if (Array.isArray(json?.data)) {
            records = json.data;
          } else if (Array.isArray(json?.rows)) {
            records = json.rows;
          } else if (Array.isArray(json)) {
            records = json;
          } else if (json && typeof json === 'object') {
            // N·∫øu webhook tr·∫£ v·ªÅ object, th·ª≠ l·∫•y c√°c tr∆∞·ªùng ph·ªï bi·∫øn
            if (json.result && Array.isArray(json.result)) {
              records = json.result;
            } else if (json.records && Array.isArray(json.records)) {
              records = json.records;
            } else {
              // N·∫øu l√† object ƒë∆°n, chuy·ªÉn th√†nh array
              records = [json];
            }
          }

          // L·ªçc th√™m theo email v√† department n·∫øu c·∫ßn (fallback n·∫øu where clause kh√¥ng ho·∫°t ƒë·ªông)
          if (senderEmail || department) {
            records = records.filter(item => {
              const itemEmail = item['Ng∆∞·ªùi y√™u c·∫ßu'] || '';
              const itemDept = item['Ph√≤ng ban y√™u c·∫ßu'] || '';
              
              let matchEmail = !senderEmail || itemEmail.toLowerCase().includes(senderEmail.toLowerCase());
              let matchDept = !department || itemDept === department;
              
              return matchEmail && matchDept;
            });
          }

          trackingData = records;
          renderTrackingTable();

        } catch (err) {
          console.error('L·ªói t√¨m ki·∫øm c√¥ng vi·ªác:', err);
          let errorMsg = 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
          if (err.message) {
            errorMsg = err.message;
          } else if (typeof err === 'string') {
            errorMsg = err;
          }
          
          if (trackingTableBody) {
            trackingTableBody.innerHTML = `
              <tr>
                <td colspan="8" class="px-6 py-8 text-center text-red-500 text-base">
                  <div class="space-y-2">
                    <div class="font-semibold">L·ªói: ${errorMsg}</div>
                    <div class="text-xs text-gray-500 mt-2">
                      Vui l√≤ng ki·ªÉm tra:<br/>
                      - K·∫øt n·ªëi m·∫°ng<br/>
                      - Token API c√≥ h·ª£p l·ªá<br/>
                      - Console ƒë·ªÉ xem chi ti·∫øt l·ªói (F12)
                    </div>
                  </div>
                </td>
              </tr>
            `;
          }
        } finally {
          if (taskTrackingSearchBtn) {
            taskTrackingSearchBtn.disabled = false;
            taskTrackingSearchBtn.textContent = 'üîç T√¨m ki·∫øm';
          }
        }
      }

      // Render b·∫£ng tracking
      function renderTrackingTable() {
        if (!trackingTableBody) return;

        let filteredData = [...trackingData];

        // √Åp d·ª•ng b·ªô l·ªçc th√°ng n·∫øu c√≥
        if (currentMonthFilter) {
          const [year, month] = currentMonthFilter.split('-').map(Number);
          filteredData = filteredData.filter(item => {
            const dateStr = item['Ng√†y y√™u c·∫ßu'] || '';
            if (!dateStr) return false;
            const date = new Date(dateStr);
            return date.getFullYear() === year && (date.getMonth() + 1) === month;
          });
        }

        if (filteredData.length === 0) {
          trackingTableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-gray-500 text-base">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu.</td></tr>';
          return;
        }

        // Map c√°c tr∆∞·ªùng t·ª´ response (h·ªó tr·ª£ nhi·ªÅu format)
        const getField = (item, keys) => {
          for (const key of keys) {
            if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
              return item[key];
            }
          }
          return '';
        };

        const formatDate = (dateStr) => {
          if (!dateStr) return '';
          try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            return date.toLocaleDateString('vi-VN', { 
              year: 'numeric', 
              month: '2-digit', 
              day: '2-digit' 
            });
          } catch {
            return dateStr;
          }
        };

        const getStatusBadge = (status) => {
          const statusStr = String(status || '').toLowerCase();
          if (statusStr.includes('ho√†n th√†nh') || statusStr.includes('done') || statusStr.includes('complete')) {
            return '<span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">Ho√†n th√†nh</span>';
          } else if (statusStr.includes('ƒëang') || statusStr.includes('in progress') || statusStr.includes('processing')) {
            return '<span class="px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">ƒêang x·ª≠ l√Ω</span>';
          } else if (statusStr.includes('h·ªßy') || statusStr.includes('cancel')) {
            return '<span class="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">H·ªßy</span>';
          }
          return `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800">${status || 'Ch∆∞a x√°c ƒë·ªãnh'}</span>`;
        };

        trackingTableBody.innerHTML = filteredData.map((item, idx) => {
          // Map theo mapping m·ªõi t·ª´ user
          const assigner = item['Ng∆∞·ªùi y√™u c·∫ßu'] || '';
          const submissionDate = item['Ng√†y y√™u c·∫ßu'] || '';
          const desiredDueDate = item['H·∫°n mong mu·ªën'] || '';
          const completionDate = item['H·∫°n ƒë√°p ·ª©ng'] || '';
          const taskName = item['Ng√†y ho√†n th√†nh theo c√¥ng chu·∫©n'] || '';
          const pic = item['Assignee'] || '';
          const status = item['K·∫øt qu·∫£'] || '';
          const reportCode = item['M√£ B√°o c√°o'] || '';

          return `
            <tr class="hover:bg-gray-50 transition">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${assigner || '-'}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(submissionDate)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(desiredDueDate)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(completionDate)}</td>
              <td class="px-6 py-4 text-sm text-gray-900">${taskName || '-'}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${pic || '-'}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">${getStatusBadge(status)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">${reportCode || '-'}</td>
            </tr>
          `;
        }).join('');
      }

      // X·ª≠ l√Ω b·ªô l·ªçc th√°ng
      if (ttMonth) {
        ttMonth.addEventListener('change', (e) => {
          currentMonthFilter = e.target.value || null;
          renderTrackingTable();
        });
      }

      // N√∫t t·∫Øt b·ªô l·ªçc
      if (ttFilterOff) {
        ttFilterOff.addEventListener('click', () => {
          if (ttMonth) ttMonth.value = '';
          currentMonthFilter = null;
          renderTrackingTable();
        });
      }
    }
  </script>
</body>
</html>













