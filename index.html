<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>H·ªá th·ªëng Phi·∫øu Y√™u C·∫ßu DQA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': '#3b82f6',
            'sidebar': '#0f172a',
            'sidebar-hover': '#1e293b',
            'muted': '#f8fafc',
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .spinner {
      border: 2px solid #e5e7eb;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }

    /* Header and section styling to match index.html */
    .header-container {
      background: linear-gradient(135deg, #2563eb 0%, #60a5fa 100%);
      position: relative;
      overflow: hidden;
    }
    .header-container::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");
      opacity: 0.4;
    }
    .header-badge {
      background-color: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    .header-line { width: 60px; height: 4px; background: linear-gradient(90deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.2) 100%); border-radius: 2px; }

    .form-section { border: 1px solid #e5e7eb; border-radius: 12px; transition: box-shadow 0.2s ease; }
    .form-section:hover { box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06); }

    .submit-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1), 0 1px 3px rgba(37, 99, 235, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease, filter 0.2s ease;
      border-radius: 9999px;
      position: relative;
    }
    .submit-btn:hover { transform: translateY(-1px); box-shadow: 0 7px 14px rgba(37, 99, 235, 0.12), 0 3px 6px rgba(37, 99, 235, 0.08); filter: brightness(1.03); }
    .submit-btn:active { transform: translateY(0); opacity: 0.95; }
    /* Section cards for Form 1 */
    .section-card { border: 1px solid transparent; border-radius: 12px; padding: 16px; }
    .section-a { background: #eff6ff; border-color: #bfdbfe; }
    .section-b { background: #ecfdf5; border-color: #a7f3d0; }
    .section-c { background: #fffbeb; border-color: #fde68a; }
    .section-d { background: #faf5ff; border-color: #e9d5ff; }
  </style>
</head>
<body class="bg-muted min-h-screen flex text-gray-800" style="font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'">
<!-- Sidebar -->
  <aside class="w-56 min-h-screen bg-sidebar text-white flex flex-col py-8 px-4 shadow-lg">
    <h1 class="text-xl font-bold tracking-wide pb-6 border-b border-blue-200 mb-4">C·ªïng T√°c V·ª• DQA</h1>
    <nav class="flex flex-col gap-2 mt-2">
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="testRequest">Phi·∫øu Y√™u C·∫ßu Th·ª≠ Nghi·ªám</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="taskTracking">Theo d√µi C√¥ng vi·ªác</button>
      
    </nav>
  </aside>
  <!-- Form Sections -->
  <main class="flex-1 py-12 flex flex-col items-center justify-center min-h-screen overflow-y-auto">
    <div class="header-container relative w-full max-w-5xl rounded-xl overflow-hidden mb-8">
      <div class="relative z-10 p-8 md:p-10">
        <div class="flex items-center space-x-2 mb-3">
          <div class="inline-block header-badge px-3 py-1 rounded-full text-xs font-semibold text-white">Ph√≤ng DQA</div>
          <div class="header-line hidden md:block"></div>
        </div>
        <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold text-white mb-1 tracking-tight">C·ªïng Y√™u C·∫ßu DQA</h2>
        <p class="text-blue-100 text-sm md:text-base">T·ªïng h·ª£p phi·∫øu th·ª≠ nghi·ªám v√† ti·∫øn ƒë·ªô c√¥ng vi·ªác</p>
      </div>
    </div>
    <!-- Test Request Form -->
    <section id="testRequest" class="form-section w-full max-w-4xl bg-white p-8 rounded-lg shadow-md hidden">
      <div class="mb-8">
        <h2 class="text-3xl font-extrabold text-primary-blue tracking-wide mb-1">Phi·∫øu Y√™u C·∫ßu Th·ª≠ Nghi·ªám</h2>
        <div class="h-1 w-16 bg-primary-blue mb-2 rounded"></div>
        <p class="text-base text-gray-500">Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c m·ª•c b·∫Øt bu·ªôc cho s·∫£n ph·∫©m/linh ki·ªán c·∫ßn th·ª≠ nghi·ªám. Bi·ªÉu m·∫´u s·∫Ω t·ª± ƒë·ªông thay ƒë·ªïi theo l·ª±a ch·ªçn c·ªßa b·∫°n.</p>
      </div>
      <form id="testRequestForm" class="space-y-6" autocomplete="off">
        <!-- A. General Information -->
        <div class="section-card section-a">
          <h3 class="text-lg font-semibold text-primary-blue mb-2">A. Th√¥ng tin chung</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input required name="senderName" type="text" placeholder="H·ªç t√™n ng∆∞·ªùi g·ª≠i *" class="input-field"/>
            <input required name="senderEmail" type="email" placeholder="Email *" class="input-field"/>
            <input name="requestDate" type="datetime-local" class="input-field" readonly id="testRequestDate"/>
            <select required name="department" class="input-field">
              <option value="">Ph√≤ng ban y√™u c·∫ßu *</option>
             <option>Mua h√†ng</option><option>SC</option><option>SC2</option><option>KTSX</option><option>KTSP</option>
              <option>TKCK</option><option>KTCN</option><option>NCTN</option><option>TKƒêT</option>
              <option>QA/QC nh√† m√°y</option><option>DQA</option>
            </select>
          </div>
        </div>
        <!-- B. Product/Component Information -->
        <div class="section-card section-b">
          <h3 class="text-lg font-semibold text-primary-blue mb-2">B. Th√¥ng tin s·∫£n ph·∫©m/linh ki·ªán</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input required name="productName" type="text" placeholder="T√™n s·∫£n ph·∫©m/linh ki·ªán *" class="input-field"/>
            <input required name="productCode" type="text" placeholder="M√£ s·∫£n ph·∫©m/linh ki·ªán *" class="input-field"/>
            <input name="sampleSubmissionNo" id="sampleSubmissionNo" type="number" min="1" placeholder="L·∫ßn g·ª≠i m·∫´u " class="input-field"/>
            <div id="testRequestChangeNote" class="hidden md:col-span-2">
              <input type="text" name="changeFromLastNote" placeholder="M√¥ t·∫£ thay ƒë·ªïi so v·ªõi l·∫ßn tr∆∞·ªõc" class="input-field"/>
            </div>
            <select required name="requestPurpose" id="requestPurpose" class="input-field md:col-span-2">
              <option value="">M·ª•c ƒë√≠ch y√™u c·∫ßu *</option>
              <option value="ƒê√°nh gi√° SP m·ªõi">ƒê√°nh gi√° SP m·ªõi</option>
              <option value="ƒê√°nh gi√° thay ƒë·ªïi nh√† cung c·∫•p">ƒê√°nh gi√° thay ƒë·ªïi nh√† cung c·∫•p</option>
              <option value="ƒê√°nh gi√° thay ƒë·ªïi 4M">ƒê√°nh gi√° thay ƒë·ªïi 4M</option>
              <option value="Ph·∫£n h·ªìi l·ªói th·ªã tr∆∞·ªùng">Ph·∫£n h·ªìi l·ªói th·ªã tr∆∞·ªùng</option>
              <option value="Ki·ªÉm tra ƒë·ªãnh k·ª≥ n·ªôi b·ªô">Ki·ªÉm tra ƒë·ªãnh k·ª≥ n·ªôi b·ªô</option>
              <option value="ƒê√°nh gi√° ƒë·ªÅ xu·∫•t c·∫£i ti·∫øn">ƒê√°nh gi√° ƒë·ªÅ xu·∫•t c·∫£i ti·∫øn</option>
              <option value="Ph·ªëi h·ª£p nghi√™n c·ª©u c√¥ng ngh·ªá">Ph·ªëi h·ª£p nghi√™n c·ª©u c√¥ng ngh·ªá</option>
              <option value="Y√™u c·∫ßu t·ª´ kh√°ch h√†ng/b√™n th·ª© 3">Y√™u c·∫ßu t·ª´ kh√°ch h√†ng/b√™n th·ª© 3</option>
            </select>
            <div id="purposeDescription" class="text-gray-600 text-sm md:col-span-2"></div>
            <input name="supplier" required type="text" placeholder="Nh√† cung c·∫•p *" class="input-field"/>
            <input name="numSamples" type="number" min="0" placeholder="S·ªë l∆∞·ª£ng m·∫´u giao *" required class="input-field"/>
            <input name="desiredCompletionDate" type="date" placeholder="Th·ªùi h·∫°n mong mu·ªën c√≥ k·∫øt qu·∫£ *" required class="input-field"/>
            <select name="personReceived" required class="input-field">
              <option value="">Ch·ªçn ng∆∞·ªùi ƒë√£ nh·∫≠n m·∫´u *</option>
              <option>V≈© Duy Minh</option>
              <option>Nguy·ªÖn VƒÉn Linh</option>
              <option>Nguy·ªÖn VƒÉn Hi·∫øu</option>
              <option>ƒê√†o Ho√†ng D∆∞∆°ng</option>
            </select>
            <textarea name="notes" rows="2" placeholder="Ghi ch√∫ (ƒêi·ªÉm thay ƒë·ªïi, l√Ω do y√™u c·∫ßu g·∫•p...)" class="input-field md:col-span-2"></textarea>
          </div>
        </div>
        <!-- C. Required Testing Information -->
        <div class="section-card section-c">
          <h3 class="text-lg font-semibold text-primary-blue mb-2">C. Th√¥ng tin th·ª≠ nghi·ªám y√™u c·∫ßu</h3>
          <div class="flex items-center gap-8 pb-2">
            <label class="flex items-center"><input type="radio" class="mr-2" name="testType" value="standard" checked>Ki·ªÉm tra m·∫∑c ƒë·ªãnh theo ti√™u chu·∫©n k·ªπ thu·∫≠t</label>
            <label class="flex items-center"><input type="radio" class="mr-2" name="testType" value="special">Ki·ªÉm tra ƒë·∫∑c bi·ªát theo y√™u c·∫ßu</label>
          </div>
          <div id="specialTestFields" class="hidden pb-2 border border-primary-blue rounded p-4 bg-blue-50">
            <label for="specialRequestDesc" class="block text-sm text-gray-700 mb-2">M√¥ t·∫£ ki·ªÉm tra ƒë·∫∑c bi·ªát <span class="text-red-600">*</span></label>
            <input type="text" id="specialRequestDesc" name="specialRequestDesc" class="input-field" placeholder="M√¥ t·∫£ chi ti·∫øt h·∫°ng m·ª•c ki·ªÉm tra, ti√™u chu·∫©n √°p d·ª•ng..." required disabled />
          </div>
        </div>
        <!-- D. Attachments -->
        <div class="section-card section-d">
          <h3 class="text-lg font-semibold text-primary-blue mb-2">D. T√†i li·ªáu ƒë√≠nh k√®m</h3>
          <input multiple type="file" id="testRequestFiles" class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-primary-blue file:text-white"/>
          <div id="testRequestUploadList" class="mt-2 flex flex-col gap-2"></div>
          <p class="mt-2 text-xs text-gray-500">T√™n file PH·∫¢I b·∫±ng ch·ªØ v√† s·ªë, kh√¥ng s·ª≠ d·ª•ng k√Ω t·ª± ƒë·∫∑c bi·ªát ƒë·ªÉ tr√°nh l·ªói.</p>
        </div>
        <!-- Keep data after submit -->
        <label class="mt-3 flex items-center text-sm text-gray-600">
          <input type="checkbox" id="keepDataAfterSubmit" class="mr-2">
          Gi·ªØ d·ªØ li·ªáu sau khi g·ª≠i
        </label>
        <button type="submit" class="submit-btn w-full mt-4 py-3 text-white font-semibold text-lg transition flex items-center justify-center gap-2">
          <span>G·ª≠i y√™u c·∫ßu</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        </button>
      </form>
    </section>
    <!-- Task Tracking -->
    <section id="taskTracking" class="form-section w-full max-w-6xl bg-white p-8 rounded-lg shadow-md hidden">
      <div class="mb-8">
        <h2 class="text-3xl font-extrabold text-primary-blue tracking-wide mb-1">Theo d√µi C√¥ng vi·ªác</h2>
        <div class="h-1 w-16 bg-primary-blue mb-2 rounded"></div>
        <p class="text-base text-gray-500">Theo d√µi c√°c c√¥ng vi·ªác ƒë√£ g·ª≠i k√®m tr·∫°ng th√°i v√† th·ªùi h·∫°n ƒë√°p ·ª©ng.</p>
      </div>
      <form id="taskTrackingForm" class="mb-8 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input required name="senderEmail" type="email" placeholder="Email ng∆∞·ªùi g·ª≠i *" class="input-field"/>
          <select required name="department" class="input-field">
            <option value="">Ph√≤ng ban y√™u c·∫ßu *</option>
             <option>Mua h√†ng</option><option>SC</option><option>SC2</option><option>KTSX</option><option>KTSP</option>
            <option>TKCK</option><option>KTCN</option><option>NCTN</option><option>TKƒêT</option>
            <option>QA/QC nh√† m√°y</option><option>DQA</option>
          </select>
        </div>
        <!-- Response field mapping params (backend can use these to shape response) -->
        <div class="hidden">
          <input type="hidden" name="resp_ngay_gui" value="submissionDate" />
          <input type="hidden" name="resp_ten_cong_viec" value="task-name" />
          <input type="hidden" name="resp_han_mong_muon" value="desiredDueDate" />
          <input type="hidden" name="resp_ngay_hoan_thanh" value="completionDate" />
          <input type="hidden" name="resp_phu_trach" value="pic" />
          <input type="hidden" name="resp_trang_thai" value="status" />
        </div>
        <div class="flex justify-end">
          <button id="taskTrackingSearchBtn" type="submit" class="submit-btn px-4 py-2 rounded text-white font-bold transition">T√¨m ki·∫øm</button>
        </div>
      </form>
      <div class="overflow-x-auto shadow rounded-lg">
        <table id="trackingTable" class="min-w-full text-sm border-collapse">
          <thead>
            <tr class="bg-primary-blue text-white">
              <th class="px-4 py-2 text-left">Ng√†y g·ª≠i</th>
              <th class="px-4 py-2 text-left">H·∫°n mong mu·ªën</th>
              <th class="px-4 py-2 text-left">H·∫°n ƒë√°p ·ª©ng</th>
              <th class="px-4 py-2 text-left">T√™n c√¥ng vi·ªác</th>
              <th class="px-4 py-2 text-left">Ph·ª• tr√°ch</th>
              <th class="px-4 py-2 text-left">Tr·∫°ng th√°i</th>
            </tr>
          </thead>
          <tbody id="trackingTableBody" class="bg-white text-gray-900">
            <tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">Nh·∫•n T√¨m ki·∫øm ƒë·ªÉ t·∫£i tr·∫°ng th√°i c√¥ng vi·ªác.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
    
  </main>
  <!-- Common Styles -->
  <style>
    .input-field {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #93c5fd; /* blue-300 */
      border-radius: 0.5rem; /* rounded */
      background-color: #f1f5f9; /* muted */
      transition: box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
      outline: none;
    }
    .input-field:focus {
      border-color: #3b82f6; /* primary-blue */
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* ring-blue-200 */
      background-color: #ffffff;
    }
    .input-field::placeholder {
      color: #9ca3af; /* gray-400 */
    }
    .input-field:read-only {
      background: #e5e7eb; /* gray-200 */
      color: #6b7280; /* gray-500 */
    }
  </style>
  <!-- JavaScript for dynamic logic/features -->
  <script>
    // Endpoints for Form 1 (Test Request)
    const SHEETDB_API_URL = "https://sheetdb.io/api/v1/n9g1hj5bhqymg";
    const UPLOAD_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCijAALPkXShSLSUELoVhtEGDGMUwe4ZPl_jqE-xi7le_WGN5s0IOv0o5FVYpZaNmc/exec";
    // Sidebar navigation logic
    const navBtns = document.querySelectorAll('.nav-btn');
    const formSections = document.querySelectorAll('.form-section');
    function showSection(id) {
      formSections.forEach(sec => sec.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }
    navBtns.forEach(btn => {
      btn.onclick = () => {
        navBtns.forEach(b => b.classList.remove('bg-primary-blue', 'font-bold'));
        btn.classList.add('bg-primary-blue', 'font-bold');
        showSection(btn.getAttribute('data-target'));
      };
    });
    // Show first form by default
    navBtns[0].classList.add('bg-primary-blue', 'font-bold');
    showSection(navBtns[0].getAttribute('data-target'));

    // Set default current local date+time for date fields on load
    function setCurrentDateTime(id) {
      const dt = new Date();
      const tzOffsetMs = dt.getTimezoneOffset() * 60000;
      const localISO = new Date(dt.getTime() - tzOffsetMs).toISOString().slice(0, 16);
      const el = document.getElementById(id);
      if (el) el.value = localISO;
    }
    setCurrentDateTime('testRequestDate');

    // Dynamic fields logic for Test Request Form
    // a. Purpose dropdown description
    const purposeDescriptions = {
      "ƒê√°nh gi√° SP m·ªõi": "S·∫£n ph·∫©m/linh ki·ªán m·ªõi s·∫Øp SOP, c·∫ßn ki·ªÉm tra ƒë·ªô b·ªÅn v√† ph√π h·ª£p ti√™u chu·∫©n k·ªπ thu·∫≠t tr∆∞·ªõc khi s·∫£n xu·∫•t ƒë·∫°i tr√†.",
      "ƒê√°nh gi√° thay ƒë·ªïi nh√† cung c·∫•p": "Linh ki·ªán/s·∫£n ph·∫©m thay ƒë·ªïi nh√† cung c·∫•p; c·∫ßn ki·ªÉm tra l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng kh√¥ng b·ªã ·∫£nh h∆∞·ªüng.",
      "ƒê√°nh gi√° thay ƒë·ªïi 4M": "C√≥ thay ƒë·ªïi v·ªÅ V·∫≠t li·ªáu, M√°y m√≥c, Ph∆∞∆°ng ph√°p, Nh√¢n s·ª±; c·∫ßn ƒë√°nh gi√° r·ªßi ro li√™n quan.",
      "Ph·∫£n h·ªìi l·ªói th·ªã tr∆∞·ªùng": "S·∫£n ph·∫©m ƒëang s·ª≠ d·ª•ng ph√°t sinh khi·∫øu n·∫°i/l·ªói t·ª´ th·ªã tr∆∞·ªùng; ki·ªÉm tra l·∫°i ƒë·ªÉ x√°c ƒë·ªãnh nguy√™n nh√¢n.",
      "Ki·ªÉm tra ƒë·ªãnh k·ª≥ n·ªôi b·ªô": "Th·ª≠ nghi·ªám theo k·∫ø ho·∫°ch n·ªôi b·ªô (QA, MKT, ki·ªÉm ƒë·ªãnh/hi·ªáu chu·∫©n thi·∫øt b·ªã ƒë·ªãnh k·ª≥).",
      "ƒê√°nh gi√° ƒë·ªÅ xu·∫•t c·∫£i ti·∫øn": "ƒê·ªÅ xu·∫•t c·∫£i ti·∫øn v·ªÅ thi·∫øt k·∫ø/c·∫•u tr√∫c/chi ph√≠; c·∫ßn x√°c nh·∫≠n b·∫±ng th·ª≠ nghi·ªám.",
      "Ph·ªëi h·ª£p nghi√™n c·ª©u c√¥ng ngh·ªá": "Ki·ªÉm tra ƒë·∫∑c t√≠nh/t√≠nh nƒÉng k·ªπ thu·∫≠t trong qu√° tr√¨nh nghi√™n c·ª©u, ph·ªëi h·ª£p ph√°t tri·ªÉn c√¥ng ngh·ªá m·ªõi.",
      "Y√™u c·∫ßu t·ª´ kh√°ch h√†ng/b√™n th·ª© 3": "Y√™u c·∫ßu x√°c nh·∫≠n k·ªπ thu·∫≠t theo ti√™u chu·∫©n ri√™ng c·ªßa kh√°ch h√†ng/ƒë·ªëi t√°c/b√™n th·ª© ba.",
    };
    document.getElementById('requestPurpose').onchange = (e)=>{
      const desc = purposeDescriptions[e.target.value] || "";
      document.getElementById('purposeDescription').textContent = desc;
    };
    // b. Sample submission number
    document.getElementById('sampleSubmissionNo').oninput = (e)=>{
      document.getElementById('testRequestChangeNote').classList.toggle('hidden', e.target.value < 2);
    };

    // c. Special test toggle: show single required input when selected
    document.querySelectorAll('input[name="testType"]').forEach(radio=>{
      radio.onchange = ()=>{
        const container = document.getElementById('specialTestFields');
        const input = document.getElementById('specialRequestDesc');
        const show = radio.value === 'special' && radio.checked;
        container.classList.toggle('hidden', !show);
        if (input) input.disabled = !show;
      };
    });

    // File upload widget logic (for all file fields)
    function uploadFiles(inputId, uploadListId, endpoint, cb) {
      const fileInput = document.getElementById(inputId);
      const uploadList = document.getElementById(uploadListId);
      let filesArr = [];
      function getIcon(ext=""){ return "üìÑ"; }

      fileInput.addEventListener("change", async function(){
        for(const file of fileInput.files){
          const idx = filesArr.length;
          filesArr.push({ file, state: "uploading", link: null });
          const itemDiv = document.createElement('div');
          itemDiv.className = "flex items-center justify-between p-2 bg-blue-50 rounded";
          itemDiv.innerHTML = `
            <span>${getIcon(file.name.split('.').pop())}<span class="ml-2">${file.name}</span></span>
            <span class="spinner"></span>
            <button class="ml-4 text-red-600 hover:underline font-bold hidden" type="button">X</button>
          `;
          uploadList.appendChild(itemDiv);

          // Start uploading
          const reader = new FileReader();
          reader.onload = async function(e){
            // Send base64 to endpoint
            const payload = {
              filedata: e.target.result.split(",")[1],
              filename: file.name,
              mimetype: file.type
            };
            fetch(endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ data: [payload] })
            })
            .then(r => r.json()) // assume the API returns a JSON containing the public link
            .then(data => {
              // For demo, just fake the link
              const link = data.public_url || (data.data && data.data[0]?.url) || "#";
              filesArr[idx].state = "done";
              filesArr[idx].link = link;
              itemDiv.querySelector(".spinner").outerHTML = `<a href="${link}" target="_blank" class="text-primary-blue underline">Xem</a>`;
              itemDiv.querySelector('button').classList.remove("hidden");
              cb && cb(filesArr.map(u=>u.link));
            })
            .catch(err=>{
              itemDiv.querySelector(".spinner").outerHTML = `<span class="text-red-500">Th·∫•t b·∫°i</span>`;
              cb && cb(filesArr.map(u=>u.link));
            });
          };
          reader.readAsDataURL(file);

          // Delete logic
          itemDiv.querySelector("button").onclick = ()=>{
            itemDiv.remove();
            filesArr[idx]=null;
            cb && cb(filesArr.filter(Boolean).map(u=>u.link));
          };
        }
        // Reset input
        fileInput.value = "";
      });
      return ()=>filesArr.filter(Boolean).map(u=>({
        file: u.file,
        link: u.link
      }));
    }

    // Use upload widgets on each form
    let testRequestUploads = [];
    // Specialized uploader for Form 1 using Google Apps Script
    (function setupTestRequestUploads(){
      const fileInput = document.getElementById('testRequestFiles');
      const uploadList = document.getElementById('testRequestUploadList');
      testRequestUploads = [];
      function renderItem(name, url){
        const itemDiv = document.createElement('div');
        itemDiv.className = "flex items-center justify-between p-2 bg-blue-50 rounded";
        itemDiv.innerHTML = `
          <span>üìÑ<span class="ml-2">${name}</span></span>
          <a href="${url}" target="_blank" class="text-primary-blue underline">Xem</a>
          <button class="ml-4 text-red-600 hover:underline font-bold" type="button">X</button>
        `;
        const idx = testRequestUploads.length;
        testRequestUploads.push({ name, url });
        itemDiv.querySelector('button').onclick = ()=>{
          itemDiv.remove();
          testRequestUploads[idx] = null;
        };
        uploadList.appendChild(itemDiv);
      }
      fileInput.addEventListener('change', async function(){
        if (!this.files || this.files.length === 0) return;
        for (const file of this.files){
          const itemDiv = document.createElement('div');
          itemDiv.className = "flex items-center justify-between p-2 bg-blue-50 rounded";
          itemDiv.innerHTML = `
            <span>üìÑ<span class=\"ml-2\">${file.name}</span></span>
            <span class=\"spinner\"></span>
          `;
          uploadList.appendChild(itemDiv);
          try{
            const reader = new FileReader();
            const url = await new Promise((resolve, reject)=>{
              reader.onload = async ()=>{
                try{
                  const base64 = reader.result.split(',')[1];
                  const form = new URLSearchParams();
                  form.append('filedata', base64);
                  form.append('filename', file.name);
                  form.append('mimetype', file.type);
                  const resp = await fetch(UPLOAD_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: form.toString()
                  });
                  if(!resp.ok) throw new Error('Upload failed');
                  const urlText = await resp.text();
                  resolve(urlText);
                }catch(err){ reject(err); }
              };
              reader.onerror = ()=>reject(new Error('File read error'));
              reader.readAsDataURL(file);
            });
            uploadList.removeChild(itemDiv);
            renderItem(file.name, url);
          }catch(err){
            itemDiv.querySelector('.spinner').outerHTML = `<span class=\"text-red-600\">Th·∫•t b·∫°i</span>`;
            setTimeout(()=>{ try{ uploadList.removeChild(itemDiv);}catch(_){} }, 2000);
          }
        }
        this.value = '';
      });
    })();
    // internal forms moved to DQA_internal.html

    // Form submit logic (for main forms)
    function toJSON(form){
      const d = {};
      new FormData(form).forEach((val,key)=>{
        if(d[key])
          d[key] = [].concat(d[key],val);
        else
          d[key]=val;
      });
      return d;
    }
    function submitForm(formId, endpoint, getUploads){
      document.getElementById(formId).onsubmit = async function(e){
        e.preventDefault();
        // Confirmation popup for Form 1 before sending
        if (formId === 'testRequestForm') {
          const confirmed = window.confirm('B·∫±ng vi·ªác x√°c nh·∫≠n g·ª≠i y√™u c·∫ßu, b·∫°n cam k·∫øt m·∫´u ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë√∫ng v√† ƒë·ªß ƒë·∫øn DQA.');
          if (!confirmed) return;
        }
        const btn = this.querySelector("button[type=submit]");
        const originalLabel = btn ? btn.textContent : "";
        btn.disabled = true;
        btn.innerHTML = "<span class='spinner'></span>";
        let data = toJSON(this);
        let reqBody;
        if(getUploads){
          if(formId === "testRequestForm"){
            const uploads = getUploads();
            const valid = (uploads || []).filter(Boolean);
            data.attachments = valid.map(u=>u.name || '').join(';');
            data.attachmentUrls = valid.map(u=>u.url || '').join(';');
          } else {
          data.attachments = getUploads();
        }
        }
        if(formId==="testRequestForm"){
          // Map to index.html schema; replace removed checkbox fields with Specialreq
          const isSpecial = data.testType === 'special';
          const submissionRound = parseInt(data.sampleSubmissionNo || '0', 10) || 0;
          const normalizedRequestDate = (data.requestDate || '').toString().slice(0,10);
          const normalizedDesiredDate = (data.desiredCompletionDate || '').toString().slice(0,10);
          const mapped = {
            requesterName: data.senderName || '',
            email: data.senderEmail || '',
            requestDate: normalizedRequestDate,
            deptRequest: data.department || '',
            itemName: data.productName || '',
            itemCode: data.productCode || '',
            purpose: data.requestPurpose || '',
            vendor: data.supplier || '',
            qtySamples: data.numSamples || '',
            desiredDate: normalizedDesiredDate,
            changeReq: data.notes || '',
            kiemtraDefault: isSpecial ? '0' : '1',
            kiemtraDacBiet: isSpecial ? '1' : '0',
            Receiver: data.personReceived || '',
            isResubmission: submissionRound >= 2 ? '1' : '0',
            // Legacy checkbox fields kept for schema compatibility but left empty
            chiSoCoBan: '0',
            chiSoCoBanDesc: '',
            tinhNang: '0',
            tinhNangDesc: '',
            diemNG: '0',
            diemNGDesc: '',
            testBen: '0',
            testBenDesc: '',
            khacTest: '0',
            khacTestDesc: '',
            // Replaced group by a single field as requested
            SpecialReq: isSpecial ? (document.getElementById('specialRequestDesc')?.value || '') : '',
            attachments: data.attachments || '',
            // attachmentUrls removed from payload per provided schema
          };
          // Sanitize to flat string values (SheetDB expects flat string cells)
          const flat = {};
          Object.keys(mapped).forEach(k=>{ flat[k] = mapped[k] == null ? '' : String(mapped[k]); });
          reqBody = { data: [flat] };
        } else {
          // other forms unchanged
          reqBody = { data: [data] };
        }
        try{
          const resp = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Accept": "application/json" },
            body: JSON.stringify(reqBody)
          });
          if(resp.ok){
            btn.innerHTML="ƒê√£ g·ª≠i!";
            btn.classList.add("bg-green-600");
            setTimeout(()=>{btn.innerHTML=originalLabel;btn.disabled=false;btn.classList.remove("bg-green-600")},20000);
            // Reset only when user does not want to keep data
            if(!(formId === 'testRequestForm' && document.getElementById('keepDataAfterSubmit')?.checked)){
            this.reset();
              // restore current datetime for readonly field
              const dtEl = document.getElementById('testRequestDate');
              if (dtEl) {
                const now = new Date();
                const tz = now.getTimezoneOffset() * 60000;
                dtEl.value = new Date(now.getTime() - tz).toISOString().slice(0, 16);
              }
            }
          }else {
            const text = await resp.text();
            throw new Error(text || `HTTP ${resp.status}`);
          }
        }catch(err){
          // Fallback: if SheetDB rejects due to bad data format, retry with basic columns only
          if (formId === 'testRequestForm' && /bad data format/i.test(String(err.message || err))) {
            try {
              const isSpecial = data.testType === 'special';
              const noteCombined = `${data.notes || ''}${isSpecial ? `\nSpecialreq: ${(document.getElementById('specialRequestDesc')?.value || '')}` : ''}`.trim();
              const basic = {
                requesterName: String(data.senderName || ''),
                email: String(data.senderEmail || ''),
                requestDate: String(data.requestDate || ''),
                deptRequest: String(data.department || ''),
                itemName: String(data.productName || ''),
                itemCode: String(data.productCode || ''),
                purpose: String(data.requestPurpose || ''),
                vendor: String(data.supplier || ''),
                qtySamples: String(data.numSamples || ''),
                desiredDate: String(data.desiredCompletionDate || ''),
                changeReq: noteCombined,
                kiemtraDefault: isSpecial ? '0' : '1',
                kiemtraDacBiet: isSpecial ? '1' : '0',
                attachments: String(data.attachments || '')
              };
              const fallbackBody = { data: [basic] };
              const resp2 = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(fallbackBody)
              });
              if (resp2.ok) {
                btn.innerHTML = 'ƒê√£ g·ª≠i!';
                btn.classList.add('bg-green-600');
                setTimeout(()=>{btn.innerHTML=originalLabel;btn.disabled=false;btn.classList.remove('bg-green-600')},20000);
                if(!document.getElementById('keepDataAfterSubmit')?.checked){
                  this.reset();
                  const dtEl = document.getElementById('testRequestDate');
                  if (dtEl) {
                    const now = new Date();
                    const tz = now.getTimezoneOffset() * 60000;
                    dtEl.value = new Date(now.getTime() - tz).toISOString().slice(0, 16);
                  }
                }
                return;
              } else {
                const t2 = await resp2.text();
                throw new Error(t2 || `HTTP ${resp2.status}`);
              }
            } catch (e2) {
              alert('G·ª≠i th·∫•t b·∫°i (fallback): ' + e2);
            }
          } else {
            alert("G·ª≠i th·∫•t b·∫°i: "+err);
          }
          btn.innerHTML=originalLabel;
          btn.disabled=false;
        }
      };
    }
    submitForm("testRequestForm", 
      SHEETDB_API_URL,
      ()=>testRequestUploads);
    // internal forms moved to DQA_internal.html

    // Task tracking table: fetch data from endpoint and render
    (function(){
      const TASK_TRACKING_ENDPOINT = "https://phongdqakrd.app.n8n.cloud/webhook/4794bc52-4d4c-4326-b2cb-1b8388f20fb1";

      function getCaseInsensitive(obj, keys) {
        if (!obj) return "";
        const lower = Object.keys(obj).reduce((acc,k)=>{acc[k.toLowerCase()] = obj[k];return acc;},{});
        for (const key of keys) {
          if (lower[key.toLowerCase()] !== undefined) return lower[key.toLowerCase()];
        }
        return "";
      }

      function renderStatusBadge(status) {
        const s = (status || "").toString().toLowerCase();
        if (s.includes("done") || s.includes("ho√†n")) return '<span class="rounded px-2 py-1 bg-green-100 text-green-800">Ho√†n th√†nh</span>';
        if (s.includes("progress") || s.includes("ƒëang")) return '<span class="rounded px-2 py-1 bg-yellow-100 text-yellow-800">ƒêang th·ª±c hi·ªán</span>';
        if (s.includes("pending") || s.includes("ch·ªù")) return '<span class="rounded px-2 py-1 bg-gray-100 text-gray-800">Ch·ªù x·ª≠ l√Ω</span>';
        return `<span class="rounded px-2 py-1 bg-gray-100 text-gray-800">${status || "-"}</span>`;
      }

      function toDDMMYYYY(value){
        if(!value) return '';
        // Accept formats like ISO, YYYY-MM-DD, or already DD/MM/YYYY
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(value)) return value;
        const d = new Date(value);
        if (isNaN(d.getTime())) return value; // fallback to original if invalid
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }

      document.getElementById('taskTrackingForm').onsubmit = async function(e){
      e.preventDefault();
        const btn = document.getElementById('taskTrackingSearchBtn') || this.querySelector("button[type=submit]");
        const originalSearchLabel = btn ? btn.textContent : "T√¨m ki·∫øm";
        if (btn) {
          btn.disabled = true;
          btn.innerHTML = "<span class='spinner'></span><span class='ml-2'>ƒêang t√¨m...</span>";
        }
        const bodyEl = document.getElementById('trackingTableBody');
        bodyEl.innerHTML = "<tr><td colspan='6' class='px-4 py-4 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";

        // Build filter from form
        const formData = new FormData(this);
        const filter = {};
        formData.forEach((v,k)=>{ filter[k] = v; });
        // Build response field mapping from form (allow backend to choose keys; also used client-side)
        const map = {
          submissionDate: filter.resp_ngay_gui || 'submissionDate',
          taskName: filter.resp_ten_cong_viec || 'taskName',
          desiredDueDate: filter.resp_han_mong_muon || 'desiredDueDate',
          completionDate: filter.resp_ngay_hoan_thanh || 'completionDate',
          pic: filter.resp_phu_trach || 'pic',
          status: filter.resp_trang_thai || 'status',
        };

        try {
          // Use GET with query params per webhook requirement
          const params = new URLSearchParams();
          Object.keys(filter).forEach(k=>{
            if (filter[k] !== undefined && filter[k] !== null) {
              if (!k.startsWith('resp_')) params.append(k, filter[k]);
            }
          });
          // send response mapping using safe param names
          const mappingParamMap = {
            resp_ngay_gui: 'field_submission_date',
            resp_ten_cong_viec: 'field_task_name',
            resp_han_mong_muon: 'field_desired_due_date',
            resp_ngay_hoan_thanh: 'field_completion_date',
            resp_phu_trach: 'field_pic',
            resp_trang_thai: 'field_status'
          };
          Object.keys(mappingParamMap).forEach(src=>{
            if (filter[src]) params.append(mappingParamMap[src], filter[src]);
          });
          params.append('_ts', Date.now().toString());
          let url = `${TASK_TRACKING_ENDPOINT}?${params.toString()}`;

          let resp = await fetch(url, { method: 'GET' });

          if (!resp.ok) {
            const errText = await resp.text();
            throw new Error(errText);
          }
          let json = null;
          let ct = resp.headers.get('content-type') || '';
          if (ct.includes('application/json')) json = await resp.json();
          else {
            try { json = JSON.parse(await resp.text()); } catch { json = {}; }
          }

          const rows = Array.isArray(json) ? json
                     : Array.isArray(json?.data) ? json.data
                     : Array.isArray(json?.rows) ? json.rows
                     : [];

          if (!rows.length) {
            bodyEl.innerHTML = "<tr><td colspan='6' class='px-4 py-6 text-center text-gray-500'>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>";
          } else {
            const html = rows.map(r=>{
              const submissionDate = toDDMMYYYY(getCaseInsensitive(r, [map.submissionDate,'ngayGui','createdAt','created_at'])) || '-';
              const taskName = getCaseInsensitive(r, [map.taskName,'tenCongViec','name','title']) || '-';
              const desiredDue = toDDMMYYYY(getCaseInsensitive(r, [map.desiredDueDate,'hanMongMuon','dueDate','due_date'])) || '-';
              const doneDate = toDDMMYYYY(getCaseInsensitive(r, [map.completionDate,'ngayHoanThanh','completedAt','completed_at'])) || '-';
              const pic = getCaseInsensitive(r, [map.pic,'phuTrach','owner','assignee']) || '-';
              const status = getCaseInsensitive(r, [map.status,'trangThai']) || '';
              return `
                <tr>
                  <td class="px-4 py-2">${submissionDate}</td>
                  <td class="px-4 py-2">${desiredDue}</td>
                  <td class="px-4 py-2">${doneDate}</td>
                  <td class="px-4 py-2">${taskName}</td>
                  <td class="px-4 py-2">${pic}</td>
                  <td class="px-4 py-2">${renderStatusBadge(status)}</td>
                </tr>`;
            }).join('');
            bodyEl.innerHTML = html;
          }
        } catch (err) {
          bodyEl.innerHTML = `<tr><td colspan='6' class='px-4 py-6 text-center text-red-600'>L·ªói khi t·∫£i d·ªØ li·ªáu: ${String(err.message || err)}</td></tr>`;
        } finally {
          if (btn) { btn.disabled = false; btn.textContent = originalSearchLabel || 'T√¨m ki·∫øm'; }
        }
      };
    })();

  </script>
</body>
</html>

