<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>H·ªá th·ªëng Phi·∫øu Y√™u C·∫ßu DQA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': '#3b82f6',
            'sidebar': '#0f172a',
            'sidebar-hover': '#1e293b',
            'muted': '#f8fafc',
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .spinner {
      border: 2px solid #e5e7eb;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }

    /* Header and section styling to match index.html */
    .header-container {
      background: linear-gradient(135deg, #2563eb 0%, #60a5fa 100%);
      position: relative;
      overflow: hidden;
    }
    .header-container::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");
      opacity: 0.4;
    }
    .header-badge {
      background-color: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    .header-line { width: 60px; height: 4px; background: linear-gradient(90deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.2) 100%); border-radius: 2px; }

    .form-section { border: 1px solid #e5e7eb; border-radius: 12px; transition: box-shadow 0.2s ease; }
    .form-section:hover { box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06); }

    .submit-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1), 0 1px 3px rgba(37, 99, 235, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease, filter 0.2s ease;
      border-radius: 9999px;
      position: relative;
    }
    .submit-btn:hover { transform: translateY(-1px); box-shadow: 0 7px 14px rgba(37, 99, 235, 0.12), 0 3px 6px rgba(37, 99, 235, 0.08); filter: brightness(1.03); }
    .submit-btn:active { transform: translateY(0); opacity: 0.95; }
    /* Section cards for Form 1 */
    .section-card { border: 1px solid transparent; border-radius: 12px; padding: 16px; }
    .section-a { background: #eff6ff; border-color: #bfdbfe; }
    .section-b { background: #ecfdf5; border-color: #a7f3d0; }
    .section-c { background: #fffbeb; border-color: #fde68a; }
    .section-d { background: #faf5ff; border-color: #e9d5ff; }
  </style>
</head>
<body class="bg-muted min-h-screen flex text-gray-800" style="font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'">
<!-- Sidebar -->
  <aside class="w-56 min-h-screen bg-sidebar text-white flex flex-col py-8 px-4 shadow-lg">
    <h1 class="text-xl font-bold tracking-wide pb-6 border-b border-blue-200 mb-4">C·ªïng T√°c V·ª• DQA</h1>
    <nav class="flex flex-col gap-2 mt-2">
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="testRequest">Phi·∫øu Y√™u C·∫ßu Th·ª≠ Nghi·ªám</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="taskTracking">Theo d√µi C√¥ng vi·ªác</button>
      <button class="nav-btn py-2 px-4 rounded transition hover:bg-sidebar-hover text-left text-base" data-target="userGuide">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</button>
      
    </nav>
  </aside>
  <!-- Form Sections -->
  <main class="flex-1 py-12 flex flex-col items-center justify-center min-h-screen overflow-y-auto">
    <div class="header-container relative w-full max-w-5xl rounded-xl overflow-hidden mb-8">
      <div class="relative z-10 p-8 md:p-10">
        <div class="flex items-center space-x-2 mb-3">
          <div class="inline-block header-badge px-3 py-1 rounded-full text-xs font-semibold text-white">Ph√≤ng DQA</div>
          <div class="header-line hidden md:block"></div>
        </div>
        <h2 class="text-2xl md:text-3xl lg:text-4xl font-bold text-white mb-1 tracking-tight">C·ªïng Y√™u C·∫ßu DQA</h2>
        <p class="text-blue-100 text-sm md:text-base">T·ªïng h·ª£p phi·∫øu th·ª≠ nghi·ªám v√† ti·∫øn ƒë·ªô c√¥ng vi·ªác</p>
      </div>
    </div>
    <!-- Test Request Form -->
    <section id="testRequest" class="form-section w-full max-w-4xl bg-white p-8 rounded-lg shadow-md">
      <div class="mb-8">
        <h2 class="text-3xl font-extrabold text-primary-blue tracking-wide mb-1">Phi·∫øu Y√™u C·∫ßu Th·ª≠ Nghi·ªám</h2>
        <div class="h-1 w-16 bg-primary-blue mb-2 rounded"></div>
        <p class="text-base text-gray-500">Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c m·ª•c b·∫Øt bu·ªôc cho s·∫£n ph·∫©m/linh ki·ªán c·∫ßn th·ª≠ nghi·ªám. Bi·ªÉu m·∫´u s·∫Ω t·ª± ƒë·ªông thay ƒë·ªïi theo l·ª±a ch·ªçn c·ªßa b·∫°n.</p>
      </div>
      <form id="testRequestForm" class="space-y-6" autocomplete="off">
        <!-- A. General Information -->
        <div class="section-card section-a">
          <h3 class="text-lg font-semibold text-primary-blue mb-2">A. Th√¥ng tin chung</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <input required id="senderName" name="senderName" type="text" list="senderNameOptions" placeholder="H·ªç t√™n ng∆∞·ªùi g·ª≠i *" class="input-field"/>
              <datalist id="senderNameOptions"></datalist>
            </div>
            <input required name="senderEmail" type="email" placeholder="Email *" class="input-field"/>
            <input name="requestDate" type="datetime-local" class="input-field" readonly id="testRequestDate"/>
            <input type="hidden" name="requestCode" id="requestCode"/>
            <select required name="department" class="input-field">
              <option value="">Ph√≤ng ban y√™u c·∫ßu *</option>
              <option>Mua h√†ng</option><option>SC</option><option>SC2</option><option>KTSX</option><option>KTSP</option>
              <option>TKCK</option><option>KTCN</option><option>NCTN</option><option>TKƒêT</option>
              <option>QA/QC nh√† m√°y</option><option>DQA</option>
            </select>
          </div>
        </div>
        <!-- B. Product/Component Information -->
        <div class="section-card section-b">
          <h3 class="text-lg font-semibold text-primary-blue mb-2">B. Th√¥ng tin s·∫£n ph·∫©m/linh ki·ªán</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input required id="productName" name="productName" type="text" placeholder="T√™n s·∫£n ph·∫©m/linh ki·ªán *" class="input-field"/>
            <input required name="productCode" type="text" placeholder="M√£ s·∫£n ph·∫©m/linh ki·ªán *" class="input-field"/>
            <div class="md:col-span-2">
              <input required name="componentType" id="componentType" list="componentTypeOptions" type="text" placeholder="Lo·∫°i linh ki·ªán *" class="input-field"/>
              <datalist id="componentTypeOptions"></datalist>
              <div class="text-xs text-gray-500 mt-1">N·∫øu linh ki·ªán kh√¥ng c√≥ trong danh s√°ch, nh·∫≠p: "Linh ki·ªán kh√°c"</div>
              <input type="hidden" name="componentStandard" id="componentStandard" />
              <div id="componentStandardNote" class="text-sm text-gray-600 mt-1 hidden"></div>
            </div>
            <input name="sampleSubmissionNo" id="sampleSubmissionNo" type="number" min="1" placeholder="L·∫ßn g·ª≠i m·∫´u " class="input-field"/>
            <div id="testRequestChangeNote" class="hidden md:col-span-2">
              <input type="text" name="changeFromLastNote" placeholder="M√¥ t·∫£ thay ƒë·ªïi so v·ªõi l·∫ßn tr∆∞·ªõc" class="input-field"/>
            </div>
            <select required name="requestPurpose" id="requestPurpose" class="input-field md:col-span-2">
              <option value="">M·ª•c ƒë√≠ch y√™u c·∫ßu *</option>
              <option value="ƒê√°nh gi√° SP m·ªõi">ƒê√°nh gi√° SP m·ªõi- Giai ƒëo·∫°n EV</option>
              <option value="ƒê√°nh gi√° SP m·ªõi">ƒê√°nh gi√° SP m·ªõi- Giai ƒëo·∫°n DV</option>
              <option value="ƒê√°nh gi√° thay ƒë·ªïi nh√† cung c·∫•p">ƒê√°nh gi√° thay ƒë·ªïi nh√† cung c·∫•p</option>
              <option value="ƒê√°nh gi√° thay ƒë·ªïi 4M">ƒê√°nh gi√° thay ƒë·ªïi 4M</option>
              <option value="Ph·∫£n h·ªìi l·ªói th·ªã tr∆∞·ªùng">Ph·∫£n h·ªìi l·ªói th·ªã tr∆∞·ªùng</option>
              <option value="Ki·ªÉm tra ƒë·ªãnh k·ª≥ n·ªôi b·ªô">Ki·ªÉm tra ƒë·ªãnh k·ª≥ n·ªôi b·ªô</option>
              <option value="ƒê√°nh gi√° ƒë·ªÅ xu·∫•t c·∫£i ti·∫øn">ƒê√°nh gi√° ƒë·ªÅ xu·∫•t c·∫£i ti·∫øn</option>
              <option value="Ph·ªëi h·ª£p nghi√™n c·ª©u c√¥ng ngh·ªá">Ph·ªëi h·ª£p nghi√™n c·ª©u c√¥ng ngh·ªá</option>
              <option value="Y√™u c·∫ßu t·ª´ kh√°ch h√†ng/b√™n th·ª© 3">Y√™u c·∫ßu t·ª´ kh√°ch h√†ng/b√™n th·ª© 3</option>
            </select>
            <div id="purposeDescription" class="text-gray-600 text-sm md:col-span-2"></div>
            <div id="nccChangeFields" class="hidden md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
              <input type="text" id="altCode" name="altCode" class="input-field" placeholder="M√£ t∆∞∆°ng t·ª±/thay th·∫ø *" disabled />
              <input type="text" id="appliedModel" name="appliedModel" class="input-field" placeholder="Model √°p d·ª•ng *" disabled />
            </div>
            <input name="supplier" required type="text" placeholder="Nh√† cung c·∫•p *" class="input-field"/>
            <input name="numSamples" type="number" min="0" placeholder="S·ªë l∆∞·ª£ng m·∫´u giao *" required class="input-field"/>
            <input id="desiredCompletionDate" name="desiredCompletionDate" type="text" placeholder="H·∫°n mong mu·ªën" required class="input-field"/>
            <input type="hidden" name="desiredCompletionDateTime" id="desiredCompletionDateTime" />
            <select name="personReceived" required class="input-field">
              <option value="">Ch·ªçn ng∆∞·ªùi ƒë√£ nh·∫≠n m·∫´u *</option>
              <option>V≈© Duy Minh</option>
              <option>Nguy·ªÖn VƒÉn Linh</option>
              <option>Nguy·ªÖn VƒÉn Hi·∫øu</option>
              <option>ƒê√†o Ho√†ng D∆∞∆°ng</option>
            </select>
            <textarea name="notes" rows="2" placeholder="Ghi ch√∫ (ƒêi·ªÉm thay ƒë·ªïi, l√Ω do y√™u c·∫ßu g·∫•p...)" class="input-field md:col-span-2"></textarea>
          </div>
        </div>
        <!-- C. Required Testing Information -->
        <div class="section-card section-c">
          <h3 class="text-lg font-semibold text-primary-blue mb-2">C. Th√¥ng tin th·ª≠ nghi·ªám y√™u c·∫ßu</h3>
          <div class="flex items-center gap-8 pb-2">
            <label class="flex items-center"><input type="radio" class="mr-2" name="testType" value="standard" checked>Ki·ªÉm tra m·∫∑c ƒë·ªãnh theo ti√™u chu·∫©n k·ªπ thu·∫≠t</label>
            <label class="flex items-center"><input type="radio" class="mr-2" name="testType" value="special">Ki·ªÉm tra ƒë·∫∑c bi·ªát theo y√™u c·∫ßu</label>
          </div>
          <div id="specialTestFields" class="hidden pb-2 border border-primary-blue rounded p-4 bg-blue-50">
            <label for="specialRequestDesc" class="block text-sm text-gray-700 mb-2">M√¥ t·∫£ ki·ªÉm tra ƒë·∫∑c bi·ªát <span class="text-red-600">*</span></label>
            <input type="text" id="specialRequestDesc" name="specialRequestDesc" class="input-field" placeholder="M√¥ t·∫£ chi ti·∫øt h·∫°ng m·ª•c ki·ªÉm tra, ti√™u chu·∫©n √°p d·ª•ng..." required disabled />
          </div>
        </div>
        <!-- D. Attachments -->
        <div class="section-card section-d">
          <h3 class="text-lg font-semibold text-primary-blue mb-2">D. T√†i li·ªáu ƒë√≠nh k√®m</h3>
          <div id="fileUploadArea" class="relative border-2 border-dashed border-blue-300 rounded-lg p-8 text-center transition-all duration-300 hover:border-blue-400 hover:bg-blue-50 cursor-pointer">
            <div id="uploadContent" class="space-y-4">
              <div class="mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
              </div>
              <div>
                <p class="text-lg font-medium text-gray-700">K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c <span class="text-blue-600 underline">nh·∫•n ƒë·ªÉ ch·ªçn</span></p>
                <p class="text-sm text-gray-500 mt-1">H·ªó tr·ª£: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG (t·ªëi ƒëa 20MB m·ªói file)</p>
              </div>
            </div>
            <input type="file" id="testRequestFiles" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
          </div>
          <div id="uploadProgress" class="hidden mt-4 p-4 bg-blue-50 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-blue-700">ƒêang t·∫£i l√™n...</span>
              <span id="uploadPercent" class="text-sm text-blue-600">0%</span>
            </div>
            <div class="w-full bg-blue-200 rounded-full h-2">
              <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
          </div>
          <div id="testRequestUploadList" class="mt-4 space-y-3"></div>
          <p class="mt-4 text-xs text-gray-500">
            <span class="inline-block w-2 h-2 bg-blue-400 rounded-full mr-2"></span>
            B·∫°n c√≥ th·ªÉ ch·ªçn ho·∫∑c k√©o th·∫£ nhi·ªÅu file. C√°c file s·∫Ω ƒë∆∞·ª£c t·∫£i l√™n khi nh·∫•n g·ª≠i. <br>
            T√πy v√†o k√≠ch th∆∞·ªõc file ƒë√≠nh k√®m m√† vi·ªác t·∫£i l√™n c√≥ th·ªÉ m·∫•t th·ªùi gian. Xin vui l√≤ng ch·ªù.
          </p>
        </div>
        <!-- Keep data after submit -->
        <label class="mt-3 flex items-center text-sm text-gray-600">
          <input type="checkbox" id="keepDataAfterSubmit" class="mr-2">
          Gi·ªØ d·ªØ li·ªáu sau khi g·ª≠i. (D·ªØ li·ªáu ƒë√£ nh·∫≠p s·∫Ω kh√¥ng b·ªã x√≥a sau khi nh·∫•n g·ª≠i)
        </label>
        <button type="submit" class="submit-btn w-full mt-4 py-3 text-white font-semibold text-lg transition flex items-center justify-center gap-2">
          <span>G·ª≠i y√™u c·∫ßu</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        </button>
      </form>
    </section>
    <!-- Task Tracking -->
    <section id="taskTracking" class="form-section w-full max-w-7xl bg-white p-8 rounded-lg shadow-md hidden">
      <div class="mb-8">
        <h2 class="text-3xl font-extrabold text-primary-blue tracking-wide mb-1">Theo d√µi C√¥ng vi·ªác</h2>
        <div class="h-1 w-16 bg-primary-blue mb-2 rounded"></div>
        <p class="text-base text-gray-500">Theo d√µi c√°c c√¥ng vi·ªác ƒë√£ g·ª≠i k√®m tr·∫°ng th√°i v√† th·ªùi h·∫°n ƒë√°p ·ª©ng.</p>
      </div>
      <form id="taskTrackingForm" class="mb-8 space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Email ng∆∞·ªùi g·ª≠i</label>
            <input name="senderEmail" type="email" placeholder="Nh·∫≠p email ng∆∞·ªùi g·ª≠i" class="input-field h-12"/>
          </div>
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Ph√≤ng ban y√™u c·∫ßu</label>
            <select name="department" class="input-field h-12">
              <option value="">Ch·ªçn ph√≤ng ban</option>
               <option>Mua h√†ng</option><option>SC</option><option>SC2</option><option>KTSX</option><option>KTSP</option>
              <option>TKCK</option><option>KTCN</option><option>NCTN</option><option>TKƒêT</option>
              <option>QA/QC nh√† m√°y</option>
            </select>
          </div>
        </div>
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm text-blue-700">
                <span class="font-medium">L∆∞u √Ω:</span> Ph·∫£i nh·∫≠p √≠t nh·∫•t m·ªôt trong hai tr∆∞·ªùng tr√™n ƒë·ªÉ t√¨m ki·∫øm.
              </p>
            </div>
          </div>
        </div>
        <!-- Response field mapping params (backend can use these to shape response) -->
        <div class="hidden">
          <input type="hidden" name="resp_ngay_gui" value="submissionDate" />
          <input type="hidden" name="resp_ten_cong_viec" value="task-name" />
          <input type="hidden" name="resp_han_mong_muon" value="desiredDueDate" />
          <input type="hidden" name="resp_ngay_hoan_thanh" value="completionDate" />
          <input type="hidden" name="resp_phu_trach" value="pic" />
          <input type="hidden" name="resp_trang_thai" value="status" />
          <input type="hidden" name="resp_nguoi_giao_viec" value="assigner" />
          <input type="hidden" name="resp_ma_bao_cao" value="reportCode" />
        </div>
        <div class="flex justify-end">
          <button id="taskTrackingSearchBtn" type="submit" class="submit-btn px-8 py-3 rounded-lg text-white font-semibold transition text-base">üîç T√¨m ki·∫øm</button>
        </div>
      </form>
      <div class="overflow-x-auto shadow-lg rounded-lg border border-gray-200">
        <table id="trackingTable" class="min-w-full text-sm border-collapse">
          <thead>
            <tr class="bg-gradient-to-r from-primary-blue to-blue-600 text-white">
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">Ng∆∞·ªùi y√™u c·∫ßu</th>
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">Ng√†y g·ª≠i</th>
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">H·∫°n mong mu·ªën</th>
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">H·∫°n ƒë√°p ·ª©ng</th>
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">T√™n c√¥ng vi·ªác</th>
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">Ph·ª• tr√°ch</th>
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">Tr·∫°ng th√°i</th>
              <th class="px-6 py-4 text-left font-semibold text-sm uppercase tracking-wider">M√£ b√°o c√°o</th>
            </tr>
          </thead>
          <tbody id="trackingTableBody" class="bg-white text-gray-900 divide-y divide-gray-200">
            <tr><td colspan="8" class="px-6 py-8 text-center text-gray-500 text-base">Nh·∫•n T√¨m ki·∫øm ƒë·ªÉ t·∫£i tr·∫°ng th√°i c√¥ng vi·ªác.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
    <!-- User Guide -->
    <section id="userGuide" class="form-section w-full max-w-4xl bg-white p-8 rounded-lg shadow-md hidden">
      <div class="mb-8">
        <h2 class="text-3xl font-extrabold text-primary-blue tracking-wide mb-1">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h2>
        <div class="h-1 w-16 bg-primary-blue mb-2 rounded"></div>
        <p class="text-base text-gray-500">Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ m·ªü t√†i li·ªáu h∆∞·ªõng d·∫´n.</p>
      </div>
      <div class="flex flex-col sm:flex-row gap-4">
        <a href="https://docs.google.com/document/d/1eRC2z16alLpVfA8NYjD6teGWF94dwpnM/edit?usp=drive_link&ouid=101589232360066908244&rtpof=true&sd=true" target="_blank" rel="noopener noreferrer"
           class="submit-btn inline-flex items-center justify-center px-6 py-3 text-white font-semibold rounded-lg">
          M·ªü t√†i li·ªáu h∆∞·ªõng d·∫´n
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path d="M12.293 2.293a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L14 5.414V13a1 1 0 11-2 0V5.414L9.707 7.707A1 1 0 018.293 6.293l4-4z"/><path d="M3 9a1 1 0 011-1h3a1 1 0 110 2H5v6h10v-2a1 1 0 112 0v3a1 1 0 01-1 1H4a1 1 0 01-1-1V9z"/></svg>
        </a>
      </div>
    </section>
    
  </main>
  <!-- Common Styles -->
  <style>
    .input-field {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #93c5fd; /* blue-300 */
      border-radius: 0.5rem; /* rounded */
      background-color: #f1f5f9; /* muted */
      transition: box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
      outline: none;
    }
    .input-field:focus {
      border-color: #3b82f6; /* primary-blue */
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* ring-blue-200 */
      background-color: #ffffff;
    }
    .input-field::placeholder {
      color: #9ca3af; /* gray-400 */
    }
    .input-field:read-only {
      background: #e5e7eb; /* gray-200 */
      color: #6b7280; /* gray-500 */
    }
    /* style for input-as-text date field (per reference) */
    .date-text-placeholder::placeholder { color: #6b7280; }
    #fileUploadArea.drag-over {
      border-color: #3b82f6 !important;
      background-color: #eff6ff !important;
      transform: scale(1.02);
    }
    .file-item { transition: all 0.3s ease; }
    .file-item:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
    #progressBar { transition: width 0.3s ease; }
    .file-preview img {
      transition: transform 0.2s ease;
    }
    
    .file-preview:hover img {
      transform: scale(1.05);
    }

    /* Blue submit button (white text) */
    .submit-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      box-shadow: 0 4px 6px rgba(37, 99, 235, 0.1), 0 1px 3px rgba(37, 99, 235, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease, filter 0.2s ease;
      border-radius: 9999px;
      position: relative;
    }
    .submit-btn:hover { transform: translateY(-1px); box-shadow: 0 7px 14px rgba(37, 99, 235, 0.12), 0 3px 6px rgba(37, 99, 235, 0.08); filter: brightness(1.03); }
    .submit-btn:active { transform: translateY(0); opacity: 0.95; }
  </style>
  <!-- JavaScript for dynamic logic/features -->
  <script>
    // Endpoints for Form 1 (Test Request)
    const FORM_SUBMIT_ENDPOINT = "https://iatzhxxuk.tino.page/webhook/03a0df2e-f7e6-47aa-bb98-756589ad8b55";
    const FILE_UPLOAD_ENDPOINT = FORM_SUBMIT_ENDPOINT;
    // Sidebar navigation logic
    const navBtns = document.querySelectorAll('.nav-btn');
    const formSections = document.querySelectorAll('.form-section');
    function showSection(id) {
      formSections.forEach(sec => sec.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }
    navBtns.forEach(btn => {
      btn.onclick = () => {
        navBtns.forEach(b => b.classList.remove('bg-primary-blue', 'font-bold'));
        btn.classList.add('bg-primary-blue', 'font-bold');
        showSection(btn.getAttribute('data-target'));
      };
    });
    // Show first form by default
    navBtns[0].classList.add('bg-primary-blue', 'font-bold');
    showSection(navBtns[0].getAttribute('data-target'));

    // Set default current local date+time for date fields on load
    function setCurrentDateTime(id) {
      const dt = new Date();
      const tzOffsetMs = dt.getTimezoneOffset() * 60000;
      const localISO = new Date(dt.getTime() - tzOffsetMs).toISOString().slice(0, 16);
      const el = document.getElementById(id);
      if (el) el.value = localISO;
    }
    setCurrentDateTime('testRequestDate');
    
    // Desired date constraints and hidden datetime submission
    (function setupDesiredDateField(){
      const input = document.getElementById('desiredCompletionDate');
      const hiddenDateTime = document.getElementById('desiredCompletionDateTime');
      if (!input || !hiddenDateTime) return;
      // Convert to date on focus/click and set range today..+32
      function toYMD(d){
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
      }
      function setRange(el){
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const end = new Date(start); end.setDate(end.getDate() + 32);
        el.min = toYMD(start);
        el.max = toYMD(end);
      }
      function ensureDateMode(){
        if (input.type !== 'date') {
          input.type = 'date';
          setRange(input);
          try { if (input.showPicker) input.showPicker(); } catch(_){}
        }
      }
      input.addEventListener('focus', ensureDateMode);
      input.addEventListener('click', ensureDateMode);
      input.addEventListener('blur', ()=>{
        if (!input.value) {
          input.type = 'text';
          input.removeAttribute('min');
          input.removeAttribute('max');
        }
      });
      function updateHidden(){
        if (!input.value) { hiddenDateTime.value = ''; return; }
        const [y,m,d] = input.value.split('-').map(Number);
        if (!y || !m || !d) { hiddenDateTime.value = ''; return; }
        const now = new Date();
        const dt = new Date(y, m-1, d, now.getHours(), now.getMinutes(), now.getSeconds());
        hiddenDateTime.value = dt.toISOString();
      }
      input.addEventListener('change', updateHidden);
      input.addEventListener('input', updateHidden);
      updateHidden();
    })();

    // Dynamic fields logic for Test Request Form
    // a. Purpose dropdown description
    const purposeDescriptions = {
      "ƒê√°nh gi√° SP m·ªõi": "S·∫£n ph·∫©m/linh ki·ªán m·ªõi s·∫Øp SOP, c·∫ßn ki·ªÉm tra ƒë·ªô b·ªÅn v√† ph√π h·ª£p ti√™u chu·∫©n k·ªπ thu·∫≠t tr∆∞·ªõc khi s·∫£n xu·∫•t ƒë·∫°i tr√†.",
      "ƒê√°nh gi√° thay ƒë·ªïi nh√† cung c·∫•p": "Linh ki·ªán/s·∫£n ph·∫©m thay ƒë·ªïi nh√† cung c·∫•p; c·∫ßn ki·ªÉm tra l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng kh√¥ng b·ªã ·∫£nh h∆∞·ªüng.",
      "ƒê√°nh gi√° thay ƒë·ªïi 4M": "C√≥ thay ƒë·ªïi v·ªÅ V·∫≠t li·ªáu, M√°y m√≥c, Ph∆∞∆°ng ph√°p, Nh√¢n s·ª±; c·∫ßn ƒë√°nh gi√° r·ªßi ro li√™n quan.",
      "Ph·∫£n h·ªìi l·ªói th·ªã tr∆∞·ªùng": "S·∫£n ph·∫©m ƒëang s·ª≠ d·ª•ng ph√°t sinh khi·∫øu n·∫°i/l·ªói t·ª´ th·ªã tr∆∞·ªùng; ki·ªÉm tra l·∫°i ƒë·ªÉ x√°c ƒë·ªãnh nguy√™n nh√¢n.",
      "Ki·ªÉm tra ƒë·ªãnh k·ª≥ n·ªôi b·ªô": "Th·ª≠ nghi·ªám theo k·∫ø ho·∫°ch n·ªôi b·ªô (QA, MKT, ki·ªÉm ƒë·ªãnh/hi·ªáu chu·∫©n thi·∫øt b·ªã ƒë·ªãnh k·ª≥).",
      "ƒê√°nh gi√° ƒë·ªÅ xu·∫•t c·∫£i ti·∫øn": "ƒê·ªÅ xu·∫•t c·∫£i ti·∫øn v·ªÅ thi·∫øt k·∫ø/c·∫•u tr√∫c/chi ph√≠; c·∫ßn x√°c nh·∫≠n b·∫±ng th·ª≠ nghi·ªám.",
      "Ph·ªëi h·ª£p nghi√™n c·ª©u c√¥ng ngh·ªá": "Ki·ªÉm tra ƒë·∫∑c t√≠nh/t√≠nh nƒÉng k·ªπ thu·∫≠t trong qu√° tr√¨nh nghi√™n c·ª©u, ph·ªëi h·ª£p ph√°t tri·ªÉn c√¥ng ngh·ªá m·ªõi.",
      "Y√™u c·∫ßu t·ª´ kh√°ch h√†ng/b√™n th·ª© 3": "Y√™u c·∫ßu x√°c nh·∫≠n k·ªπ thu·∫≠t theo ti√™u chu·∫©n ri√™ng c·ªßa kh√°ch h√†ng/ƒë·ªëi t√°c/b√™n th·ª© ba.",
    };
    document.getElementById('requestPurpose').onchange = (e)=>{
      const val = e.target.value || "";
      const desc = purposeDescriptions[val] || "";
      document.getElementById('purposeDescription').textContent = desc;
      const showNcc = /NCC/i.test(val) || /nh√†\s*cung\s*c·∫•p/i.test(val);
      const container = document.getElementById('nccChangeFields');
      const alt = document.getElementById('altCode');
      const model = document.getElementById('appliedModel');
      if (container && alt && model) {
        container.classList.toggle('hidden', !showNcc);
        alt.disabled = !showNcc; model.disabled = !showNcc;
        alt.required = showNcc;  model.required = showNcc;
      }
    };
    try { document.getElementById('requestPurpose').dispatchEvent(new Event('change')); } catch(_) {}
    // b. Sample submission number
    document.getElementById('sampleSubmissionNo').oninput = (e)=>{
      const need = Number(e.target.value || 0) >= 2;
      const container = document.getElementById('testRequestChangeNote');
      if (container) container.classList.toggle('hidden', !need);
      const inp = container ? container.querySelector('input[name="changeFromLastNote"]') : null;
      if (inp) inp.required = need;
    };
    try { document.getElementById('sampleSubmissionNo').dispatchEvent(new Event('input')); } catch(_) {}

    // c. Special test toggle: show single required input when selected
    document.querySelectorAll('input[name="testType"]').forEach(radio=>{
      radio.addEventListener('change', updateSpecialFields);
    });
    function updateSpecialFields(){
      const choice = (document.querySelector('input[name="testType"]:checked') || {}).value;
      const container = document.getElementById('specialTestFields');
      const input = document.getElementById('specialRequestDesc');
      const show = choice === 'special';
      if (container) container.classList.toggle('hidden', !show);
      if (input) { input.disabled = !show; input.required = show; }
    }
    updateSpecialFields();

    // d. Component type mapping (suggestions + drag-and-drop + auto-standard)
    (function setupComponentType(){
      const input = document.getElementById('componentType');
      const datalist = document.getElementById('componentTypeOptions');
      const hiddenStd = document.getElementById('componentStandard');
      const note = document.getElementById('componentStandardNote');
      if (!input || !datalist || !hiddenStd || !note) return;

      const COMPONENT_ITEMS = [
        { name: 'M√°y l·ªçc n∆∞·ªõc', std: 32 },
        { name: 'M√°y l·ªçc n∆∞·ªõc (Ch·ªâ rung l·∫Øc)', std: 6 },
        { name: 'M√°y l·ªçc n∆∞·ªõc (Base/r√† so√°t t√†i li·ªáu)', std: 12 },
        { name: 'Linh ki·ªán c∆° kh√≠ k·∫øt c·∫•u M25', std: 17 },
        { name: 'Tem nh√£n, Th√πng carton,BƒÉng d√≠nh,T√∫i b√≥ng PE,X·ªëp,ƒêai b√¨nh √°p', std: 16 },
        { name: '·ªêc v√≠t, stopper', std: 16 },
        { name: 'L√µi l·ªçc th√¥ (PP, OCB, CTO, UDF)', std: 19 },
        { name: 'C·ªëc, N·∫Øp c·ªëc', std: 17 },
        { name: 'D√¢y RO', std: 23 },
        { name: 'Th√¢n v·ªè m√†ng, N·∫Øp v·ªè m√†ng', std: 17 },
        { name: 'B√¨nh √°p,B√¨nh ch·ª©a', std: 23 },
        { name: 'V√≤i,b·ªô kh√≥a v√≤i, c·ªß v√≤i', std: 23 },
        { name: 'C√°c lo·∫°i h·∫°t trong l√µi, than, kho√°ng ƒë√°, Corosex, ORP, CaCO3...', std: 19 },
        { name: 'L√µi ch·ª©c nƒÉng: 6HP, Hydrogen,Alkaline,Kho√°ng,T33,Nano Silver...', std: 19 },
        { name: 'M√†ng RO,UF', std: 24 },
        { name: 'B·ªô ƒëi·ªán ph√¢n Alkaline, Hydrogen, B·ªô ƒëi·ªán ph√¢n', std: 24 },
        { name: 'B·ªô d√¢y ƒëi·ªán', std: 23 },
        { name: 'B∆°m', std: 25 },
        { name: 'Ngu·ªìn xung, ngu·ªìn c∆°, M·∫°ch ƒëi·ªán t·ª≠', std: 23 },
        { name: 'Phin l·ªçc, Block', std: 25 },
        { name: '·ªêp s·∫Øt, ·ªëp nh·ª±a', std: 17 },
        { name: 'Th√¢n t·ªß, v·ªè t·ªß, khay n√≥ng l·∫°nh', std: 17 },
        { name: 'Nam ch√¢m, Ch·ªët ƒë·ªãnh, c√°nh,d√¢y th√≠t,d√¢y ƒëai,keo silicone, keo n·∫øn,·ªëng b·∫£o √¥n', std: 16 },
        { name: 'K√≠nh', std: 17 },
        { name: 'Van √°p th·∫•p,Van √°p trung, Van √°p cao, Van ƒëi·ªán t·ª´, Van b√¨nh √°p, Van x·∫£ tay, Van TDS, Van 1 chi·ªÅu, Van 4 c·ª≠a, Van gi·∫£m √°p', std: 23 },
        { name: 'C√∫t, ·ªëc', std: 23 },
        { name: 'GioƒÉng, Linh ki·ªán h·∫°t n·ªëi nhanh', std: 23 },
        { name: 'B√¨nh n√≥ng, B√¨nh l·∫°nh, B√¨nh t·∫£n nhi·ªát, Gas l·∫°nh', std: 25 },
        { name: 'D√†n n√≥ng, D√†n l·∫°nh', std: 25 },
        { name: '·ªêng ƒë·ªìng, ·ªëng Inox', std: 25 },
        { name: 'Thermostar c∆°, C·∫£m bi·∫øn NTC', std: 25 },
        { name: 'Gi√° RO, ƒêinh, ƒë·∫ø t·ªß, Linh ki·ªán b·∫Øt v√†o th√¢n t·ªß', std: 17 },
        { name: 'Linh ki·ªán kh√°c', std: 0 }
      ];

      // Populate datalist for component type
      datalist.innerHTML = COMPONENT_ITEMS.map(i=>`<option value="${i.name}"></option>`).join('');

      function normalize(s){
        return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
      }

      function resolveStandard(raw){
        if (!raw) return { name: '', std: 0 };
        // Exact match first
        const exact = COMPONENT_ITEMS.find(i => i.name === raw);
        if (exact) return exact;
        const n = normalize(raw);
        // Try inclusive match on normalized strings
        let best = { name: raw, std: 0 };
        for (const item of COMPONENT_ITEMS) {
          const ni = normalize(item.name);
          if (n === ni || n.includes(ni) || ni.includes(n)) { best = item; break; }
        }
        return best;
      }

      function updateStandard(){
        const res = resolveStandard(input.value);
        hiddenStd.value = String(res.std || 0);
        note.textContent = '';
      }

      input.addEventListener('input', updateStandard);
      input.addEventListener('change', updateStandard);
      input.addEventListener('blur', updateStandard);

      // Drag-and-drop text support
      ;['dragenter','dragover'].forEach(ev=>{
        input.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); input.classList.add('ring-2','ring-blue-300'); });
      });
      ;['dragleave','drop'].forEach(ev=>{
        input.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); input.classList.remove('ring-2','ring-blue-300'); });
      });
      input.addEventListener('drop', e=>{
        const txt = e.dataTransfer?.getData('text/plain') || '';
        if (txt) {
          input.value = txt.trim();
          updateStandard();
        }
      });

      // Initialize on load
      updateStandard();

      // Expose data for other modules
      window.__resolveComponentStandard = (val)=>resolveStandard(val||'').std || 0;
      window.__componentItems = COMPONENT_ITEMS.slice();
    })();

    // Link product name keywords to filter component type suggestions
    (function linkProductNameToComponentType(){
      const productNameInput = document.getElementById('productName');
      const compInput = document.getElementById('componentType');
      const compList = document.getElementById('componentTypeOptions');
      if (!productNameInput || !compInput || !compList) return;

      function normalize(s){
        return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
      }

      function scoreCandidate(query, candidate){
        const q = normalize(query);
        const c = normalize(candidate);
        if (!q) return 0;
        let score = 0;
        q.split(/\s+/).filter(Boolean).forEach(tok=>{
          if (c.includes(tok)) score += 2;
        });
        // bonus if startsWith any token
        const first = q.split(/\s+/).filter(Boolean)[0] || '';
        if (first && c.startsWith(first)) score += 1;
        return score;
      }

      function updateComponentSuggestions(){
        const items = window.__componentItems || [];
        const q = productNameInput.value || '';
        const ranked = items
          .map(i=>({ name: i.name, std: i.std, s: scoreCandidate(q, i.name) }))
          .filter(x=>x.s > 0 || !q)
          .sort((a,b)=> b.s - a.s || a.name.localeCompare(b.name));
        const take = (q ? ranked.slice(0, 20) : items.slice(0, 50));
        const otherName = 'Linh ki·ªán kh√°c';
        const names = take.map(i=>i.name);
        if (!names.includes(otherName)) names.push(otherName);
        compList.innerHTML = names.map(n=>`<option value="${n}"></option>`).join('');
        // If no suggestions match and field is empty, default to "Linh ki·ªán kh√°c"
        if (q && ranked.length === 0 && !compInput.value) {
          compInput.value = otherName;
          try { compInput.dispatchEvent(new Event('input')); } catch(_){ }
        }
        // If current componentType empty and there is a strong candidate, prefill suggestion (not forced)
        if (!compInput.value && q && ranked.length && ranked[0].s >= 2) {
          compInput.setAttribute('placeholder', `G·ª£i √Ω: ${ranked[0].name}`);
        } else if (!q) {
          compInput.setAttribute('placeholder', 'Lo·∫°i linh ki·ªán *');
        }
      }

      productNameInput.addEventListener('input', updateComponentSuggestions);
      productNameInput.addEventListener('blur', updateComponentSuggestions);
      // initial
      updateComponentSuggestions();
    })();

    // A. Sender auto-complete and auto-fill email/department
    (function setupSenderAutocomplete(){
      const nameInput = document.getElementById('senderName');
      const emailInput = document.querySelector('input[name="senderEmail"]');
      const deptSelect = document.querySelector('select[name="department"]');
      const list = document.getElementById('senderNameOptions');
      if (!nameInput || !emailInput || !deptSelect || !list) return;

      const SENDER_DB = [
        { name: 'ƒêo√†n Th·ªã Minh Th∆∞', dept: 'KTSP', email: 'thu.doan@karofi.vn' },
        { name: 'ƒê·∫∑ng VƒÉn H·∫£i', dept: 'TKCK', email: 'haidv1@karofi.vn' },
        { name: 'Nguy·ªÖn Quang Tr·ªçng', dept: 'KTCN', email: 'trongnq@karofi.vn' },
        { name: 'Ph·∫°m Quang Doanh', dept: 'TKƒêT', email: 'doanh.pham@karofi.vn' },
        { name: 'Nguy·ªÖn Th·ªã M·ª´ng', dept: 'SC', email: 'mung.nguyen1@karofi.vn' },
        { name: 'V≈© ƒêƒÉng L∆∞∆°ng', dept: 'KTSP', email: 'luong.vu@karofi.vn' },
        { name: 'Ho√†ng L√™ Anh', dept: 'TKCK', email: 'anh.hoang2@karofi.com' },
        { name: 'Phan VƒÉn C·ª≠', dept: 'KTSP', email: 'cupv@karofi.vn' },
        { name: 'Ph·∫°m VƒÉn Thu·∫≠n', dept: 'KTSX', email: 'thuan.pham2@karofi.vn' },
        { name: 'Chu VƒÉn Quang', dept: 'KTSP', email: 'quangcv@karofi.vn' },
        { name: 'Tr·∫ßn Kh·∫Øc L√¢m', dept: 'KTSP', email: 'lamtk@karofi.vn' },
        { name: 'ƒê·∫∑ng Th·∫ø Huy', dept: 'TKƒêT', email: 'huydt@karofi.com' },
        { name: 'Tr·∫ßn H·ªìng Nhung', dept: 'SC', email: 'nhung.tran2@karofi.vn' },
        { name: 'ƒê·ªó Th√†nh C√¥ng', dept: 'KTSP', email: 'congdt@karofi.vn' },
        { name: 'Nguy·ªÖn Kim C∆∞∆°ng', dept: 'NCTN', email: 'cuong.nguyen6@karofi.com' },
        { name: 'Nguy·ªÖn Chung Nam', dept: 'Mua h√†ng', email: 'nam.nguyen5@karofi.vn' },
        { name: 'Nguy·ªÖn Ng·ªçc Quang', dept: 'TKCK', email: 'quang.nguyen1@karofi.vn' },
        { name: 'Ho√†ng Th√πy Linh', dept: 'NCTN', email: 'linh.hoang1@karofi.vn' },
        { name: 'ƒêo√†n VƒÉn Minh', dept: 'TKCK', email: 'minh.doan@karofi.vn' },
        { name: 'Tr·∫ßn VƒÉn C∆∞·ªùng', dept: 'QA/QC nh√† m√°y', email: 'cuong.tran1@karofi.vn' },
        { name: 'ƒê·ªó C√¥ng Nh·∫≠m', dept: 'TKCK', email: 'nham.do@karofi.vn' },
        { name: 'L√™ Minh H·∫£i', dept: 'KTSP', email: 'hai.le3@karofi.vn' },
        { name: 'ƒê·ªó Xu√¢n Th√°i', dept: 'KTSP', email: 'thai.doi@karofi.vn' },
        { name: 'Tr·ªãnh K·∫ø L·ª±c', dept: 'KTSX', email: 'luc.trinh@karofi.vn' },
        { name: 'ƒê·∫∑ng VƒÉn Thu·∫•n', dept: 'KTCN', email: 'thuan.dang@karofi.vn' },
        { name: 'L√™ Th·∫ø Anh', dept: 'KTSP', email: 'anh.le@karofi.vn' },
        { name: 'D∆∞∆°ng Qu·ªëc Hi·∫øu', dept: 'TKCK', email: 'hieudq1@karofi.vn' },
        { name: 'Ph√πng Ch√≠ Ti·∫øn', dept: 'KTSP', email: 'tien.phung@karofi.vn' },
        { name: 'Nguy·ªÖn Th·ªã H∆∞∆°ng Th√∫y', dept: 'Mua h√†ng', email: 'thuy.nguyen@karofi.vn' },
        { name: 'ƒê√†o Ho√†ng D∆∞∆°ng', dept: 'DQA', email: 'duong.dao@karofi.vn' },
      ];

      function normalize(s){
        return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
      }

      function renderOptions(q){
        const n = normalize(q);
        // When empty query: do not show any suggestion
        if (!n) { list.innerHTML = ''; return; }
        const candidates = SENDER_DB
          .filter(x => normalize(x.name).includes(n))
          .sort((a,b)=> a.name.localeCompare(b.name))
          .slice(0, 30);
        list.innerHTML = candidates.map(c=>`<option value="${c.name}"></option>`).join('');
      }

      function tryAutofill(){
        const val = nameInput.value || '';
        const exact = SENDER_DB.find(x=>x.name === val);
        if (exact) {
          emailInput.value = exact.email;
          // set department select to matching option if possible
          const opts = Array.from(deptSelect.options);
          const match = opts.find(o=> (o.value||o.text||'').trim() === exact.dept);
          if (match) deptSelect.value = match.value || match.text;
        }
      }

      nameInput.addEventListener('input', ()=>{ renderOptions(nameInput.value); });
      nameInput.addEventListener('change', tryAutofill);
      nameInput.addEventListener('blur', tryAutofill);
      renderOptions('');
    })();

    // ===== Enhanced File Upload (Deferred) =====
    let testRequestUploads = [];
    let pendingFiles = [];
    (function setupDeferredFileUpload(){
      const fileInput = document.getElementById('testRequestFiles');
      const uploadArea = document.getElementById('fileUploadArea');
      const uploadList = document.getElementById('testRequestUploadList');
      const uploadProgress = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');
      const uploadPercent = document.getElementById('uploadPercent');

      const allowedTypes = {
        'application/pdf': 'PDF',
        'application/msword': 'DOC',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'DOCX',
        'application/vnd.ms-excel': 'XLS',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'XLSX',
        'image/jpeg': 'JPG',
        'image/jpg': 'JPG',
        'image/png': 'PNG'
      };
      const maxFileSize = 20 * 1024 * 1024;

      function getFileIcon(mimeType) {
        if (mimeType.startsWith('image/')) return 'üñºÔ∏è';
        if (mimeType.includes('pdf')) return 'üìÑ';
        if (mimeType.includes('word')) return 'üìù';
        if (mimeType.includes('excel') || mimeType.includes('sheet')) return 'üìä';
        return 'üìé';
      }
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }
      function validateFile(file) {
        const errors = [];
        const type = file.type || '';
        if (type ? !allowedTypes[type] : !( ['pdf','doc','docx','xls','xlsx','jpg','jpeg','png'].includes((file.name.split('.').pop()||'').toLowerCase()) )) {
          errors.push('Lo·∫°i file kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£');
        }
        if (file.size > maxFileSize) errors.push('File qu√° l·ªõn (t·ªëi ƒëa 20MB)');
        return errors;
      }
      function showProgress(percent) {
        uploadProgress.classList.remove('hidden');
        progressBar.style.width = percent + '%';
        uploadPercent.textContent = percent + '%';
        if (percent >= 100) setTimeout(()=>uploadProgress.classList.add('hidden'), 800);
      }

      function createItem(file, idx) {
        const isImage = file.type.startsWith('image/');
        const typeLabel = allowedTypes[file.type] || 'FILE';
        const row = document.createElement('div');
        row.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow file-item';
        row.id = `file-row-${idx}`;
        row.innerHTML = `
          <div class="flex items-start space-x-4">
            ${isImage ?
              `<div class="flex-shrink-0 file-preview">
                <img id="preview-${idx}" class="w-16 h-16 object-cover rounded-lg border" src="#" alt="Preview">
              </div>` :
              `<div class="flex-shrink-0 w-16 h-16 bg-blue-100 rounded-lg flex items-center justify-center">
                <span class="text-2xl">${getFileIcon(file.type)}</span>
              </div>`}
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <input id="rename-${idx}" class="text-sm font-medium text-gray-900 truncate border border-blue-200 rounded px-2 py-1 w-full max-w-xs"
                       value="${file.name}" />
                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${typeLabel}</span>
              </div>
              <p class="text-sm text-gray-500 mt-1">${formatFileSize(file.size)}</p>
            </div>
            <button type="button" id="remove-${idx}" class="flex-shrink-0 p-1 rounded-full text-gray-400 hover:text-red-600 hover:bg-red-50">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
          </div>`;
        uploadList.appendChild(row);

        if (isImage) {
          const r = new FileReader();
          r.onload = e => { const img = document.getElementById(`preview-${idx}`); if (img) img.src = e.target.result; };
          r.readAsDataURL(file);
        }
        row.querySelector(`#rename-${idx}`).addEventListener('input', e=>{
          const pf = pendingFiles[idx]; if (pf) pf.name = e.target.value;
        });
        row.querySelector(`#remove-${idx}`).onclick = ()=>{
          const pf = pendingFiles[idx];
          if (pf) pendingFiles[idx] = null;
          row.remove();
        };
      }

      function addFiles(files) {
        const errs = [];
        Array.from(files).forEach(file=>{
          const e = validateFile(file);
          if (e.length) { errs.push(`${file.name}: ${e.join(', ')}`); return; }
          const idx = pendingFiles.length;
          pendingFiles.push({ file, name: file.name });
          createItem(file, idx);
        });
        if (errs.length) alert('M·ªôt s·ªë file kh√¥ng h·ª£p l·ªá:\n\n' + errs.join('\n'));
      }

      ['dragenter','dragover','dragleave','drop'].forEach(ev=>{
        uploadArea.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); }, false);
      });
      ['dragenter','dragover'].forEach(ev=>{
        uploadArea.addEventListener(ev, ()=>uploadArea.classList.add('border-blue-500','bg-blue-50'), false);
      });
      ['dragleave','drop'].forEach(ev=>{
        uploadArea.addEventListener(ev, ()=>uploadArea.classList.remove('border-blue-500','bg-blue-50'), false);
      });
      uploadArea.addEventListener('drop', e=>addFiles(e.dataTransfer.files), false);
      fileInput.addEventListener('change', function(){ if (this.files?.length) addFiles(this.files); this.value=''; });
      uploadArea.addEventListener('click', e=>{ if (e.target!==fileInput) fileInput.click(); });

      window.__getPendingFiles = () => pendingFiles.filter(Boolean);
      window.__clearPendingFiles = () => { pendingFiles = []; };
      window.__showUploadProgress = showProgress;
    })();

    // Form submit logic (for main forms)
    const LOCAL_TASKS_KEY = 'DQA_TASKS_V1';
    function __loadTasks(){ try { return JSON.parse(localStorage.getItem(LOCAL_TASKS_KEY) || '[]'); } catch { return []; } }
    function __saveTask(task){ const cur = __loadTasks(); cur.push(task); localStorage.setItem(LOCAL_TASKS_KEY, JSON.stringify(cur)); }

    async function uploadPendingFiles(progressCb){
      const list = (window.__getPendingFiles ? window.__getPendingFiles() : []);
      const total = Math.max(list.length, 1);
      const results = [];
      let done = 0;

      for (const item of list) {
        const base64 = await new Promise((resolve,reject)=>{
          const r = new FileReader();
          r.onload = e=>resolve(e.target.result.split(',')[1]);
          r.onerror = ()=>reject(new Error('Kh√¥ng th·ªÉ ƒë·ªçc file'));
          r.readAsDataURL(item.file);
        });
        const payload = { data: [{ filename: (item.name || item.file.name), mimetype: item.file.type, filedata: base64 }] };
        const resp = await fetch(FILE_UPLOAD_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) throw new Error(await resp.text());
        let result = {};
        const ct = resp.headers.get('content-type') || '';
        if (ct.includes('application/json')) result = await resp.json();
        else { try { result = JSON.parse(await resp.text()); } catch { result = {}; } }
        const url = result.url || result.fileUrl || result.public_url || (result.data && result.data[0] && (result.data[0].url || result.data[0].link)) || '#';
        results.push({ name: (item.name || item.file.name), url, type: item.file.type, size: item.file.size });

        done++;
        const percent = Math.round((done/total)*100);
        if (progressCb) progressCb(percent);
        if (window.__showUploadProgress) window.__showUploadProgress(percent);
      }
      return results;
    }

    function toJSON(form){
      const d = {};
      new FormData(form).forEach((val,key)=>{
        if(d[key]) d[key] = [].concat(d[key],val); else d[key]=val;
      });
      return d;
    }

    function submitForm(formId, endpoint, getUploads){
      document.getElementById(formId).onsubmit = async function(e){
        e.preventDefault();
        if (formId === 'testRequestForm') {
          const confirmed = window.confirm('B·∫±ng vi·ªác x√°c nh·∫≠n g·ª≠i y√™u c·∫ßu, b·∫°n cam k·∫øt m·∫´u ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë√∫ng v√† ƒë·ªß ƒë·∫øn DQA.');
          if (!confirmed) return;
        }
        const btn = this.querySelector("button[type=submit]");
        const originalLabel = btn ? btn.innerHTML : "";
        if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner'></span><span style='margin-left:8px'>ƒêang g·ª≠i...</span>"; }

        const data = (function toJSON(form){
          const d = {}; new FormData(form).forEach((val,key)=>{ d[key] = d[key] ? [].concat(d[key],val) : val; }); return d;
        })(this);
        const isSpecial = data.testType === 'special';
        const submissionRound = parseInt(data.sampleSubmissionNo || '0', 10) || 0;
        const normalizedRequestDate = (data.requestDate || '').toString().slice(0,10);
        const normalizedDesiredDate = (data.desiredCompletionDate || '').toString().slice(0,10);
        const componentStd = (function(){
          let s = Number(data.componentStandard || 0);
          if (!s) {
            try { s = (window.__resolveComponentStandard ? window.__resolveComponentStandard(data.componentType) : 0) || 0; }
            catch(_) { s = 0; }
          }
          return s;
        })();

        const mapped = {
          requesterName: String(data.senderName || '').trim(),
          email: String(data.senderEmail || '').trim(),
          requestDate: String(normalizedRequestDate || '').trim(),
          requestCode: String(document.getElementById('requestCode')?.value || '').trim(),
          deptRequest: String(data.department || '').trim(),
          itemName: String(data.productName || '').trim(),
          itemCode: String(data.productCode || '').trim(),
          componentType: String(data.componentType || '').trim(),
          componentStandard: String(componentStd),
          purpose: String(data.requestPurpose || '').trim(),
          vendor: String(data.supplier || '').trim(),
          qtySamples: String(data.numSamples || '').trim(),
          desiredDate: String(normalizedDesiredDate || '').trim(),
          changeReq: String(data.notes || '').trim(),
          changeFromLastNote: String(data.changeFromLastNote || '').trim(),
          kiemtraDefault: isSpecial ? '0' : '1',
          kiemtraDacBiet: isSpecial ? '1' : '0',
          SpecialReq: String(isSpecial ? (document.getElementById('specialRequestDesc')?.value || '') : '').trim(),
          Receiver: String(data.personReceived || '').trim(),
          sampleSubmissionNo: String(submissionRound),
          isResubmission: String(submissionRound),
          altCode: String(data.altCode || '').trim(),
          appliedModel: String(data.appliedModel || '').trim(),
          Score: String(componentStd), Odoojira: '', Assignee: ''
        };

        const pending = window.__getPendingFiles ? window.__getPendingFiles() : [];
        const attachmentNames = pending.map(p=>p?.name || p?.file?.name).filter(Boolean);

        const localTask = {
          requesterName: mapped.requesterName,
          submissionDate: mapped.requestDate,
          desiredDueDate: mapped.desiredDate,
          responseDueDate: '',
          taskName: `Y√™u c·∫ßu th·ª≠ nghi·ªám - ${mapped.itemName}`,
          pic: mapped.Receiver,
          status: 'ƒê√£ g·ª≠i',
          reportCode: mapped.requestCode,
          email: mapped.email,
          department: mapped.deptRequest
        };

        const fd = new FormData();
        Object.entries(mapped).forEach(([k,v])=>fd.append(k, v));
        fd.append('attachments', attachmentNames.join(';'));
        // add component standard explicitly for form-data receivers expecting separate field
        fd.append('componentStandard', String(componentStd));
        for (const item of pending) {
          if (!item) continue;
          const name = item.name || item.file.name;
          fd.append('files[]', item.file, name);
        }

        try{
          let resp = await fetch(endpoint, { method: 'POST', body: fd });
          if (!resp.ok) {
            const uploaded = await uploadPendingFiles();
            const mappedFallback = {
              ...mapped,
              attachments: uploaded.map(u=>u.name || '').join(';'),
              attachmentUrls: uploaded.map(u=>u.url || '').join(';')
            };
            resp = await fetch(endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json", "Accept": "application/json" },
              body: JSON.stringify({ data: [mappedFallback] })
            });
            if (!resp.ok) throw new Error(await resp.text());
          }

          // Th√†nh c√¥ng
          try { __saveTask(localTask); } catch {}
          if (btn) {
            btn.innerHTML="ƒê√£ g·ª≠i!";
            setTimeout(()=>{btn.innerHTML=originalLabel;btn.disabled=false;},20000);
          }

          if(!document.getElementById('keepDataAfterSubmit')?.checked){
            this.reset();
            setCurrentDateTime('testRequestDate');
            setRequestCode();
            try {
              const list = document.getElementById('testRequestUploadList');
              if (list) list.innerHTML = '';
              if (window.__clearPendingFiles) window.__clearPendingFiles();
              if (Array.isArray(testRequestUploads)) testRequestUploads = [];
            } catch(_) {}
          }
        }catch(err){
          try { __saveTask(localTask); } catch {}
          alert("G·ª≠i th·∫•t b·∫°i: "+err);
          if (btn) { btn.innerHTML=originalLabel; btn.disabled=false; }
        }
      };
    }
    submitForm("testRequestForm", FORM_SUBMIT_ENDPOINT, ()=>testRequestUploads);
    function setRequestCode(){
      const el = document.getElementById('requestCode');
      if (!el) return;
      const now = new Date();
      const dd = String(now.getDate()).padStart(2,'0');
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let rnd = '';
      for (let i=0;i<6;i++) rnd += alphabet[Math.floor(Math.random()*alphabet.length)];
      el.value = `QA.Y.${dd}${mm}-${rnd}`;
    }
    setRequestCode();
    // internal forms moved to DQA_internal.html

    // Task tracking table: fetch data from endpoint and render
    (function(){
      const TASK_TRACKING_ENDPOINT = "https://iatzhxxuk.tino.page/webhook/4794bc52-4d4c-4326-b2cb-1b8388f20fb1";

      function getCaseInsensitive(obj, keys) {
        if (!obj) return "";
        const lower = Object.keys(obj).reduce((acc,k)=>{acc[k.toLowerCase()] = obj[k];return acc;},{});
        for (const key of keys) {
          if (lower[key.toLowerCase()] !== undefined) return lower[key.toLowerCase()];
        }
        return "";
      }

      function renderStatusBadge(status) {
        const s = (status || "").toString().toLowerCase();
        if (s.includes("done") || s.includes("ho√†n")) return '<span class="rounded px-2 py-1 bg-green-100 text-green-800">Ho√†n th√†nh</span>';
        if (s.includes("progress") || s.includes("ƒëang")) return '<span class="rounded px-2 py-1 bg-yellow-100 text-yellow-800">ƒêang th·ª±c hi·ªán</span>';
        if (s.includes("pending") || s.includes("ch·ªù")) return '<span class="rounded px-2 py-1 bg-gray-100 text-gray-800">Ch·ªù x·ª≠ l√Ω</span>';
        return `<span class="rounded px-2 py-1 bg-gray-100 text-gray-800">${status || "-"}</span>`;
      }

      function toDDMMYYYY(value){
        if(!value) return '';
        // Accept formats like ISO, YYYY-MM-DD, or already DD/MM/YYYY
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(value)) return value;
        const d = new Date(value);
        if (isNaN(d.getTime())) return value; // fallback to original if invalid
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }

      document.getElementById('taskTrackingForm').onsubmit = async function(e){
      e.preventDefault();
        
        // Validation: At least one of email or department must be filled
        const email = this.querySelector('input[name="senderEmail"]').value.trim();
        const department = this.querySelector('select[name="department"]').value.trim();
        
        if (!email && !department) {
          alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt trong hai tr∆∞·ªùng: Email ho·∫∑c Ph√≤ng ban');
          return;
        }
        
        const btn = document.getElementById('taskTrackingSearchBtn') || this.querySelector("button[type=submit]");
        const originalSearchLabel = btn ? btn.textContent : "T√¨m ki·∫øm";
        if (btn) {
          btn.disabled = true;
          btn.innerHTML = "<span class='spinner'></span><span class='ml-2'>ƒêang t√¨m...</span>";
        }
        const bodyEl = document.getElementById('trackingTableBody');
        bodyEl.innerHTML = "<tr><td colspan='7' class='px-4 py-4 text-center text-gray-500'><span class='spinner mr-2'></span>ƒêang t·∫£i...</td></tr>";

        // Build filter from form
        const formData = new FormData(this);
        const filter = {};
        formData.forEach((v,k)=>{ filter[k] = v; });
        // Build response field mapping from form (allow backend to choose keys; also used client-side)
          const map = {
          submissionDate: filter.resp_ngay_gui || 'submissionDate',
          taskName: filter.resp_ten_cong_viec || 'taskName',
          desiredDueDate: filter.resp_han_mong_muon || 'desiredDueDate',
          completionDate: filter.resp_ngay_hoan_thanh || 'completionDate',
          pic: filter.resp_phu_trach || 'pic',
          status: filter.resp_trang_thai || 'status',
          assigner: filter.resp_nguoi_giao_viec || 'assigner',
            reportCode: filter.resp_ma_bao_cao || 'reportCode',
        };

        try {
          // Use GET with query params per webhook requirement
          const params = new URLSearchParams();
          
          // Add form fields to query params (excluding response mapping fields)
          Object.keys(filter).forEach(k=>{
            if (filter[k] !== undefined && filter[k] !== null) {
              if (!k.startsWith('resp_')) {
                // Map form field names to backend field names
                const fieldMapping = {
                  'senderEmail': 'requester_email',
                  'department': 'requester_department'
                };
                const paramName = fieldMapping[k] || k;
                params.append(paramName, filter[k]);
              }
            }
          });
          
          // send response mapping using safe param names
          const mappingParamMap = {
            resp_ngay_gui: 'field_submission_date',
            resp_ten_cong_viec: 'field_task_name',
            resp_han_mong_muon: 'field_desired_due_date',
            resp_ngay_hoan_thanh: 'field_completion_date',
            resp_phu_trach: 'field_pic',
            resp_trang_thai: 'field_status',
            resp_nguoi_giao_viec: 'field_assigner',
            resp_ma_bao_cao: 'field_report_code'
          };
          Object.keys(mappingParamMap).forEach(src=>{
            if (filter[src]) params.append(mappingParamMap[src], filter[src]);
          });
          params.append('_ts', Date.now().toString());
          let url = `${TASK_TRACKING_ENDPOINT}?${params.toString()}`;

          let resp = await fetch(url, { method: 'GET' });

          if (!resp.ok) {
            const errText = await resp.text();
            throw new Error(errText);
          }
          let json = null;
          let ct = resp.headers.get('content-type') || '';
          if (ct.includes('application/json')) json = await resp.json();
          else {
            try { json = JSON.parse(await resp.text()); } catch { json = {}; }
          }

          const rows = Array.isArray(json) ? json
                     : Array.isArray(json?.data) ? json.data
                     : Array.isArray(json?.rows) ? json.rows
                     : [];

          if (!rows.length) {
            bodyEl.innerHTML = "<tr><td colspan='7' class='px-4 py-6 text-center text-gray-500'>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>";
          } else {
            // Sort rows: empty status first, then doing/progress/ƒëang, then others
            function statusWeight(raw){
              const s = (raw || "").toString().toLowerCase().trim();
              if (!s) return 0; // empty first
              if (s.includes('doing') || s.includes('progress') || s.includes('ƒëang')) return 1; // doing second
              return 2; // others last
            }
            function getRawStatus(rec){
              return getCaseInsensitive(rec, [map.status,'status','trangThai']);
            }
            const rowsSorted = rows.slice().sort((a,b)=>{
              const wa = statusWeight(getRawStatus(a));
              const wb = statusWeight(getRawStatus(b));
              if (wa !== wb) return wa - wb;
              return 0;
            });
            const html = rowsSorted.map(r=>{
              const assigner = getCaseInsensitive(r, [map.assigner,'assigner','nguoiGiaoViec','assignedTo']) || '-';
              const submissionDate = toDDMMYYYY(getCaseInsensitive(r, [map.submissionDate,'ngayGui','createdAt','created_at'])) || '-';
              const taskName = getCaseInsensitive(r, [map.taskName,'tenCongViec','name','title']) || '-';
              const desiredDue = toDDMMYYYY(getCaseInsensitive(r, [map.desiredDueDate,'hanMongMuon','dueDate','due_date'])) || '-';
              const doneDate = toDDMMYYYY(getCaseInsensitive(r, [map.completionDate,'ngayHoanThanh','completedAt','completed_at'])) || '-';
              const reportCode = getCaseInsensitive(r, [map.reportCode,'reportCode','maBaoCao','report_code']) || '-';
              const pic = getCaseInsensitive(r, [map.pic,'phuTrach','owner','assignee']) || '-';
              const status = getCaseInsensitive(r, [map.status,'trangThai']) || '';
              return `
                <tr>
                  <td class="px-4 py-2">${assigner}</td>
                  <td class="px-4 py-2">${submissionDate}</td>
                  <td class="px-4 py-2">${desiredDue}</td>
                  <td class="px-4 py-2">${doneDate}</td>
                  <td class="px-4 py-2">${taskName}</td>
                  <td class="px-4 py-2">${pic}</td>
                  <td class="px-4 py-2">${renderStatusBadge(status)}</td>
                  <td class="px-4 py-2">${reportCode}</td>
                </tr>`;
            }).join('');
            bodyEl.innerHTML = html;
          }
        } catch (err) {
          bodyEl.innerHTML = `<tr><td colspan='7' class='px-4 py-6 text-center text-red-600'>L·ªói khi t·∫£i d·ªØ li·ªáu: ${String(err.message || err)}</td></tr>`;
        } finally {
          if (btn) { btn.disabled = false; btn.textContent = originalSearchLabel || 'T√¨m ki·∫øm'; }
        }
      };
    })();

  </script>
</body>
</html>





